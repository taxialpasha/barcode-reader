<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محفظة المستثمر | سما بابل للاستثمار</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Tajawal for Arabic UI -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        /* ===== COLORS & THEME ===== */
        :root {
            --bg-dark: #0d1117;
            --bg-card: #111827;
            --gold: #FFC436;
            --gold-light: rgba(255, 196, 54, 0.1);
            --gold-medium: rgba(255, 196, 54, 0.3);
            --gold-bright: rgba(255, 196, 54, 0.8);
            --text-white: #ffffff;
            --text-light: rgba(255, 255, 255, 0.7);
            --text-dark: #000000;
            --red: #ff5252;
            --green: #4CAF50;
            --blue: #2196F3;
            --border-radius-sm: 10px;
            --border-radius-md: 16px;
            --border-radius-lg: 20px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

     /* تعديل خلفية الجسم بالكامل */
body {
    background-color: var(--bg-dark); /* لون احتياطي في حال لم تظهر الصورة */
    background-image: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445');
    background-size: cover;
    background-position: center center;
    background-attachment: fixed; /* جعل الخلفية ثابتة عند التمرير */
    background-repeat: no-repeat;
    color: var(--gold);
    line-height: 1.5;
}
      /* إضافة طبقة شفافة فوق الخلفية للتباين وتحسين مقروئية العناصر */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
    background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
    backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
    height: 100vh; /* Full screen height */
    display: flex;
    flex-direction: column; /* Stack elements vertically */
}

/* تحديث شامل لتثبيت شريط الأدوات والعناوين */

/* إعادة ضبط حاوية التطبيق للتعامل مع التمرير بشكل أفضل */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: fixed; /* تثبيت الحاوية الرئيسية */
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    overflow: hidden; /* منع التمرير على مستوى الحاوية */
    background-color: rgba(13, 17, 23, 0.85);
    backdrop-filter: blur(5px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
}

/* إعادة تصميم الشريط العلوي للتثبيت الكامل */
.header {
    position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    height: 60px; /* تحديد ارتفاع ثابت */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* إعادة تصميم شريط الأدوات السفلي للتثبيت الكامل */
.bottom-nav {
    position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    height: 60px; /* تحديد ارتفاع ثابت */
}

/* إعادة تصميم منطقة المحتوى الرئيسية للتمرير بشكل صحيح */
.dashboard {
    flex: 1; /* يأخذ المساحة المتبقية */
    position: relative;
    overflow: hidden;
    margin-top: 60px; /* مساحة للشريط العلوي */
    margin-bottom: 60px; /* مساحة للشريط السفلي */
    height: calc(100% - 120px); /* الارتفاع الكلي ناقص ارتفاع الشريطين */
}

/* تعديل هيكل الأقسام المختلفة للتمرير المناسب */
#homeSection, 
#profileSection, 
#transactionsSection, 
#notificationsSection {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto; /* تفعيل التمرير العمودي */
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* تمرير سلس على الأجهزة التي تعمل باللمس */
    padding: 15px 0 30px; /* تباعد أعلى وأسفل المحتوى */
    display: none; /* سيتم تفعيله عبر JavaScript */
    height: 100%; /* ارتفاع كامل */
}

/* إظهار القسم النشط */
#homeSection.active, 
#profileSection.active, 
#transactionsSection.active, 
#notificationsSection.active {
    display: block;
}

/* معالجة المودالات لضمان تموضعها بشكل صحيح */
.modal {
    z-index: 2000;
}

/* معالجة شاشة التحميل */
.loading {
    z-index: 3000;
}

/* معالجة تمرير جسم الصفحة */
body {
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    margin: 0;
    padding: 0;
}

/* تأكيد تموضع زر التحديث بشكل صحيح */
.refresh-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1001;
}

/* تعديلات للشاشات الصغيرة */
@media (max-height: 600px) {
    .header {
        padding: 10px 0;
        height: 50px;
    }
    
    .bottom-nav {
        padding: 8px 0 5px;
        height: 50px;
    }
    
    .dashboard {
        margin-top: 50px;
        margin-bottom: 50px;
        height: calc(100% - 100px);
    }
}

/* تعديل أنماط العناصر المتنقلة في الشريط السفلي */
.nav-item {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* إصلاح مشكلة شاشة تسجيل الدخول */
.login-screen {
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1500;
}

/* تعديلات خاصة بمنطقة البطاقة والمعلومات */
.credit-card, .info-cards, .actions, .transactions {
    padding-left: 15px;
    padding-right: 15px;
}

/* منع وجود فراغات زائدة في أسفل المحتوى */
.transactions {
    margin-bottom: 0;
    padding-bottom: 20px;
}

/* تبسيط تباعد العناصر */
.section-title {
    margin-top: 15px;
}

/* تعديل لحل مشكلة التمرير في نهاية الصفحة */
#transactionsList, #filteredTransactionsList, #notificationsList {
    padding-bottom: 30px; /* ضمان وجود مساحة كافية في نهاية القوائم */
}

/* تعديل خلفيات العناصر الفرعية لتكون شبه شفافة */
.header, 
.bottom-nav, 
.login-screen,
.dashboard,
.profile-section,
.transactions-section,
.notifications-section {
    background-color: transparent; /* إزالة الخلفية ليظهر التأثير */
}




/* جعل بعض العناصر مثل البطاقات والنوافذ المنبثقة أكثر وضوحًا */
.credit-card,
.info-card,
.transaction-item,
.notification-item,
.modal-content,
.account-details,
.form-control {
    background-color: rgba(17, 24, 39, 0.8); /* خلفية داكنة شبه شفافة */
    backdrop-filter: blur(8px); /* تأثير ضبابي أقوى */
    border: 1px solid rgba(255, 196, 54, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}


/* تعديل زر التحديث والأزرار الإضافية لتكون أكثر وضوحًا */
.refresh-btn,
.nav-item {
    background-color: rgba(17, 24, 39, 0.7);
    backdrop-filter: blur(5px);
}



    /* تحديث نمط البطاقة لإضافة صورة الخلفية */
.credit-card {
    width: 100%;
    aspect-ratio: 1.6/1;
    background: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445') no-repeat center center;
    background-size: cover;
    border-radius: var(--border-radius-lg);
    padding: 24px;
    position: relative;
    overflow: hidden;
    margin: 0 auto 25px;
    border: 1px solid rgba(255, 196, 54, 0.3);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* تعديل طبقة التراكب لتناسب لون الخلفية الجديدة */
.credit-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%);
    z-index: 1;
    pointer-events: none;
}

/* تحسين لون النصوص لتكون مقروءة على الخلفية الجديدة */
.card-number,
.card-company,
.card-info-label,
.card-info-value,
.card-logo,
.card-provider {
    color: var(--gold);
    text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.7);
    position: relative;
    z-index: 2;
}

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .card-chip {
            width: 45px;
            height: 35px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 8px;
            margin-right: auto;
        }

        .card-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-provider {
            width: 60px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--gold);
            font-size: 0.9rem;
        }

        .card-number {
            font-size: 1.8rem;
            color: var(--gold);
            letter-spacing: 2px;
            text-align: center;
            margin: 10px 0 20px;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }

        .card-holder-name {
            font-size: 1.1rem;
            color: var(--gold);
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .card-company {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 2;
        }

        .card-info-item {
            position: relative;
            z-index: 2;
        }

        .card-info-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .card-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
        }

        /* ===== INFO CARDS ===== */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .info-card h3 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .info-card p {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: var(--gold);
        }

        /* ===== ACTION BUTTONS ===== */
        .actions {
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            color: var(--gold);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .action-btn:hover {
            background: var(--gold-light);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .action-btn i {
            font-size: 1.3rem;
        }

        /* ===== TRANSACTIONS ===== */
        .transactions {
            padding: 5px 15px 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-white);
            font-size: 0.95rem;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .transaction-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-right: 5px;
        }

        .transaction-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-white);
            text-align: left;
            direction: ltr;
        }

        .transaction-amount.positive {
            color: var(--gold);
        }

        .transaction-amount.negative {
            color: var(--red);
        }

       /* تعديل رأس التطبيق */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    max-width: 430px;
    margin: 0 auto;
}



/* تعديل قائمة التنقل السفلية */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    max-width: 430px;
    margin: 0 auto;
}

/* تحسين التباين لتحسين مقروئية النصوص */
h1, h2, h3, .section-title, .profile-name, .card-number, .card-company {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

/* تعديل شاشة تسجيل الدخول لتكون متوافقة مع الخلفية الجديدة */
.login-screen {
    background-color: rgba(13, 17, 23, 0.85);
    backdrop-filter: blur(5px);
}

/* تعديل طبقة التحميل */
.loading {
    background-color: rgba(13, 17, 23, 0.9);
    backdrop-filter: blur(10px);
}

        .header h1 {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            color: var(--gold);
        }

        .header-user {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 3px;
        }

        .refresh-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--gold-light);
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 8px;
            max-width: 430px;
            margin: 0 auto;
        }

        .nav-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-light);
            width: 70px;
            position: relative; /* Added for notification badge positioning */
        }

        .nav-item.active {
            color: var(--gold);
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            padding: 40px 20px;
            text-align: center;
            background-color: var(--bg-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(255, 196, 54, 0.3);
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--bg-dark);
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 196, 54, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            color: var(--gold);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--text-white);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 196, 54, 0.3);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--gold);
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--bg-dark);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold);
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(255, 196, 54, 0.2);
        }

        /* ===== QR Scanner ===== */
        #qr-scanner {
            width: 100%;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            display: none;
        }

        .img-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #qr-file-selector {
            display: none;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            display: none;
            padding-bottom: 80px;
            background-color: var(--bg-dark);
        }

        /* ===== PROFILE SECTION ===== */
        .profile-section {
            padding: 20px 15px;
            display: none;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            background: var(--gold);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--bg-dark);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.2);
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .profile-card {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .account-details {
            background: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-top: 10px;
            border: 1px solid rgba(255, 196, 54, 0.2);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-white);
        }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--red);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: rgba(255, 82, 82, 0.2);
            border-color: var(--red);
        }

        /* ===== TRANSACTIONS SECTION ===== */
        .transactions-section {
            padding: 20px 15px;
            display: none;
        }

        .transaction-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none; /* Firefox */
        }

        .transaction-filter::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.2);
            border-radius: 30px;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
            font-weight: 600;
        }

        .transaction-date-header {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        /* ===== NOTIFICATIONS SECTION ===== */
        .notifications-section {
            padding: 20px 15px;
            display: none;
        }

        .notification-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .notification-item.unread {
            border-right: 3px solid var(--gold);
        }

        .notification-item.new-notification::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold) 0%, transparent 50%);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--gold);
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-white);
            margin-bottom: 5px;
        }

        .notification-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .notification-amount {
            font-weight: 700;
            color: var(--gold);
            margin-top: 5px;
        }

        .notification-status {
            font-size: 0.8rem;
            margin-top: 2px;
        }

        .notification-status.pending {
            color: var(--gold);
        }

        .notification-status.completed {
            color: var(--green);
        }

        .notification-status.rejected {
            color: var(--red);
        }

        /* Notification Badge */
        .notification-count {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 16px;
            height: 16px;
            background-color: var(--red);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .notification-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: var(--red);
            border-radius: 50%;
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            position: relative;
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 196, 54, 0.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--gold);
            font-size: 1rem;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MESSAGES ===== */
        .error-message {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            color: var(--red);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--green);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        /* Card display in withdraw form */
        .card-display {
            background-color: rgba(17, 24, 39, 0.8);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-number-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .form-help-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .alert-container {
            margin-bottom: 15px;
        }

        .form-notice {
            background-color: rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .form-notice i {
            color: var(--gold);
            font-size: 1.1rem;
        }

        /* Notification Toast */
        .notification-toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
            direction: rtl;
        }

        .notification-toast {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--bg-card);
            border: 1px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s, transform 0.3s;
        }

        .notification-toast.hiding {
            opacity: 0;
            transform: translateY(-20px);
        }

        .notification-toast.info {
            border-color: var(--blue);
        }

        .notification-toast.success {
            border-color: var(--green);
        }

        .notification-toast.warning {
            border-color: var(--gold);
        }

        .notification-toast.danger {
            border-color: var(--red);
        }

        .notification-toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-toast-title {
            font-weight: bold;
            color: var(--gold);
        }

        .notification-toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            color: var(--text-light);
            cursor: pointer;
        }

        .notification-toast-body {
            font-size: 0.9rem;
            color: var(--text-white);
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 360px) {
            .card-number {
                font-size: 1.5rem;
            }
            
            .info-card {
                padding: 12px 10px;
            }
            
            .info-card h3 {
                font-size: 0.8rem;
            }
            
            .info-card p {
                font-size: 1.1rem;
            }
            
            .transaction-item {
                padding: 10px 12px;
            }
            
            .transaction-icon {
                width: 36px;
                height: 36px;
                margin-left: 10px;
            }
            
            .transaction-type {
                font-size: 0.85rem;
            }
            
            .transaction-amount {
                font-size: 0.95rem;
            }
        }

        /* Adjust app container for fixed header and footer */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
    background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
    backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
    height: 100vh; /* Full screen height */
    display: flex;
    flex-direction: column; /* Stack elements vertically */
}

/* Fix the header at the top */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    max-width: 430px;
    margin: 0 auto;
}

/* Fix the bottom navigation at the bottom */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    max-width: 430px;
    margin: 0 auto;
}

/* Allow scrolling for the main content */
#homeSection,
#profileSection,
#transactionsSection,
#notificationsSection {
    padding-top: 65px; /* Space for the fixed header */
    padding-bottom: 70px; /* Space for the fixed footer */
    overflow-y: auto; /* Enable vertical scrolling */
    height: 100vh; /* Full screen height */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling for touch devices */
}

/* Prevent body scrolling */
body {
    overflow: hidden;
    height: 100vh;
    margin: 0;
    padding: 0;
}

/* Smooth transitions for header and footer */
.header, .bottom-nav {
    transition: transform 0.3s ease;
}

/* Optional: Hide header when scrolling down */
.header.hidden {
    transform: translateY(-100%);
}

/* Optional: Hide footer when scrolling up */
.bottom-nav.hidden {
    transform: translateY(100%);
}

/* Adjust refresh button position */
.refresh-btn {
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 101;
}

/* Adjust modal z-index */
.modal {
    z-index: 2000;
}

/* Adjust loading screen z-index */
.loading {
    z-index: 3000;
}

/* Responsive adjustments for smaller screens */
@media (max-height: 600px) {
    .header {
        padding: 10px 0;
    }
    .bottom-nav {
        padding: 8px 0 5px;
    }
    #homeSection,
    #profileSection,
    #transactionsSection,
    #notificationsSection {
        padding-top: 55px;
        padding-bottom: 60px;
    }
}
/* === تعديلات خاصة بالبطاقة لشاشات Infinix NOTE 11 Pro === */

/* تعديل عام للبطاقة */
.credit-card {
    width: 94%;
    aspect-ratio: 2.1/1; /* نسبة أطول وأقل ارتفاعاً لتناسب الشاشات الطويلة */
    margin: 0 auto 15px;
    padding: 14px; /* تقليل التباعد الداخلي */
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
}

/* تحسين هيكل البطاقة */
.card-header {
    margin-bottom: 3px; /* تقليل المسافة الرأسية */
}

/* تصغير شريحة البطاقة */
.card-chip {
    width: 30px;
    height: 24px;
    border-radius: 5px;
}

/* تعديل مزود البطاقة */
.card-provider {
    width: 50px;
    height: 28px;
    font-size: 0.7rem;
    font-weight: 700;
}

/* تصغير رقم البطاقة */
.card-number {
    font-size: 1.3rem;
    letter-spacing: 0.5px;
    margin: 6px 0 8px;
    font-weight: 700;
}

/* تصغير اسم الشركة */
.card-company {
    font-size: 1rem;
    margin-bottom: 8px;
    font-weight: 700;
}

/* تعديل معلومات البطاقة السفلية */
.card-info {
    display: flex;
    justify-content: space-between;
}

.card-info-label {
    font-size: 0.40rem;
    margin-bottom: 1px;
}

.card-info-value {
    font-size: 0.9rem;
    font-weight: 500;
}

/* === تعديلات على تخطيط الصفحة الرئيسية === */

/* تحسين تباعد القسم الرئيسي للصفحة */
#homeSection {
    padding-top: 100px;
    padding-bottom: 100px;
    overflow-y: auto;
}

/* التباعد بين البطاقة وبطاقات المعلومات */
#homeSection > div:first-child {
    padding: 12px 12px 0;
}

/* تعديل بطاقات المعلومات */
.info-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 0 10px;
    margin-bottom: 15px;
}

.info-card {
    padding: 10px;
    border-radius: 12px;
}

.info-card h3 {
    font-size: 0.75rem;
    margin-bottom: 6px;
}

.info-card p {
    font-size: 1rem;
    margin: 0;
}

/* تعديل أزرار الإجراءات */
.actions {
    padding: 0 12px;
    margin-bottom: 15px;
}

.action-btn {
    padding: 12px;
    font-size: 1rem;
    border-radius: 12px;
    margin-bottom: 10px;
    gap: 8px;
}

.action-btn i {
    font-size: 1.2rem;
}

/* تعديل قسم المعاملات */
.transactions {
    padding: 0 12px 15px;
}

.section-title {
    font-size: 1rem;
    margin-bottom: 10px;
    gap: 5px;
}

.transaction-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 10px;
}

.transaction-icon {
    width: 36px;
    height: 36px;
    margin-left: 10px;
}

.transaction-type {
    font-size: 0.85rem;
    margin-bottom: 1px;
}

.transaction-date {
    font-size: 0.7rem;
}

.transaction-amount {
    font-size: 0.9rem;
}

.transaction-time {
    font-size: 0.65rem;
}

/* === تعديل الأشرطة الثابتة === */
.header {
    height: 56px;
    padding: 10px 0;
}

.header-user {
    font-size: 0.8rem;
}

.bottom-nav {
    height: 56px;
    padding: 5px 0;
}

.nav-item {
    padding: 5px;
}

.nav-item i {
    font-size: 1.1rem;
}

.nav-item span {
    font-size: 0.65rem;
}

/* === تعديلات خاصة بشاشات Infinix NOTE 11 Pro (أطول من المعتاد) === */
@media screen and (min-width: 1080px) and (min-height: 2400px), 
       screen and (min-width: 1080px) and (max-width: 1080px) and (min-height: 2400px) {
    /* تعديلات خاصة للشاشات الطويلة جداً */
    #homeSection {
        padding-top: 65px;
        padding-bottom: 75px;
    }
    
    .credit-card {
        aspect-ratio: 2.2/1;
        padding: 12px;
    }
    
    .info-cards {
        gap: 12px;
        padding: 0 12px;
    }
    
    /* زيادة المسافة بين الأقسام للاستفادة من الشاشة الطويلة */
    .transactions {
        margin-top: 5px;
    }
}

/* === قواعد إضافية لمعالجة المشاكل الشائعة === */

/* تأكد من أن محتوى القوائم يمكن التمرير إليه بالكامل */
#transactionsList, 
#filteredTransactionsList,
#notificationsList {
    padding-bottom: 40px;
}

/* تعديل حجم ونسبة النوافذ المنبثقة */
.modal-content {
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    width: 92%;
    max-width: 380px;
}

/* تحسين حجم النصوص في النماذج */
.form-label {
    font-size: 0.8rem;
}

.form-control {
    padding: 12px;
    font-size: 0.9rem;
}

.btn {
    padding: 12px;
    font-size: 0.95rem;
}

/* تصحيح للمشكلة الشائعة في الشاشات الطويلة حيث تختفي العناصر السفلية */
.dashboard {
    height: calc(100vh - 112px); /* 56px للشريط العلوي + 56px للشريط السفلي */
    margin-top: 56px;
    margin-bottom: 56px;
}

/* تعديل أقسام التطبيق للعرض المناسب */
#homeSection, 
#profileSection, 
#transactionsSection, 
#notificationsSection {
    height: 100%;
    overflow-y: auto;
    padding-top: 0;
    padding-bottom: 20px;
}

/* معالجة الحالات القصوى في الشاشات الضيقة جداً */
@media (max-width: 320px) {
    .credit-card {
        aspect-ratio: 2.3/1;
        padding: 10px;
    }
    
    .card-number {
        font-size: 1.15rem;
        letter-spacing: 0;
    }
    
    .card-company {
        font-size: 0.9rem;
    }
    
    .info-cards {
        grid-template-columns: 1fr;
        gap: 8px;
    }
}

/* إصلاحات إضافية لضمان عرض جميع العناصر */

/* تعديل التخطيط العام للتطبيق */
.app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    overflow: hidden;
    background-color: rgba(13, 17, 23, 0.85);
}

/* ضبط حاوية المحتوى الرئيسية */
.dashboard {
    flex: 1;
    overflow: hidden;
    position: relative;
    margin-top: 56px; /* ارتفاع الشريط العلوي */
    margin-bottom: 56px; /* ارتفاع الشريط السفلي */
    height: calc(100% - 112px); /* 100% - (ارتفاع الشريط العلوي + ارتفاع الشريط السفلي) */
}

/* تعديل الأقسام */
#homeSection, 
#profileSection, 
#transactionsSection, 
#notificationsSection {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 10px 0 20px;
    display: none;
}

/* إظهار القسم النشط */
#homeSection.active, 
#profileSection.active, 
#transactionsSection.active, 
#notificationsSection.active {
    display: block;
}

/* معالجة الشريط العلوي */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: 430px;
    margin: 0 auto;
}

/* معالجة الشريط السفلي */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 56px;
    display: flex;
    justify-content: space-around;
    max-width: 430px;
    margin: 0 auto;
}

/* تخصيص لشاشة Infinix NOTE 11 Pro */
@media screen and (width: 1080px) and (height: 2460px) {
    /* تعديلات خاصة بالشاشة المحددة */
    .credit-card {
        aspect-ratio: 2.2/1;
        margin-bottom: 12px;
    }
    
    .info-cards {
        margin-bottom: 12px;
    }
    
    .action-btn {
        margin-bottom: 8px;
    }
    
    /* تأكد من عدم تجاوز حدود الشاشة */
    #transactionsList {
        max-height: calc(100vh - 350px);
    }
}

/* تصغير القائمة في الشاشات الصغيرة */
@media (max-height: 700px) {
    #transactionsList {
        max-height: 180px;
    }
}

/* معالجة ارتفاع العناصر في الشاشات المختلفة */
@media (min-height: 701px) and (max-height: 800px) {
    #transactionsList {
        max-height: 230px;
    }
}

@media (min-height: 801px) {
    #transactionsList {
        max-height: 300px;
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div class="loading" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">جاري التحميل...</div>
        </div>

        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="logo">
                <i class="fas fa-gem"></i>
            </div>
            
            <h2 style="margin-bottom: 30px; color: var(--gold); font-weight: 800;">سما بابل للاستثمار</h2>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('cardTab')">
                    <i class="fas fa-credit-card"></i> البطاقة
                </button>
                <button class="tab-btn" onclick="switchTab('qrTab')">
                    <i class="fas fa-qrcode"></i> QR Code
                </button>
            </div>

            <div id="errorMessage" class="error-message"></div>
            
            <div id="cardTab" class="tab-content active">
                <form id="loginForm" onsubmit="loginWithCard(event)">
                    <div class="form-group">
                        <label class="form-label">رقم البطاقة</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ الانتهاء</label>
                        <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رمز الأمان (CVV)</label>
                        <input type="password" class="form-control" id="cvv" placeholder="XXX" maxlength="3" required>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-sign-in-alt"></i> دخول
                    </button>
                </form>
            </div>
            
            <div id="qrTab" class="tab-content">
                <div id="qr-scanner"></div>
                <button id="startScanBtn" class="btn" onclick="startQRScan()">
                    <i class="fas fa-camera"></i> مسح رمز QR
                </button>
                
                <label for="qr-file-selector" class="btn btn-secondary img-upload-btn" style="margin-top: 15px;">
                    <i class="fas fa-upload"></i> تحميل صورة الباركود
                </label>
                <input type="file" id="qr-file-selector" accept="image/*" onchange="decodeQRFromImage(this.files[0])">
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="dashboard" id="dashboardScreen">
            <!-- Header -->
            <div class="header">
                <div>
                    <div class="header-user" id="headerUsername">مرحباً، المستثمر</div>
                </div>
                <button class="refresh-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <!-- Home Section (Dashboard) -->
            <div id="homeSection">
                <!-- Card Display -->
               <div style="padding: 10px 10px 0;">
    <div class="credit-card">
        <div class="card-header">
            <div class="card-chip"></div>
            <div class="card-provider">INVESTOR</div>
        </div>
        <div class="card-number" id="displayCardNumber">2750 2380 1584 5063</div>
        <div class="card-company" id="cardCompanyName">سما بابل للاستثمار</div>
        <div class="card-info">
            <div class="card-info-item">
                <div class="card-info-label">الأرباح المستحقة</div>
                <div class="card-info-value" id="cardDueProfit">1,458.333 د.ع</div>
            </div>
            <div class="card-info-item">
                <div class="card-info-label">تاريخ الاستحقاق</div>
                <div class="card-info-value" id="displayExpiryDate">05/27</div>
            </div>
        </div>
    </div>
</div>

                <!-- Info Cards -->
                <div class="info-cards">
                    <div class="info-card">
                        <h3>إجمالي المدفوع</h3>
                        <p id="totalInvestment">4,000.00 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>الأرباح المستحقة</h3>
                        <p id="dueProfit">51,036.03 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>تاريخ الاستحقاق</h3>
                        <p id="maturityDate">05/27</p>
                    </div>
                    <div class="info-card">
                        <h3>حالة الاستثمار</h3>
                        <p id="investmentStatus">نشط</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button class="action-btn" onclick="openWithdrawModal()">
                        <i class="fas fa-money-check-alt"></i> طلب سحب
                    </button>
                    <button class="action-btn" onclick="showDetails()">
                        <i class="fas fa-file-alt"></i> تفاصيل الحساب
                    </button>
                </div>

                <!-- Recent Transactions -->
                <div class="transactions">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i> آخر المعاملات
                    </h2>
                    <div id="transactionsList">
                        <!-- Transactions will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div class="profile-section" id="profileSection">
                <h2 class="section-title">
                    <i class="fas fa-user"></i> الملف الشخصي
                </h2>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">خالد السعدي</div>
                    <div class="profile-card" id="profileCardNumber">2750 2380 1584 5063</div>
                </div>
                
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">الاسم الكامل</div>
                        <div class="detail-value" id="profileFullName">خالد السعدي</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف</div>
                        <div class="detail-value" id="profilePhone">07701234567</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">البريد الإلكتروني</div>
                        <div class="detail-value" id="profileEmail">khalid@example.com</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانضمام</div>
                        <div class="detail-value" id="profileJoinDate">10/01/2024</div>
                    </div>
                </div>
                
                <button class="btn" style="margin-top: 20px;" onclick="showContactSupport()">
                    <i class="fas fa-headset"></i> اتصل بالدعم
                </button>
                
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
            
            <!-- Transactions Section -->
            <div class="transactions-section" id="transactionsSection">
                <h2 class="section-title">
                    <i class="fas fa-exchange-alt"></i> سجل المعاملات
                </h2>
                
                <div class="transaction-filter">
                    <div class="filter-btn active" onclick="filterTransactions('all')">الكل</div>
                    <div class="filter-btn" onclick="filterTransactions('investment')">الاستثمارات</div>
                    <div class="filter-btn" onclick="filterTransactions('profit')">الأرباح</div>
                    <div class="filter-btn" onclick="filterTransactions('withdrawal')">السحوبات</div>
                </div>
                
                <div id="filteredTransactionsList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="notifications-section" id="notificationsSection">
                <h2 class="section-title">
                    <i class="fas fa-bell"></i> التنبيهات والإشعارات
                </h2>
                
                <div id="notificationsList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="switchSection('home')">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </div>
            <div class="nav-item" onclick="switchSection('transactions')">
                <i class="fas fa-exchange-alt"></i>
                <span>المعاملات</span>
            </div>
            <div class="nav-item" onclick="switchSection('notifications')">
                <i class="fas fa-bell"></i>
                <span>التنبيهات</span>
            </div>
            <div class="nav-item" onclick="switchSection('profile')">
                <i class="fas fa-user"></i>
                <span>الشخصي</span>
            </div>
        </div>

        <!-- Withdraw Modal -->
        <div class="modal" id="withdrawModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">طلب سحب الأرباح</h2>
                    <button class="modal-close" onclick="closeWithdrawModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="withdrawForm" onsubmit="submitWithdrawRequest(event)">
                    <div class="form-group">
                        <label class="form-label">البطاقة</label>
                        <div class="card-display">
                            <span id="withdrawCardNumber" class="card-number-display">2750 2380 1584 5063</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الرصيد المتاح للسحب</label>
                        <input type="text" class="form-control" id="availableBalance" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المبلغ المطلوب سحبه</label>
                        <input type="number" class="form-control" id="withdrawAmount" min="50" required>
                        <div class="form-help-text">
                            <span id="withdrawMinAmount">الحد الأدنى: 50 د.ع</span>
                            <span id="withdrawMaxAmount">الحد الأقصى: 0 د.ع</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">طريقة الاستلام</label>
                        <select class="form-control" id="withdrawMethod" required>
                            <option value="cash">نقداً</option>
                            <option value="bank_transfer">حوالة بنكية</option>
                            <option value="e_wallet">محفظة إلكترونية</option>
                        </select>
                    </div>
                    <div class="form-group" id="bankDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل الحساب البنكي</label>
                        <input type="text" class="form-control" id="bankDetails" placeholder="اسم البنك ورقم الحساب">
                        <div class="form-help-text">يرجى إدخال اسم البنك ورقم الحساب بشكل صحيح</div>
                    </div>
                    <div class="form-group" id="walletDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل المحفظة الإلكترونية</label>
                        <input type="text" class="form-control" id="walletDetails" placeholder="نوع المحفظة ورقم الهاتف">
                        <div class="form-help-text">يرجى إدخال نوع المحفظة ورقم الهاتف بشكل صحيح</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="withdrawNotes" rows="3" placeholder="يمكنك إضافة أي ملاحظات خاصة بطلب السحب هنا"></textarea>
                    </div>
                    <div class="alert-container">
                        <div id="withdrawError" class="error-message"></div>
                        <div id="withdrawSuccess" class="success-message"></div>
                    </div>
                    <div class="form-notice">
                        <i class="fas fa-info-circle"></i>
                        <span>سيتم مراجعة طلب السحب وقد يستغرق المعالجة من 1-3 أيام عمل.</span>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال الطلب
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Contact Support Modal -->
        <div class="modal" id="supportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">اتصل بالدعم</h2>
                    <button class="modal-close" onclick="closeSupportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="supportForm" onsubmit="submitSupportRequest(event)">
                    <div class="form-group">
                        <label class="form-label">موضوع المراسلة</label>
                        <select class="form-control" id="supportTopic" required>
                            <option value="">اختر الموضوع</option>
                            <option value="technical">مشكلة تقنية</option>
                            <option value="account">استفسار عن الحساب</option>
                            <option value="investment">استفسار عن الاستثمار</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الرسالة</label>
                        <textarea class="form-control" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <div id="supportError" class="error-message"></div>
                    <div id="supportSuccess" class="success-message"></div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Account Details Modal -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">تفاصيل الحساب</h2>
                    <button class="modal-close" onclick="closeDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">اسم المستثمر</div>
                        <div class="detail-value" id="detailsName">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم البطاقة</div>
                        <div class="detail-value" id="detailsCardNumber">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانتهاء</div>
                        <div class="detail-value" id="detailsExpiryDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الاستثمار</div>
                        <div class="detail-value" id="detailsTotalInvestment">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الأرباح</div>
                        <div class="detail-value" id="detailsTotalProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المستحقة</div>
                        <div class="detail-value" id="detailsDueProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المدفوعة</div>
                        <div class="detail-value" id="detailsPaidProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">نوع الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentType">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستحقاق</div>
                        <div class="detail-value" id="detailsMaturityDate">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Details Modal -->
        <div class="modal" id="notificationDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);" id="notificationDetailsTitle">تفاصيل الإشعار</h2>
                    <button class="modal-close" onclick="closeNotificationDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="account-details" id="notificationDetailsContent">
                    <!-- تفاصيل الإشعار ستظهر هنا -->
                </div>
            </div>
        </div>

        <!-- Notification Toast Container -->
        <div id="notificationToastContainer"></div>
  </div>
            </div>
        </div>

    <script>
     // Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
    authDomain: "messageemeapp.firebaseapp.com",
    databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
    projectId: "messageemeapp",
    storageBucket: "messageemeapp.appspot.com",
    messagingSenderId: "255034474844",
    appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Global variables
let currentInvestor = null;
let currentCard = null;
let qrScanner = null;
let currentFilter = 'all';
let notifications = [];
// المسار الصحيح في Firebase
const FIREBASE_USER_ID = '6wS4ga5v6MXUMC0yzyDnxuI2dh03';
const INVESTOR_CARD_ID = 'mai4v8cousf7soxqvt'; // معرف البطاقة المحدد
const CARDS_PATH = `users/${FIREBASE_USER_ID}/investorCards`;
const TRANSACTIONS_PATH = `users/${FIREBASE_USER_ID}/transactions`;
const WITHDRAWAL_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/withdrawRequests`;
const SUPPORT_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/supportRequests`;
const NOTIFICATIONS_PATH = `users/${FIREBASE_USER_ID}/notifications`;
const OPERATIONS_PATH = `users/${FIREBASE_USER_ID}/investorCards/${INVESTOR_CARD_ID}/recentOperations`;

// Initialize app
window.onload = function() {
    setupEventListeners();
    checkLocalStorage();
    hideLoading();
};

// Check for saved login info in localStorage
function checkLocalStorage() {
    const savedCard = localStorage.getItem('investorCard');
    const savedInvestor = localStorage.getItem('investorData');
    
    if (savedCard && savedInvestor) {
        try {
            currentCard = JSON.parse(savedCard);
            currentInvestor = JSON.parse(savedInvestor);
            showDashboard();
        } catch (error) {
            console.error('Error parsing saved data:', error);
            localStorage.removeItem('investorCard');
            localStorage.removeItem('investorData');
        }
    }
}

// Setup event listeners
function setupEventListeners() {
    // Card number formatting
    document.getElementById('cardNumber').addEventListener('input', formatCardNumber);
    
    // Expiry date formatting
    document.getElementById('expiryDate').addEventListener('input', formatExpiryDate);
    
    // CVV formatting
    document.getElementById('cvv').addEventListener('input', formatCVV);
    
    // Withdraw method change
    document.getElementById('withdrawMethod').addEventListener('change', function() {
        const method = this.value;
        document.getElementById('bankDetailsGroup').style.display = method === 'bank_transfer' ? 'block' : 'none';
        document.getElementById('walletDetailsGroup').style.display = method === 'e_wallet' ? 'block' : 'none';
    });
}

// Format card number input
function formatCardNumber(e) {
    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
}

// Format expiry date input
function formatExpiryDate(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
}

// Format CVV input
function formatCVV(e) {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
}

// Switch between tabs
function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

// Login with card
async function loginWithCard(event) {
    event.preventDefault();
    showLoading();
    clearErrors();

    const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;

    console.log("Attempting login with:", { cardNumber, expiryDate, cvv });

    try {
        // Search for card in Firebase with correct path
        const cardData = await findCardInDatabase(cardNumber, expiryDate, cvv);
        
        if (cardData) {
            currentCard = cardData;
            console.log("Card found:", cardData);
            
            // Load investor data from the card
            currentInvestor = {
                id: cardData.investorId,
                name: cardData.investorName,
                phone: cardData.investorPhone,
                email: cardData.investorEmail || '',
                joinDate: cardData.joinDate || new Date().toISOString()
            };
            
            // Save to localStorage for persistent login
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            localStorage.setItem('investorData', JSON.stringify(currentInvestor));
            
            showDashboard();
        } else {
            showError('بيانات البطاقة غير صحيحة');
        }
    } catch (error) {
        console.error('Login error:', error);
        showError('حدث خطأ في النظام');
    } finally {
        hideLoading();
    }
}

// Find card in database with correct path
async function findCardInDatabase(cardNumber, expiryDate, cvv) {
    console.log("Searching in path:", CARDS_PATH);
    
    const cardsRef = database.ref(CARDS_PATH);
    const snapshot = await cardsRef.once('value');
    const cards = snapshot.val() || {};
    
    console.log("Cards found:", cards);

    // Search through all cards
    for (const cardId in cards) {
        const card = cards[cardId];
        console.log("Checking card:", card);
        
        if (card.cardNumber === cardNumber && 
            formatCardExpiryDateFromDB(card.expiryDate) === expiryDate && 
            card.cvv === cvv) {
            console.log("Card match found!");
            return card;
        }
    }

    return null;
}

// Format expiry date from database format
function formatCardExpiryDateFromDB(dateString) {
    const date = new Date(dateString);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear().toString().substr(-2);
    return `${month}/${year}`;
}

// Start QR scan
async function startQRScan() {
    try {
        const qrScannerElement = document.getElementById('qr-scanner');
        qrScannerElement.style.display = 'block';
        
        qrScanner = new Html5QrcodeScanner(
            "qr-scanner", 
            { fps: 10, qrbox: 250 }
        );

        qrScanner.render(onQRSuccess, onQRError);
        document.getElementById('startScanBtn').style.display = 'none';
    } catch (error) {
        console.error('QR scanner error:', error);
        showError('خطأ في تشغيل الكاميرا');
    }
}

// Decode QR code from uploaded image
function decodeQRFromImage(file) {
    if (!file) {
        return;
    }
    
    showLoading();
    
    const html5QrCode = new Html5Qrcode("qr-scanner");
    
    html5QrCode.scanFile(file, true)
        .then(decodedText => {
            console.log(`QR Code from image: ${decodedText}`);
            processQRData(decodedText);
        })
        .catch(err => {
            console.error(`Error scanning uploaded QR code: ${err}`);
            showError('فشل في قراءة رمز QR من الصورة');
            hideLoading();
        });
}

// Process QR data (used by both camera and uploaded image)
async function processQRData(decodedText) {
    try {
        console.log("QR Code scanned:", decodedText);

        // Parse QR data
        const qrData = JSON.parse(decodedText);
        
        if (qrData.type === 'investor-card' && qrData.cardNumber) {
            // Auto-fill card data
            document.getElementById('cardNumber').value = formatCardNumberDisplay(qrData.cardNumber);
            document.getElementById('expiryDate').value = qrData.expiryDate;
            
            // Find card in database
            const cardData = await findCardByQR(qrData);
            
            if (cardData) {
                currentCard = cardData;
                
                // Load investor data from the card
                currentInvestor = {
                    id: cardData.investorId,
                    name: cardData.investorName,
                    phone: cardData.investorPhone,
                    email: cardData.investorEmail || '',
                    joinDate: cardData.joinDate || new Date().toISOString()
                };
                
                // Save to localStorage for persistent login
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                localStorage.setItem('investorData', JSON.stringify(currentInvestor));
                
                showDashboard();
            } else {
                showError('البطاقة غير موجودة في النظام');
            }
        } else {
            showError('رمز QR غير صالح');
        }
    } catch (error) {
        console.error('QR processing error:', error);
        showError('خطأ في معالجة رمز QR');
    } finally {
        hideLoading();
    }
}

// QR scan success
function onQRSuccess(decodedText) {
    if (qrScanner) {
        qrScanner.clear();
        qrScanner = null;
    }
    
    processQRData(decodedText);
}

// QR scan error
function onQRError(error) {
    console.warn('QR scan error:', error);
}

// Find card by QR data
async function findCardByQR(qrData) {
    const cardsRef = database.ref(CARDS_PATH);
    const snapshot = await cardsRef.once('value');
    const cards = snapshot.val() || {};

    // Search by card ID or investor ID
    for (const cardId in cards) {
        const card = cards[cardId];
        if ((card.id === qrData.id || card.investorId === qrData.investorId) &&
            card.cardNumber === qrData.cardNumber) {
            return card;
        }
    }

    return null;
}

// Show dashboard
function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboardScreen').style.display = 'block';
    document.getElementById('bottomNav').style.display = 'flex';
    
    // Make sure home section is visible and others are hidden
    switchSection('home');

    // Update dashboard with card data
    updateDashboard();
    
    // Load notifications
    loadNotifications();
    
    // Check for withdrawal requests status
    setTimeout(checkWithdrawalRequestsStatus, 2000);
}

// Update dashboard
function updateDashboard() {
    // Update header with investor name
    document.getElementById('headerUsername').textContent = `مرحباً، ${currentInvestor.name}`;
    
    // Update card display
    document.getElementById('displayCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
    document.getElementById('displayExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
    document.getElementById('cardDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
    document.getElementById('cardCompanyName').textContent = "سما بابل للاستثمار";

    // Update financial info
    document.getElementById('totalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
    document.getElementById('dueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
    document.getElementById('maturityDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
    document.getElementById('investmentStatus').textContent = currentCard.status || "نشط";

    // Update profile section
    updateProfileSection();
    
    // Load transactions
    loadTransactions();
    
    // Load filtered transactions
    loadFilteredTransactions(currentFilter);
}

// Refresh dashboard data
async function refreshDashboard() {
    showLoading();
    
    try {
        // Reload card data from Firebase
        if (currentCard && currentCard.id) {
            const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
            const snapshot = await cardRef.once('value');
            const updatedCard = snapshot.val();
            
            if (updatedCard) {
                currentCard = updatedCard;
                
                // Update localStorage
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                
                // Update UI
                updateDashboard();
            }
        }
        
        // Reload notifications
        loadNotifications();
    } catch (error) {
        console.error('Error refreshing data:', error);
    } finally {
        hideLoading();
    }
}

// Update profile section
function updateProfileSection() {
    // Set profile data
    document.getElementById('profileName').textContent = currentInvestor.name;
    document.getElementById('profileCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
    document.getElementById('profileFullName').textContent = currentInvestor.name;
    document.getElementById('profilePhone').textContent = currentInvestor.phone || '-';
    document.getElementById('profileEmail').textContent = currentInvestor.email || '-';
    document.getElementById('profileJoinDate').textContent = formatDate(currentInvestor.joinDate);
    
    // Set the first letter of the name as avatar text
    const avatarElement = document.getElementById('profileAvatar');
    const firstLetter = currentInvestor.name.charAt(0);
    avatarElement.innerHTML = `<span style="font-size: 2.5rem;">${firstLetter}</span>`;
}

// Format card number for display
function formatCardNumberDisplay(cardNumber) {
    return cardNumber.match(/.{1,4}/g).join(' ');
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-IQ', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount) + " د.ع";
}

// Load transactions
function loadTransactions() {
    const transactionsList = document.getElementById('transactionsList');
    transactionsList.innerHTML = '';
    
    try {
        // If we have recent operations in the card object
        if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
            // Sort operations by date (newest first)
            const sortedOperations = [...currentCard.recentOperations]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Display the 5 most recent transactions
            const recentOperations = sortedOperations.slice(0, 5);
            
            recentOperations.forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                transactionsList.appendChild(transactionElement);
            });
        } else {
            // Load operations from Firebase
            loadRecentOperationsFromFirebase(transactionsList);
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
        transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">حدث خطأ في تحميل المعاملات</p>';
    }
}

// Load recent operations from Firebase
async function loadRecentOperationsFromFirebase(transactionsList) {
    try {
        const operationsRef = database.ref(OPERATIONS_PATH);
        const snapshot = await operationsRef.orderByChild('date').once('value');
        
        // Convert to array and sort by date (newest first)
        const operations = [];
        snapshot.forEach(childSnapshot => {
            operations.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });
        
        // Sort by date (newest first)
        operations.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Display operations
        if (operations.length > 0) {
            // Update currentCard with recent operations
            if (!currentCard.recentOperations) {
                currentCard.recentOperations = [];
            }
            currentCard.recentOperations = operations;
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            
            // Display the 5 most recent transactions
            const recentOperations = operations.slice(0, 5);
            recentOperations.forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                transactionsList.appendChild(transactionElement);
            });
        } else {
            // No operations found, generate mock data
            const mockTransactions = generateMockTransactions();
            
            // Save mock transactions to card
            currentCard.recentOperations = mockTransactions;
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            
            // Display mock transactions
            mockTransactions.forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                transactionsList.appendChild(transactionElement);
            });
        }
    } catch (error) {
        console.error('Error loading operations from Firebase:', error);
        
        // Use mock data as fallback
        const mockTransactions = generateMockTransactions();
        currentCard.recentOperations = mockTransactions;
        localStorage.setItem('investorCard', JSON.stringify(currentCard));
        
        mockTransactions.forEach(transaction => {
            const transactionElement = createTransactionElement(transaction);
            transactionsList.appendChild(transactionElement);
        });
    }
}

// Generate mock transactions if none exist
function generateMockTransactions() {
    const transactions = [];
    const today = new Date();
    
    // Investment transaction
    transactions.push({
        id: generateId(),
        type: 'investment',
        amount: currentCard.totalInvestment || 4000,
        date: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString(), // 180 days ago
        status: 'completed',
        description: 'استثمار أولي'
    });
    
    // Generate multiple profit transactions for the past few months
    for (let i = 6; i > 0; i--) {
        transactions.push({
            id: generateId(),
            type: 'profit',
            amount: 500 + Math.random() * 300,
            date: new Date(today.getTime() - i * 30 * 24 * 60 * 60 * 1000).toISOString(), // i months ago
            status: 'completed',
            description: 'أرباح شهرية'
        });
    }
    
    // Add a withdrawal transaction
    transactions.push({
        id: generateId(),
        type: 'withdrawal',
        amount: 800,
        date: new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString(), // 90 days ago
        status: 'completed',
        description: 'سحب أرباح'
    });
    
    // Sort by date (newest first)
    return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
}

// Load filtered transactions
function loadFilteredTransactions(filter) {
    const transactionsList = document.getElementById('filteredTransactionsList');
    transactionsList.innerHTML = '';
    
    // Activate the selected filter button
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.filter-btn[onclick="filterTransactions('${filter}')"]`).classList.add('active');
    
    // If we have recent operations in the card object
    if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
        // Sort operations by date (newest first)
        const sortedOperations = [...currentCard.recentOperations]
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Filter transactions based on selected filter
        let filteredOperations = sortedOperations;
        if (filter !== 'all') {
            filteredOperations = sortedOperations.filter(op => op.type === filter);
        }
        
        // Group transactions by date
        const groupedTransactions = groupTransactionsByDate(filteredOperations);
        
        // Display grouped transactions
        Object.keys(groupedTransactions).forEach(date => {
            // Add date header
            const dateHeader = document.createElement('div');
            dateHeader.className = 'transaction-date-header';
            dateHeader.textContent = date;
            transactionsList.appendChild(dateHeader);
            
            // Add transactions for this date
            groupedTransactions[date].forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                transactionsList.appendChild(transactionElement);
            });
        });
        
        // If no transactions found for this filter
        if (filteredOperations.length === 0) {
            transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات لهذا النوع</p>';
        }
    } else {
        transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات</p>';
    }
}

// Group transactions by date
function groupTransactionsByDate(transactions) {
    const groups = {};
    
    transactions.forEach(transaction => {
        const dateString = formatDate(transaction.date);
        
        if (!groups[dateString]) {
            groups[dateString] = [];
        }
        
        groups[dateString].push(transaction);
    });
    
    return groups;
}

// Filter transactions
function filterTransactions(filter) {
    currentFilter = filter;
    loadFilteredTransactions(filter);
}

// Create transaction element
function createTransactionElement(transaction) {
    const div = document.createElement('div');
    div.className = 'transaction-item';
    div.dataset.id = transaction.id || '';

    const icon = getTransactionIcon(transaction.type);
    const amount = transaction.amount;
    const isPositive = transaction.type === 'profit' || transaction.type === 'investment';
    
    // Extract time from date for display
    const transactionDate = new Date(transaction.date);
    const hours = transactionDate.getHours().toString().padStart(2, '0');
    const minutes = transactionDate.getMinutes().toString().padStart(2, '0');
    const timeString = `${hours}:${minutes}`;

    div.innerHTML = `
        <div class="transaction-icon">
            <i class="${icon}"></i>
        </div>
        <div class="transaction-info">
            <div class="transaction-type">${getTransactionTypeName(transaction.type)}</div>
            <div class="transaction-date">${formatDate(transaction.date)}</div>
        </div>
        <div style="text-align: left; direction: ltr;">
            <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? '+' : '-'} ${formatCurrency(amount)}
            </div>
            <div class="transaction-time">${timeString}</div>
        </div>
    `;

    return div;
}

// Get transaction icon
function getTransactionIcon(type) {
    switch (type) {
        case 'deposit':
        case 'investment':
            return 'fas fa-arrow-down';
        case 'withdrawal':
            return 'fas fa-arrow-up';
        case 'profit':
            return 'fas fa-hand-holding-usd';
        default:
            return 'fas fa-exchange-alt';
    }
}

// Get transaction type name
function getTransactionTypeName(type) {
    switch (type) {
        case 'deposit':
            return 'إيداع';
        case 'investment':
            return 'استثمار';
        case 'withdrawal':
            return 'سحب';
        case 'profit':
            return 'أرباح';
        default:
            return type;
    }
}

// تحديث دالة تحميل الإشعارات لجلب البيانات الحقيقية من Firebase
async function loadNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">جاري تحميل الإشعارات...</p>';
    
    try {
        // مسار الإشعارات للمستثمر الحالي في Firebase
        // مسار الإشعارات الصحيح يستخدم معرف المستخدم وبطاقة المستثمر
        const investorId = currentInvestor?.id || '';
        const cardId = currentCard?.id || '';
        
        // تحقق من صحة المعرفات قبل الاستمرار
        if (!investorId || !cardId) {
            console.error('معرفات المستثمر أو البطاقة غير متوفرة');
            notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا يمكن تحميل الإشعارات، الرجاء إعادة تسجيل الدخول</p>';
            return;
        }
        
        // الحصول على الإشعارات من Firebase - استخدام المسار الصحيح
        const notificationsRef = database.ref(`${NOTIFICATIONS_PATH}`);
        const snapshot = await notificationsRef.orderByChild('date').once('value');
        
        // إنشاء مصفوفة من الإشعارات
        const notificationsArray = [];
        snapshot.forEach(childSnapshot => {
            const notification = childSnapshot.val();
            // إضافة معرف الإشعار للاستخدام لاحقًا
            notification.id = childSnapshot.key;
            notificationsArray.push(notification);
        });
        
        // جلب العمليات الحالية وتحويلها إلى إشعارات
        const operationsRef = database.ref(`${OPERATIONS_PATH}`);
        const operationsSnapshot = await operationsRef.once('value');
        const operations = [];
        
        operationsSnapshot.forEach(childSnapshot => {
            const operation = childSnapshot.val();
            // إضافة معرف العملية
            operation.id = childSnapshot.key;
            operations.push(operation);
            
            // تحويل العملية إلى إشعار وإضافته إلى مصفوفة الإشعارات
            const notification = createNotificationFromOperation(operation);
            if (notification) {
                notificationsArray.push(notification);
            }
        });
        
        // ترتيب الإشعارات حسب التاريخ (الأحدث أولاً)
        notifications = notificationsArray.sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        // عرض الإشعارات
        displayNotifications(notifications);
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
        
        // الاستماع للتغييرات في الإشعارات في الوقت الفعلي
        listenForNotificationChanges();
    } catch (error) {
        console.error('خطأ في تحميل الإشعارات:', error);
        notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">حدث خطأ في تحميل الإشعارات</p>';
    }
}

// دالة لعرض الإشعارات
function displayNotifications(notificationsArray) {
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '';
    
    if (notificationsArray.length === 0) {
        notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد إشعارات</p>';
        return;
    }
    
    // عرض كل إشعار
    notificationsArray.forEach(notification => {
        const notificationElement = createNotificationElement(notification);
        notificationsList.appendChild(notificationElement);
    });
}

// تحديث دالة تحويل العملية إلى إشعار
function createNotificationFromOperation(operation) {
    if (!operation || !operation.type) return null;
    
    // تخصيص عنوان الإشعار ونص الرسالة حسب نوع العملية
    let title = '';
    let message = '';
    let notificationType = operation.type;
    
    switch (operation.type) {
        case 'investment':
        case 'deposit':
            title = 'استثمار جديد';
            message = `تم إضافة استثمار جديد بقيمة ${formatCurrency(operation.amount)}`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
        case 'withdrawal':
            title = 'طلب سحب';
            message = `تم تسجيل طلب سحب بقيمة ${formatCurrency(operation.amount)}`;
            if (operation.status === 'pending') {
                message += `. الطلب قيد المراجعة`;
            } else if (operation.status === 'completed') {
                message += `. تمت الموافقة على الطلب`;
            } else if (operation.status === 'rejected') {
                message += `. تم رفض الطلب`;
            }
            break;
        case 'profit':
            title = 'أرباح جديدة';
            message = `تم إضافة أرباح بقيمة ${formatCurrency(operation.amount)} إلى حسابك`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
        case 'system':
            title = 'إشعار نظام';
            message = operation.message || 'إشعار من النظام';
            break;
        default:
            title = 'إشعار جديد';
            message = operation.message || `تم تسجيل عملية جديدة بقيمة ${formatCurrency(operation.amount || 0)}`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
    }
    
    // إنشاء كائن الإشعار
    return {
        id: operation.id || generateId(),
        title: title,
        message: message,
        type: notificationType,
        read: false,
        date: operation.date || new Date().toISOString(),
        amount: operation.amount,
        status: operation.status,
        operation: operation // تخزين العملية الأصلية للرجوع إليها عند الحاجة
    };
}

// تحديث دالة إنشاء عنصر الإشعار
function createNotificationElement(notification) {
    const div = document.createElement('div');
    div.className = `notification-item ${notification.read ? '' : 'unread'} ${Date.now() - new Date(notification.date) < 3600000 ? 'new-notification' : ''}`;
    div.dataset.id = notification.id;
    
    const icon = getNotificationIcon(notification.type);
    
    let statusHTML = '';
    if (notification.status) {
        let statusClass = notification.status;
        let statusText = 'قيد المراجعة';
        
        if (notification.status === 'completed') {
            statusText = 'مكتمل';
        } else if (notification.status === 'rejected') {
            statusText = 'مرفوض';
        } else if (notification.status === 'active') {
            statusText = 'نشط';
        }
        
        statusHTML = `<div class="notification-status ${statusClass}">الحالة: ${statusText}</div>`;
    }
    
    div.innerHTML = `
        <div class="notification-icon">
            <i class="${icon}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            ${notification.amount ? `<div class="notification-amount">${formatCurrency(notification.amount)}</div>` : ''}
            ${statusHTML}
            <div class="notification-date">${formatDate(notification.date)} - ${formatTime(notification.date)}</div>
        </div>
    `;
    
    // إضافة حدث النقر لعرض تفاصيل الإشعار
    div.addEventListener('click', () => {
        markNotificationAsRead(notification.id);
        div.classList.remove('unread');
        openNotificationDetails(notification);
    });
    
    return div;
}

// دالة للاستماع للتغييرات في الإشعارات في الوقت الفعلي
function listenForNotificationChanges() {
    // الاستماع للإشعارات الجديدة
    const notificationsRef = database.ref(`${NOTIFICATIONS_PATH}`);
    notificationsRef.off(); // إزالة المستمعين السابقين
    
    notificationsRef.on('child_added', (snapshot) => {
        const newNotification = snapshot.val();
        if (newNotification) {
            newNotification.id = snapshot.key;
            
            // التحقق من عدم وجود الإشعار مسبقًا
            const existingIndex = notifications.findIndex(n => n.id === newNotification.id);
            if (existingIndex === -1) {
                // إضافة الإشعار الجديد إلى القائمة
                notifications.unshift(newNotification);
                
                // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                if (document.getElementById('notificationsSection').style.display === 'block') {
                    displayNotifications(notifications);
                } else {
                    // إظهار مؤشر على وجود إشعارات جديدة
                    showNotificationIndicator();
                }
                
                // تحديث عدد الإشعارات غير المقروءة
                updateUnreadCount();
            }
        }
    });
    
    // الاستماع لتحديثات الإشعارات
    notificationsRef.on('child_changed', (snapshot) => {
        const updatedNotification = snapshot.val();
        if (updatedNotification) {
            updatedNotification.id = snapshot.key;
            
            // تحديث الإشعار في القائمة
            const existingIndex = notifications.findIndex(n => n.id === updatedNotification.id);
            if (existingIndex !== -1) {
                notifications[existingIndex] = updatedNotification;
                
                // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                if (document.getElementById('notificationsSection').style.display === 'block') {
                    displayNotifications(notifications);
                }
                
                // تحديث عدد الإشعارات غير المقروءة
                updateUnreadCount();
            }
        }
    });
    
    // الاستماع لحذف الإشعارات
    notificationsRef.on('child_removed', (snapshot) => {
        const removedId = snapshot.key;
        
        // حذف الإشعار من القائمة
        notifications = notifications.filter(n => n.id !== removedId);
        
        // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
        if (document.getElementById('notificationsSection').style.display === 'block') {
            displayNotifications(notifications);
        }
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
    });
    
    // الاستماع للعمليات الجديدة
    const operationsRef = database.ref(`${OPERATIONS_PATH}`);
    operationsRef.off(); // إزالة المستمعين السابقين
    
    operationsRef.on('child_added', (snapshot) => {
        const newOperation = snapshot.val();
        if (newOperation) {
            newOperation.id = snapshot.key;
            
            // إنشاء إشعار من العملية
            const newNotification = createNotificationFromOperation(newOperation);
            if (newNotification) {
                // التحقق من عدم وجود الإشعار مسبقًا
                const existingIndex = notifications.findIndex(n => n.id === newNotification.id);
                if (existingIndex === -1) {
                    // إضافة الإشعار الجديد إلى القائمة
                    notifications.unshift(newNotification);
                    
                    // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                    if (document.getElementById('notificationsSection').style.display === 'block') {
                        displayNotifications(notifications);
                    } else {
                        // إظهار مؤشر على وجود إشعارات جديدة
                        showNotificationIndicator();
                    }
                    
                    // تحديث عدد الإشعارات غير المقروءة
                    updateUnreadCount();
                }
            }
        }
    });
}

// تحديث دالة وضع علامة "مقروء" على الإشعار
async function markNotificationAsRead(notificationId) {
    // التحقق من وجود الإشعار
    const notificationIndex = notifications.findIndex(n => n.id === notificationId);
    if (notificationIndex === -1) return;
    
    // تحديث حالة الإشعار في المصفوفة
    notifications[notificationIndex].read = true;
    
    try {
        // تحديث حالة الإشعار في Firebase - استخدام المسار الصحيح
        await database.ref(`${NOTIFICATIONS_PATH}/${notificationId}`).update({ read: true });
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
    } catch (error) {
        console.error('خطأ في تحديث حالة الإشعار:', error);
    }
}

// دالة لإظهار مؤشر على وجود إشعارات جديدة
function showNotificationIndicator() {
    const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
    if (notificationNav) {
        // إضافة نقطة حمراء صغيرة لتنبيه المستخدم بوجود إشعارات جديدة
        if (!notificationNav.querySelector('.notification-indicator')) {
            const indicator = document.createElement('div');
            indicator.className = 'notification-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 8px;
                height: 8px;
                background-color: var(--red);
                border-radius: 50%;
            `;
            notificationNav.appendChild(indicator);
            notificationNav.style.position = 'relative';
        }
    }
}

// تحديث دالة تحديد عدد الإشعارات غير المقروءة
function updateUnreadCount() {
    const unreadCount = notifications.filter(notification => !notification.read).length;
    
    const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
    const countBadge = notificationNav.querySelector('.notification-count');
    
    if (unreadCount > 0) {
        if (countBadge) {
            countBadge.textContent = unreadCount;
        } else {
            const badge = document.createElement('div');
            badge.className = 'notification-count';
            badge.textContent = unreadCount;
            badge.style.cssText = `
                position: absolute;
                top: 0;
                right: 0;
                min-width: 16px;
                height: 16px;
                background-color: var(--red);
                border-radius: 8px;
                color: white;
                font-size: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0 4px;
            `;
            notificationNav.appendChild(badge);
            notificationNav.style.position = 'relative';
        }
    } else if (countBadge) {
        countBadge.remove();
    }
}

// تحديث دالة تنسيق الوقت
function formatTime(dateString) {
    const date = new Date(dateString);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

// تحديث switchSection لتحديث قراءة الإشعارات عند الانتقال إلى قسم الإشعارات
const originalSwitchSection = window.switchSection || function(section) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.nav-item[onclick="switchSection('${section}')"]`).classList.add('active');
    
    // Hide all sections
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('transactionsSection').style.display = 'none';
    document.getElementById('notificationsSection').style.display = 'none';
    
    // Show the selected section
    if (section === 'home') {
        document.getElementById('homeSection').style.display = 'block';
    } else if (section === 'profile') {
        document.getElementById('profileSection').style.display = 'block';
    } else if (section === 'transactions') {
        document.getElementById('transactionsSection').style.display = 'block';
        // Make sure transactions are loaded with current filter
        loadFilteredTransactions(currentFilter);
    } else if (section === 'notifications') {
        document.getElementById('notificationsSection').style.display = 'block';
        // Make sure notifications are loaded
        loadNotifications();
    }
};

window.switchSection = function(section) {
    originalSwitchSection(section);
    
    if (section === 'notifications') {
        const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
        const indicator = notificationNav.querySelector('.notification-indicator');
        if (indicator) {
            indicator.remove();
        }
        
        // تحديث حالة القراءة للإشعارات المعروضة
        const notificationItems = document.querySelectorAll('#notificationsList .notification-item.unread');
        notificationItems.forEach(item => {
            const notificationId = item.dataset.id;
            if (notificationId) {
                markNotificationAsRead(notificationId);
                item.classList.remove('unread');
            }
        });
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
    }
};

// إضافة دالة لفتح نافذة تفاصيل الإشعار
function openNotificationDetails(notification) {
    // التأكد من وجود النافذة المنبثقة في الصفحة
    const modal = document.getElementById('notificationDetailsModal');
    const modalTitle = document.getElementById('notificationDetailsTitle');
    const modalContent = document.getElementById('notificationDetailsContent');
    
    if (!modal || !modalTitle || !modalContent) {
        console.error('عناصر نافذة تفاصيل الإشعار غير موجودة');
        return;
    }
    
    // تعيين عنوان النافذة
    modalTitle.textContent = notification.title;
    
    // تحديد نوع المحتوى بناءً على نوع الإشعار
    let detailsContent = '';
    
    if (notification.operation) {
        const operation = notification.operation;
        
        switch (operation.type) {
            case 'investment':
            case 'deposit':
                detailsContent = `
                    <div class="detail-item">
                        <div class="detail-label">المبلغ المستثمر</div>
                        <div class="detail-value">${formatCurrency(operation.amount)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستثمار</div>
                        <div class="detail-value">${formatDate(operation.date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الحالة</div>
                        <div class="detail-value">${operation.status === 'active' ? 'نشط' : operation.status === 'completed' ? 'مكتمل' : 'قيد المراجعة'}</div>
                    </div>
                `;
                break;
            case 'withdrawal':
                detailsContent = `
                    <div class="detail-item">
                        <div class="detail-label">المبلغ المسحوب</div>
                        <div class="detail-value">${formatCurrency(operation.amount)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الطلب</div>
                        <div class="detail-value">${formatDate(operation.date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">طريقة الاستلام</div>
                        <div class="detail-value">${operation.method === 'cash' ? 'نقداً' : operation.method === 'bank_transfer' ? 'حوالة بنكية' : 'محفظة إلكترونية'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الحالة</div>
                        <div class="detail-value">${operation.status === 'completed' ? 'مكتمل' : operation.status === 'rejected' ? 'مرفوض' : 'قيد المراجعة'}</div>
                    </div>
                `;
                break;
            case 'profit':
                detailsContent = `
                    <div class="detail-item">
                        <div class="detail-label">مبلغ الربح</div>
                        <div class="detail-value">${formatCurrency(operation.amount)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الإضافة</div>
                        <div class="detail-value">${formatDate(operation.date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الفترة</div>
                        <div class="detail-value">${operation.period || 'غير محدد'}</div>
                    </div>
                `;
                break;
            default:
                detailsContent = `
                    <div class="detail-item">
                        <div class="detail-label">التاريخ</div>
                        <div class="detail-value">${formatDate(operation.date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الوصف</div>
                        <div class="detail-value">${operation.description || 'غير متوفر'}</div>
                    </div>
                `;
        }
    } else {
        detailsContent = `
            <div class="detail-item">
                <div class="detail-label">التاريخ</div>
                <div class="detail-value">${formatDate(notification.date)}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">الوصف</div>
                <div class="detail-value">${notification.message}</div>
            </div>
        `;
    }
    
    // إضافة المحتوى إلى النافذة
    modalContent.innerHTML = detailsContent;
    
    // عرض النافذة
    modal.classList.add('active');
}

// إغلاق نافذة تفاصيل الإشعار
function closeNotificationDetailsModal() {
    const modal = document.getElementById('notificationDetailsModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// تحسين وظيفة طلب السحب
async function openWithdrawModal() {
    document.getElementById('withdrawModal').classList.add('active');
    
    try {
        // تحديث المبلغ المتاح للسحب من البيانات الحالية
        // احصل على أحدث بيانات البطاقة من قاعدة البيانات
        if (currentCard && currentCard.id) {
            const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
            const snapshot = await cardRef.once('value');
            const updatedCard = snapshot.val();
            
            if (updatedCard) {
                // تحديث البيانات المحلية
                currentCard = updatedCard;
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
            }
        }
        
        // عرض المبلغ المتاح للسحب
        document.getElementById('availableBalance').value = formatCurrency(currentCard.dueProfit || 0);
        
        // إضافة رقم البطاقة
        const withdrawCardNumber = document.getElementById('withdrawCardNumber');
        if (withdrawCardNumber) {
            withdrawCardNumber.textContent = formatCardNumberDisplay(currentCard.cardNumber);
        }
        
        // إضافة الحد الأدنى والأقصى
        const withdrawMinAmount = document.getElementById('withdrawMinAmount');
        if (withdrawMinAmount) {
            // تحديد الحد الأدنى (مثال: 50 دينار)
            const minAmount = 50;
            withdrawMinAmount.textContent = `الحد الأدنى: ${formatCurrency(minAmount)}`;
            
            // تعيين قيمة الحد الأدنى في حقل المبلغ
            document.getElementById('withdrawAmount').min = minAmount;
        }
        
        const withdrawMaxAmount = document.getElementById('withdrawMaxAmount');
        if (withdrawMaxAmount) {
            // تحديد الحد الأقصى (مبلغ الأرباح المستحقة)
            const maxAmount = currentCard.dueProfit || 0;
            withdrawMaxAmount.textContent = `الحد الأقصى: ${formatCurrency(maxAmount)}`;
            
            // تعيين قيمة الحد الأقصى في حقل المبلغ
            document.getElementById('withdrawAmount').max = maxAmount;
        }
    } catch (error) {
        console.error('خطأ في تحديث بيانات طلب السحب:', error);
    }
    
    // إعادة ضبط النموذج
    document.getElementById('withdrawForm').reset();
    document.getElementById('withdrawError').style.display = 'none';
    document.getElementById('withdrawSuccess').style.display = 'none';
    document.getElementById('bankDetailsGroup').style.display = 'none';
    document.getElementById('walletDetailsGroup').style.display = 'none';
}

// تحسين وظيفة إرسال طلب السحب
async function submitWithdrawRequest(event) {
    event.preventDefault();
    showLoading();

    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const method = document.getElementById('withdrawMethod').value;
    const notes = document.getElementById('withdrawNotes').value;
    
    // الحصول على التفاصيل الإضافية حسب طريقة السحب
    let details = '';
    if (method === 'bank_transfer') {
        details = document.getElementById('bankDetails').value;
        
        // التحقق من صحة تفاصيل البنك
        if (!details) {
            showWithdrawError('يرجى إدخال تفاصيل الحساب البنكي');
            hideLoading();
            return;
        }
    } else if (method === 'e_wallet') {
        details = document.getElementById('walletDetails').value;
        
        // التحقق من صحة تفاصيل المحفظة
        if (!details) {
            showWithdrawError('يرجى إدخال تفاصيل المحفظة الإلكترونية');
            hideLoading();
            return;
        }
    }

    try {
        // التحقق من صحة البيانات
        if (amount <= 0) {
            showWithdrawError('يرجى إدخال مبلغ صحيح');
            hideLoading();
            return;
        }
        
        // احصل على أحدث بيانات البطاقة
        let dueProfit = currentCard.dueProfit || 0;
        
        if (currentCard && currentCard.id) {
            try {
                const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
                const snapshot = await cardRef.once('value');
                const updatedCard = snapshot.val();
                
                if (updatedCard) {
                    dueProfit = updatedCard.dueProfit || 0;
                    
                    // تحديث البيانات المحلية
                    currentCard = updatedCard;
                    localStorage.setItem('investorCard', JSON.stringify(currentCard));
                }
            } catch (cardError) {
                console.error('خطأ في تحديث بيانات البطاقة:', cardError);
            }
        }
        
        if (amount > dueProfit) {
            showWithdrawError('المبلغ المطلوب أكبر من الرصيد المتاح');
            hideLoading();
            return;
        }
        
        // التحقق من الحد الأدنى للسحب
        const minAmount = 50; // الحد الأدنى للسحب
        if (amount < minAmount) {
            showWithdrawError(`الحد الأدنى للسحب هو ${formatCurrency(minAmount)}`);
            hideLoading();
            return;
        }

        // إنشاء طلب سحب
        const withdrawRequest = {
            id: generateId(),
            type: 'withdrawal',
            investorId: currentInvestor.id,
            investorName: currentInvestor.name,
            cardId: currentCard.id,
            cardNumber: currentCard.cardNumber,
            amount: amount,
            method: method,
            details: details,
            notes: notes,
            status: 'pending',
            requestDate: new Date().toISOString(),
            created_at: new Date().toISOString()
        };

        // حفظ طلب السحب في Firebase
        await database.ref(`${WITHDRAWAL_REQUESTS_PATH}/${withdrawRequest.id}`).set(withdrawRequest);
        
        // إضافة العملية إلى عمليات البطاقة
        const operationId = generateId();
        const operation = {
            id: operationId,
            type: 'withdrawal',
            investorId: currentInvestor.id,
            investorName: currentInvestor.name,
            cardId: currentCard.id,
            cardNumber: currentCard.cardNumber,
            amount: amount,
            date: new Date().toISOString(),
            status: 'pending',
            description: 'طلب سحب قيد المراجعة',
            method: method,
            details: details,
            notes: notes
        };
        
        // حفظ العملية في Firebase
        await database.ref(`${OPERATIONS_PATH}/${operationId}`).set(operation);
        
        // إضافة العملية إلى مصفوفة العمليات المحلية
        if (!currentCard.recentOperations) {
            currentCard.recentOperations = [];
        }
        
        currentCard.recentOperations.push(operation);
        localStorage.setItem('investorCard', JSON.stringify(currentCard));
        
        // إنشاء إشعار للمستخدم
        const notificationId = generateId();
        const notification = {
            id: notificationId,
            title: 'تم استلام طلب السحب',
            message: `تم استلام طلب سحب بقيمة ${formatCurrency(amount)} وسيتم مراجعته في أقرب وقت.`,
            type: 'withdrawal',
            read: false,
            date: new Date().toISOString(),
            investorId: currentInvestor.id,
            amount: amount,
            operation: operation
        };
        
        // حفظ الإشعار في Firebase
        await database.ref(`${NOTIFICATIONS_PATH}/${notificationId}`).set(notification);
        
        // عرض رسالة نجاح
        showWithdrawSuccess('تم إرسال طلب السحب بنجاح. سيتم مراجعة طلبك قريبًا وستتلقى إشعارًا عند معالجته.');
        
        // تحديث صفحة الرئيسية والمعاملات
        loadTransactions();
        
        // إغلاق النافذة بعد فترة
        setTimeout(() => {
            closeWithdrawModal();
        }, 3000);
    } catch (error) {
        console.error('خطأ في إرسال طلب السحب:', error);
        showWithdrawError('حدث خطأ في إرسال الطلب. الرجاء المحاولة مرة أخرى لاحقًا.');
    } finally {
        hideLoading();
    }
}

// دالة لعرض خطأ في نافذة السحب
function showWithdrawError(message) {
    const errorElement = document.getElementById('withdrawError');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    
    // التمرير إلى رسالة الخطأ
    errorElement.scrollIntoView({ behavior: 'smooth' });
    
    // إخفاء الرسالة بعد 5 ثوان
    setTimeout(() => {
        errorElement.style.display = 'none';
    }, 5000);
}

// دالة لعرض رسالة نجاح في نافذة السحب
function showWithdrawSuccess(message) {
    const successElement = document.getElementById('withdrawSuccess');
    successElement.textContent = message;
    successElement.style.display = 'block';
    
    // التمرير إلى رسالة النجاح
    successElement.scrollIntoView({ behavior: 'smooth' });
}

// تحسين دالة إغلاق نافذة السحب
function closeWithdrawModal() {
    document.getElementById('withdrawModal').classList.remove('active');
    
    // إعادة تحميل البيانات المحلية للتأكد من التحديثات
    loadTransactions();
}

// التحقق من حالة طلبات السحب
async function checkWithdrawalRequestsStatus() {
    try {
        // التحقق من وجود مستثمر حالي
        if (!currentInvestor || !currentInvestor.id) {
            return;
        }
        
        // الحصول على طلبات السحب الحالية
        const withdrawalsRef = database.ref(WITHDRAWAL_REQUESTS_PATH);
        const query = withdrawalsRef.orderByChild('investorId').equalTo(currentInvestor.id);
        const snapshot = await query.once('value');
        
        // المعالجة إذا كان هناك طلبات
        if (snapshot.exists()) {
            const withdrawals = [];
            
            snapshot.forEach(childSnapshot => {
                withdrawals.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            
            // فرز الطلبات حسب التاريخ (الأحدث أولاً)
            withdrawals.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
            
            // التحقق من طلبات تمت معالجتها مؤخرًا
            const recentWithdrawals = withdrawals.filter(w => {
                // تحقق من الحالة وما إذا تم التحديث خلال الساعة الماضية
                const isRecent = new Date(w.requestDate) > new Date(Date.now() - 24 * 60 * 60 * 1000);
                return isRecent && (w.status === 'completed' || w.status === 'rejected');
            });
            
            // عرض إشعارات للطلبات المعالجة حديثًا
            recentWithdrawals.forEach(withdrawal => {
                // التحقق من أنه لم يتم إنشاء إشعار مسبقًا
                const statusText = withdrawal.status === 'completed' ? 'تمت الموافقة على' : 'تم رفض';
                const message = `${statusText} طلب السحب بقيمة ${formatCurrency(withdrawal.amount)}`;
                
                createNotification(
                    withdrawal.status === 'completed' ? 'تم الموافقة على الطلب' : 'تم رفض الطلب',
                    message,
                    withdrawal.status === 'completed' ? 'success' : 'danger'
                );
            });
        }
    } catch (error) {
        console.error('خطأ في التحقق من حالة طلبات السحب:', error);
    }
}

// تكملة من الملف السابق - يتابع تنفيذ دالة إنشاء إشعار مرئي

// تكملة دالة createNotification
function createNotification(title, message, type = 'info') {
    // إنشاء عنصر الإشعار
    const notification = document.createElement('div');
    notification.className = `notification-toast ${type}`;
    
    // إضافة المحتوى
    notification.innerHTML = `
        <div class="notification-toast-header">
            <div class="notification-toast-title">${title}</div>
            <button class="notification-toast-close">&times;</button>
        </div>
        <div class="notification-toast-body">${message}</div>
    `;
    
    // إضافة الإشعار إلى الصفحة
    const container = document.getElementById('notificationToastContainer');
    if (!container) {
        // إنشاء حاوية الإشعارات إذا لم تكن موجودة
        const newContainer = document.createElement('div');
        newContainer.id = 'notificationToastContainer';
        newContainer.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
            direction: rtl;
        `;
        document.body.appendChild(newContainer);
        newContainer.appendChild(notification);
    } else {
        container.appendChild(notification);
    }
    
    // إضافة سلوك زر الإغلاق
    const closeButton = notification.querySelector('.notification-toast-close');
    closeButton.addEventListener('click', () => {
        notification.classList.add('hiding');
        setTimeout(() => {
            notification.remove();
        }, 300);
    });
    
    // إغلاق الإشعار تلقائيًا بعد 5 ثوان
    setTimeout(() => {
        notification.classList.add('hiding');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 5000);
    
    return notification;
}

// الحصول على أيقونة الإشعار
function getNotificationIcon(type) {
    switch (type) {
        case 'investment':
        case 'deposit':
            return 'fas fa-chart-line';
        case 'withdrawal':
            return 'fas fa-money-bill-wave';
        case 'profit':
            return 'fas fa-coins';
        case 'welcome':
            return 'fas fa-handshake';
        case 'system':
            return 'fas fa-cogs';
        default:
            return 'fas fa-bell';
    }
}

// Show contact support modal
function showContactSupport() {
    document.getElementById('supportModal').classList.add('active');
    
    // Reset form
    document.getElementById('supportForm').reset();
    document.getElementById('supportError').style.display = 'none';
    document.getElementById('supportSuccess').style.display = 'none';
}

// Close support modal
function closeSupportModal() {
    document.getElementById('supportModal').classList.remove('active');
}

// Submit support request
async function submitSupportRequest(event) {
    event.preventDefault();
    showLoading();
    
    const topic = document.getElementById('supportTopic').value;
    const message = document.getElementById('supportMessage').value;
    
    try {
        // Validate inputs
        if (!topic || !message) {
            document.getElementById('supportError').textContent = 'يرجى ملء جميع الحقول';
            document.getElementById('supportError').style.display = 'block';
            hideLoading();
            return;
        }
        
        // Create support request
        const supportRequest = {
            id: generateId(),
            investorId: currentInvestor.id,
            investorName: currentInvestor.name,
            phone: currentInvestor.phone,
            email: currentInvestor.email,
            topic: topic,
            message: message,
            status: 'new',
            date: new Date().toISOString()
        };
        
        // Save to Firebase
        await database.ref(`${SUPPORT_REQUESTS_PATH}/${supportRequest.id}`).set(supportRequest);
        
        // Add notification for support request
        const supportNotification = {
            id: generateId(),
            title: 'تم استلام طلب الدعم',
            message: 'تم استلام رسالتك وسيتم التواصل معك في أقرب وقت ممكن.',
            type: 'support',
            read: false,
            date: new Date().toISOString()
        };
        
        // Save notification to Firebase
        await database.ref(`${NOTIFICATIONS_PATH}/${supportNotification.id}`).set(supportNotification);
        
        // Show success
        document.getElementById('supportSuccess').textContent = 'تم إرسال طلبك بنجاح وسيتم التواصل معك قريبًا';
        document.getElementById('supportSuccess').style.display = 'block';
        
        // Clear form
        document.getElementById('supportForm').reset();
        
        // Close modal after delay
        setTimeout(() => {
            document.getElementById('supportSuccess').style.display = 'none';
            closeSupportModal();
        }, 3000);
    } catch (error) {
        console.error('Support request error:', error);
        document.getElementById('supportError').textContent = 'حدث خطأ في إرسال الطلب';
        document.getElementById('supportError').style.display = 'block';
    } finally {
        hideLoading();
    }
}

// تحديث دالة عرض تفاصيل الحساب
function showDetails() {
    // Populate the details modal
    document.getElementById('detailsName').textContent = currentInvestor.name;
    document.getElementById('detailsCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
    document.getElementById('detailsExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
    document.getElementById('detailsTotalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
    document.getElementById('detailsTotalProfit').textContent = formatCurrency(currentCard.totalProfit || 0);
    document.getElementById('detailsDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
    document.getElementById('detailsPaidProfit').textContent = formatCurrency(currentCard.paidProfit || 0);
    
    // Set investment details
    document.getElementById('detailsInvestmentType').textContent = currentCard.investmentType || 'استثمار عام';
    
    // Set investment date (use 60 days ago if not available)
    const investmentDate = currentCard.investmentDate || 
        new Date(new Date().getTime() - 180 * 24 * 60 * 60 * 1000).toISOString();
    document.getElementById('detailsInvestmentDate').textContent = formatDate(investmentDate);
    
    // Set maturity date (use 300 days from investment date if not available)
    const maturityDate = currentCard.maturityDate || 
        new Date(new Date(investmentDate).getTime() + 300 * 24 * 60 * 60 * 1000).toISOString();
    document.getElementById('detailsMaturityDate').textContent = formatDate(maturityDate);
    
    // Show the modal
    document.getElementById('detailsModal').classList.add('active');
}

// Close details modal
function closeDetailsModal() {
    document.getElementById('detailsModal').classList.remove('active');
}

// Logout
function logout() {
    // Clear localStorage
    localStorage.removeItem('investorCard');
    localStorage.removeItem('investorData');
    
    currentInvestor = null;
    currentCard = null;
    
    // Reset forms
    document.getElementById('loginForm').reset();
    
    // Hide dashboard, show login
    document.getElementById('dashboardScreen').style.display = 'none';
    document.getElementById('bottomNav').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';
    
    // Clear any QR scanner
    if (qrScanner) {
        qrScanner.clear();
        qrScanner = null;
    }
    
    // Reset QR scanner UI
    document.getElementById('qr-scanner').style.display = 'none';
    document.getElementById('startScanBtn').style.display = 'block';
}

// Generate unique ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-IQ');
}

// Show loading
function showLoading() {
    document.getElementById('loadingScreen').style.display = 'flex';
}

// Hide loading
function hideLoading() {
    document.getElementById('loadingScreen').style.display = 'none';
}

// Show error
function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    setTimeout(() => errorElement.style.display = 'none', 5000);
}

// Clear errors
function clearErrors() {
    document.getElementById('errorMessage').style.display = 'none';
}

// تعزيز الاتصال بين الإشعارات والعمليات
function syncNotificationsWithOperations() {
    try {
        if (!currentCard || !currentCard.recentOperations) {
            return;
        }
        
        // تحويل جميع العمليات إلى إشعارات إذا لم يكن لديها إشعار بالفعل
        currentCard.recentOperations.forEach(operation => {
            // التحقق من عدم وجود إشعار بالفعل لهذه العملية
            const hasNotification = notifications.some(n => n.operation && n.operation.id === operation.id);
            
            if (!hasNotification) {
                // إنشاء إشعار من العملية
                const notification = createNotificationFromOperation(operation);
                
                if (notification) {
                    // إضافة الإشعار إلى مصفوفة الإشعارات
                    notifications.push(notification);
                    
                    // حفظ الإشعار في Firebase
                    database.ref(`${NOTIFICATIONS_PATH}/${notification.id}`).set(notification)
                        .catch(error => console.error('خطأ في حفظ الإشعار:', error));
                }
            }
        });
        
        // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
        if (document.getElementById('notificationsSection').style.display === 'block') {
            displayNotifications(notifications);
        }
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
    } catch (error) {
        console.error('خطأ في مزامنة الإشعارات مع العمليات:', error);
    }
}

// دالة لاستعادة البيانات المحذوفة أو لإصلاح مشاكل التخزين المحلي
function repairLocalStorage() {
    try {
        // التحقق من وجود بيانات في التخزين المحلي
        const savedCard = localStorage.getItem('investorCard');
        const savedInvestor = localStorage.getItem('investorData');
        
        if (!savedCard || !savedInvestor) {
            console.warn('بيانات التخزين المحلي غير متوفرة');
            return false;
        }
        
        // محاولة تحليل البيانات
        try {
            const card = JSON.parse(savedCard);
            const investor = JSON.parse(savedInvestor);
            
            // التحقق من صحة البيانات
            if (!card.id || !card.cardNumber || !investor.id || !investor.name) {
                console.warn('بيانات التخزين المحلي غير صالحة');
                return false;
            }
            
            // تعيين البيانات الصالحة
            currentCard = card;
            currentInvestor = investor;
            
            return true;
        } catch (error) {
            console.error('خطأ في تحليل بيانات التخزين المحلي:', error);
            
            // مسح البيانات غير الصالحة
            localStorage.removeItem('investorCard');
            localStorage.removeItem('investorData');
            
            return false;
        }
    } catch (error) {
        console.error('خطأ في إصلاح التخزين المحلي:', error);
        return false;
    }
}

// تحسين الأمان بتشفير البيانات المحلية
function secureLocalStorage() {
    // يمكن تنفيذ هذه الدالة لاحقًا عند الحاجة لتحسين الأمان
    // يمكن استخدام مكتبات مثل CryptoJS للتشفير
}

// الاستماع المستمر لتغييرات بيانات البطاقة
function listenForCardChanges() {
    if (!currentCard || !currentCard.id) {
        return;
    }
    
    const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
    
    // إزالة المستمعين السابقين
    cardRef.off();
    
    // إضافة مستمع جديد
    cardRef.on('value', (snapshot) => {
        const updatedCard = snapshot.val();
        
        if (updatedCard) {
            // تحديث البيانات المحلية
            currentCard = updatedCard;
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            
            // تحديث واجهة المستخدم
            updateDashboard();
        }
    });
}

// التحقق من حالة الاتصال بالإنترنت
function checkInternetConnection() {
    return navigator.onLine;
}

// معالجة حالة عدم الاتصال بالإنترنت
function handleOfflineMode() {
    if (!checkInternetConnection()) {
        // إظهار رسالة للمستخدم
        createNotification(
            'انقطاع الاتصال',
            'أنت حاليًا غير متصل بالإنترنت. سيتم استخدام البيانات المخزنة محليًا.',
            'warning'
        );
        
        // تعطيل الوظائف التي تتطلب اتصالًا بالإنترنت
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
    } else {
        // إعادة تفعيل الوظائف
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    }
}

// إضافة مستمع لحالة الاتصال
window.addEventListener('online', () => {
    // إعادة تفعيل الوظائف وتحديث البيانات
    createNotification('تم استعادة الاتصال', 'تم استعادة الاتصال بالإنترنت', 'success');
    refreshDashboard();
    handleOfflineMode();
});

window.addEventListener('offline', () => {
    // تفعيل وضع عدم الاتصال
    handleOfflineMode();
});

// التحقق من الجلسة منتهية الصلاحية
function checkSessionExpiry() {
    const loginTime = localStorage.getItem('loginTime');
    
    if (loginTime) {
        const now = new Date().getTime();
        const lastLogin = parseInt(loginTime);
        
        // تحقق مما إذا كانت قد مرت أكثر من 24 ساعة (مثال)
        if (now - lastLogin > 24 * 60 * 60 * 1000) {
            // تسجيل خروج تلقائي
            createNotification('انتهت الجلسة', 'انتهت صلاحية الجلسة. يرجى تسجيل الدخول مرة أخرى.', 'warning');
            logout();
            return true;
        }
    }
    
    return false;
}

// تحديث وقت تسجيل الدخول
function updateLoginTime() {
    localStorage.setItem('loginTime', new Date().getTime().toString());
}

// إضافة تحديث وقت تسجيل الدخول إلى دالة showDashboard
const originalShowDashboard = showDashboard;
window.showDashboard = function() {
    originalShowDashboard();
    updateLoginTime(); // تحديث وقت تسجيل الدخول
    
    // استماع لتغييرات البطاقة
    listenForCardChanges();
    
    // التحقق من حالة الاتصال
    handleOfflineMode();
    
    // تحديث عدد الإشعارات غير المقروءة
    updateUnreadCount();
    
    // مزامنة الإشعارات والعمليات
    syncNotificationsWithOperations();
};

// وظيفة الإعدادات المتقدمة (يمكن إضافتها في تحديث لاحق)
function openAdvancedSettings() {
    // عرض نافذة الإعدادات المتقدمة
    createNotification('غير متاح', 'الإعدادات المتقدمة غير متاحة حاليًا. سيتم إضافتها في تحديث قادم.', 'info');
}

// تهيئة تلقائية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // التحقق من انتهاء صلاحية الجلسة
    if (checkSessionExpiry()) {
        return; // لا تكمل إذا كانت الجلسة منتهية الصلاحية
    }
    
    // محاولة إصلاح التخزين المحلي إذا لزم الأمر
    if (!currentInvestor && !currentCard) {
        repairLocalStorage();
    }
    
    // التحقق من حالة الاتصال
    handleOfflineMode();
});

// تعريف السلوك العام للإغلاق عند النقر خارج النوافذ المنبثقة
document.addEventListener('click', function(event) {
    // إغلاق النوافذ المنبثقة عندما يتم النقر خارجها
    const modals = document.querySelectorAll('.modal.active');
    
    modals.forEach(modal => {
        // التحقق من أن النقرة كانت خارج مربع الحوار وعلى الطبقة الخلفية
        if (event.target === modal && !modal.id.includes('loadingScreen')) {
            // الحصول على دالة الإغلاق المناسبة للنافذة المنبثقة
            if (modal.id === 'withdrawModal') {
                closeWithdrawModal();
            } else if (modal.id === 'supportModal') {
                closeSupportModal();
            } else if (modal.id === 'detailsModal') {
                closeDetailsModal();
            } else if (modal.id === 'notificationDetailsModal') {
                closeNotificationDetailsModal();
            }
        }
    });
});

// استدعاء وظائف البدء النهائية
(function initialize() {
    // تعيين الوظائف في النافذة العالمية للاستخدام من HTML
    window.switchTab = switchTab;
    window.loginWithCard = loginWithCard;
    window.startQRScan = startQRScan;
    window.decodeQRFromImage = decodeQRFromImage;
    window.refreshDashboard = refreshDashboard;
    window.switchSection = switchSection;
    window.openWithdrawModal = openWithdrawModal;
    window.closeWithdrawModal = closeWithdrawModal;
    window.submitWithdrawRequest = submitWithdrawRequest;
    window.showDetails = showDetails;
    window.closeDetailsModal = closeDetailsModal;
    window.showContactSupport = showContactSupport;
    window.closeSupportModal = closeSupportModal;
    window.submitSupportRequest = submitSupportRequest;
    window.filterTransactions = filterTransactions;
    window.logout = logout;
    window.closeNotificationDetailsModal = closeNotificationDetailsModal;
})();




</script>
</body>
</html>
