<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محفظة المستثمر | سما بابل للاستثمار</title>
    
    <!-- Font Awesome Icons -->


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBTcAov7iclfvVAa52jp3AzqHtxqVnatuk" async defer></script>




    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Tajawal for Arabic UI -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="style.css" rel="stylesheet" />

    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        /* ===== COLORS & THEME ===== */
        :root {
            --bg-dark: #0d1117;
            --bg-card: #111827;
            --gold: #FFC436;
            --gold-light: rgba(255, 196, 54, 0.1);
            --gold-medium: rgba(255, 196, 54, 0.3);
            --gold-bright: rgba(255, 196, 54, 0.8);
            --text-white: #ffffff;
            --text-light: rgba(255, 255, 255, 0.7);
            --text-dark: #000000;
            --red: #ff5252;
            --green: #4CAF50;
            --blue: #2196F3;
            --border-radius-sm: 10px;
            --border-radius-md: 16px;
            --border-radius-lg: 20px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

        /* تعديل خلفية الجسم بالكامل */
        body {
            background-color: var(--bg-dark); /* لون احتياطي في حال لم تظهر الصورة */
            background-image: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed; /* جعل الخلفية ثابتة عند التمرير */
            background-repeat: no-repeat;
            color: var(--gold);
            line-height: 1.5;
        }
        
        /* إضافة طبقة شفافة فوق الخلفية للتباين وتحسين مقروئية العناصر */
        .app-container {
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            position: relative;
            overflow-x: hidden;
            background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
            backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
            height: 100vh; /* Full screen height */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }

        /* تحديث شامل لتثبيت شريط الأدوات والعناوين */

        /* إعادة ضبط حاوية التطبيق للتعامل مع التمرير بشكل أفضل */
        .app-container {
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            position: fixed; /* تثبيت الحاوية الرئيسية */
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden; /* منع التمرير على مستوى الحاوية */
            background-color: rgba(13, 17, 23, 0.85);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        /* إعادة تصميم الشريط العلوي للتثبيت الكامل */
        .header {
            position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 196, 54, 0.2);
            padding: 15px 0;
            height: 60px; /* تحديد ارتفاع ثابت */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* إعادة تصميم شريط الأدوات السفلي للتثبيت الكامل */
        .bottom-nav {
            position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            padding: 12px 0 8px;
            height: 60px; /* تحديد ارتفاع ثابت */
        }

        /* إعادة تصميم منطقة المحتوى الرئيسية للتمرير بشكل صحيح */
        .dashboard {
            flex: 1; /* يأخذ المساحة المتبقية */
            position: relative;
            overflow: hidden;
            margin-top: 60px; /* مساحة للشريط العلوي */
            margin-bottom: 60px; /* مساحة للشريط السفلي */
            height: calc(100% - 120px); /* الارتفاع الكلي ناقص ارتفاع الشريطين */
        }

        /* تعديل هيكل الأقسام المختلفة للتمرير المناسب */
        #homeSection, 
        #profileSection, 
        #transactionsSection, 
        #cardSection,
        #investmentsSection,
        #notificationsSection {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto; /* تفعيل التمرير العمودي */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; /* تمرير سلس على الأجهزة التي تعمل باللمس */
            padding: 15px 0 30px; /* تباعد أعلى وأسفل المحتوى */
            display: none; /* سيتم تفعيله عبر JavaScript */
            height: 100%; /* ارتفاع كامل */
        }

        /* إظهار القسم النشط */
        #homeSection.active, 
        #profileSection.active, 
        #transactionsSection.active, 
        #cardSection.active,
        #investmentsSection.active,
        #notificationsSection.active {
            display: block;
        }

        /* معالجة المودالات لضمان تموضعها بشكل صحيح */
        .modal {
            z-index: 2000;
        }

        /* معالجة شاشة التحميل */
        .loading {
            z-index: 3000;
        }

        /* معالجة تمرير جسم الصفحة */
        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        /* تأكيد تموضع زر التحديث بشكل صحيح */
        .refresh-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
        }

        /* تعديلات للشاشات الصغيرة */
        @media (max-height: 600px) {
            .header {
                padding: 10px 0;
                height: 50px;
            }
            
            .bottom-nav {
                padding: 8px 0 5px;
                height: 50px;
            }
            
            .dashboard {
                margin-top: 50px;
                margin-bottom: 50px;
                height: calc(100% - 100px);
            }
        }

        /* تعديل أنماط العناصر المتنقلة في الشريط السفلي */
        .nav-item {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* إصلاح مشكلة شاشة تسجيل الدخول */
        .login-screen {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1500;
        }

        /* تعديلات خاصة بمنطقة البطاقة والمعلومات */
        .credit-card, .info-cards, .actions, .transactions {
            padding-left: 15px;
            padding-right: 15px;
        }

        /* منع وجود فراغات زائدة في أسفل المحتوى */
        .transactions {
            margin-bottom: 0;
            padding-bottom: 20px;
        }

        /* تبسيط تباعد العناصر */
        .section-title {
            margin-top: 15px;
        }

        /* تعديل لحل مشكلة التمرير في نهاية الصفحة */
        #transactionsList, #filteredTransactionsList, #notificationsList {
            padding-bottom: 30px; /* ضمان وجود مساحة كافية في نهاية القوائم */
        }

        /* تعديل خلفيات العناصر الفرعية لتكون شبه شفافة */
        .header, 
        .bottom-nav, 
        .login-screen,
        .dashboard,
        .profile-section,
        .transactions-section,
        .notifications-section,
        .card-section,
        .investments-section {
            background-color: transparent; /* إزالة الخلفية ليظهر التأثير */
        }

        /* جعل بعض العناصر مثل البطاقات والنوافذ المنبثقة أكثر وضوحًا */
        .credit-card,
        .info-card,
        .transaction-item,
        .notification-item,
        .modal-content,
        .account-details,
        .form-control {
            background-color: rgba(17, 24, 39, 0.8); /* خلفية داكنة شبه شفافة */
            backdrop-filter: blur(8px); /* تأثير ضبابي أقوى */
            border: 1px solid rgba(255, 196, 54, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* تعديل زر التحديث والأزرار الإضافية لتكون أكثر وضوحًا */
        .refresh-btn,
        .nav-item {
            background-color: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(5px);
        }

        /* تحديث نمط البطاقة لإضافة صورة الخلفية */
        .credit-card {
            width: 100%;
            aspect-ratio: 1.6/1;
            background: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445') no-repeat center center;
            background-size: cover;
            border-radius: var(--border-radius-lg);
            padding: 24px;
            position: relative;
            overflow: hidden;
            margin: 0 auto 25px;
            border: 1px solid rgba(255, 196, 54, 0.3);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* تعديل طبقة التراكب لتناسب لون الخلفية الجديدة */
        .credit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%);
            z-index: 1;
            pointer-events: none;
        }

        /* تحسين لون النصوص لتكون مقروءة على الخلفية الجديدة */
        .card-number,
        .card-company,
        .card-info-label,
        .card-info-value,
        .card-logo,
        .card-provider {
            color: var(--gold);
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.7);
            position: relative;
            z-index: 2;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .card-chip {
            width: 45px;
            height: 35px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 8px;
            margin-right: auto;
        }

        .card-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-provider {
            width: 60px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--gold);
            font-size: 0.9rem;
        }

        .card-number {
            font-size: 1.8rem;
            color: var(--gold);
            letter-spacing: 2px;
            text-align: center;
            margin: 10px 0 20px;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }

        .card-holder-name {
            font-size: 1.1rem;
            color: var(--gold);
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .card-company {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 2;
        }

        .card-info-item {
            position: relative;
            z-index: 2;
        }

        .card-info-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .card-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
        }

        /* ===== INFO CARDS ===== */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .info-card h3 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .info-card p {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: var(--gold);
        }

        /* ===== ACTION BUTTONS ===== */
        .actions {
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            color: var(--gold);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .action-btn:hover {
            background: var(--gold-light);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .action-btn i {
            font-size: 1.3rem;
        }

        /* ===== TRANSACTIONS ===== */
        .transactions {
            padding: 5px 15px 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-white);
            font-size: 0.95rem;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .transaction-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-right: 5px;
        }

        .transaction-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-white);
            text-align: left;
            direction: ltr;
        }

        .transaction-amount.positive {
            color: var(--gold);
        }

        .transaction-amount.negative {
            color: var(--red);
        }

       /* تعديل رأس التطبيق */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background-color: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 196, 54, 0.2);
            padding: 15px 0;
            max-width: 430px;
            margin: 0 auto;
        }

        /* تعديل قائمة التنقل السفلية */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            padding: 12px 0 8px;
            max-width: 430px;
            margin: 0 auto;
        }

        /* تحسين التباين لتحسين مقروئية النصوص */
        h1, h2, h3, .section-title, .profile-name, .card-number, .card-company {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* تعديل شاشة تسجيل الدخول لتكون متوافقة مع الخلفية الجديدة */
        .login-screen {
            background-color: rgba(13, 17, 23, 0.85);
            backdrop-filter: blur(5px);
        }

        /* تعديل طبقة التحميل */
        .loading {
            background-color: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            color: var(--gold);
        }

        .header-user {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 3px;
        }

        .refresh-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--gold-light);
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 8px;
            max-width: 430px;
            margin: 0 auto;
        }

        .nav-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-light);
            width: 70px;
            position: relative; /* Added for notification badge positioning */
        }

        .nav-item.active {
            color: var(--gold);
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            padding: 40px 20px;
            text-align: center;
            background-color: var(--bg-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(255, 196, 54, 0.3);
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--bg-dark);
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 196, 54, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            color: var(--gold);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--text-white);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 196, 54, 0.3);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--gold);
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--bg-dark);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold);
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(255, 196, 54, 0.2);
        }

        /* ===== QR Scanner ===== */
        #qr-scanner {
            width: 100%;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            display: none;
        }

        .img-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #qr-file-selector {
            display: none;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            display: none;
            padding-bottom: 80px;
            background-color: var(--bg-dark);
        }

        /* ===== PROFILE SECTION ===== */
        .profile-section {
            padding: 20px 15px;
            display: none;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            background: var(--gold);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--bg-dark);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.2);
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .profile-card {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .account-details {
            background: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-top: 10px;
            border: 1px solid rgba(255, 196, 54, 0.2);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-white);
        }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--red);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: rgba(255, 82, 82, 0.2);
            border-color: var(--red);
        }

        /* ===== TRANSACTIONS SECTION ===== */
        .transactions-section {
            padding: 20px 15px;
            display: none;
        }

        .transaction-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none; /* Firefox */
        }

        .transaction-filter::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.2);
            border-radius: 30px;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
            font-weight: 600;
        }

        .transaction-date-header {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        /* ===== NOTIFICATIONS SECTION ===== */
        .notifications-section {
            padding: 20px 15px;
            display: none;
        }

        .notification-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .notification-item.unread {
            border-right: 3px solid var(--gold);
        }

        .notification-item.new-notification::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold) 0%, transparent 50%);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--gold);
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-white);
            margin-bottom: 5px;
        }

        .notification-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .notification-amount {
            font-weight: 700;
            color: var(--gold);
            margin-top: 5px;
        }

        .notification-status {
            font-size: 0.8rem;
            margin-top: 2px;
        }

        .notification-status.pending {
            color: var(--gold);
        }

        .notification-status.completed {
            color: var(--green);
        }

        .notification-status.rejected {
            color: var(--red);
        }

        /* Notification Badge */
        .notification-count {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 16px;
            height: 16px;
            background-color: var(--red);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .notification-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: var(--red);
            border-radius: 50%;
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            position: relative;
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 196, 54, 0.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--gold);
            font-size: 1rem;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MESSAGES ===== */
        .error-message {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            color: var(--red);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--green);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        /* Card display in withdraw form */
        .card-display {
            background-color: rgba(17, 24, 39, 0.8);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-number-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .form-help-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .alert-container {
            margin-bottom: 15px;
        }

        .form-notice {
            background-color: rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .form-notice i {
            color: var(--gold);
            font-size: 1.1rem;
        }

        /* Notification Toast */
        .notification-toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
            direction: rtl;
        }

        .notification-toast {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--bg-card);
            border: 1px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s, transform 0.3s;
        }

        .notification-toast.hiding {
            opacity: 0;
            transform: translateY(-20px);
        }

        .notification-toast.info {
            border-color: var(--blue);
        }

        .notification-toast.success {
            border-color: var(--green);
        }

        .notification-toast.warning {
            border-color: var(--gold);
        }

        .notification-toast.danger {
            border-color: var(--red);
        }

        .notification-toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-toast-title {
            font-weight: bold;
            color: var(--gold);
        }

        .notification-toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            color: var(--text-light);
            cursor: pointer;
        }

        .notification-toast-body {
            font-size: 0.9rem;
            color: var(--text-white);
        }

        /* إضافات جديدة للتصميم المحسن */
        
        /* تعديل شكل زر البحث */
        .search-icon-container {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 196, 54, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .search-icon-container:hover {
            background: rgba(255, 196, 54, 0.1);
        }
        
        /* خانة البحث الجديدة */
        .search-container {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            background: rgba(17, 24, 39, 0.95);
            padding: 15px;
            z-index: 90;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s ease;
            visibility: hidden;
            border-bottom: 1px solid rgba(255, 196, 54, 0.2);
        }
        
        .search-container.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: 30px;
            color: var(--text-white);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        
        .search-input i {
            margin-left: 10px;
            color: var(--gold);
        }
        
        .search-input input {
            background: transparent;
            border: none;
            color: var(--text-white);
            outline: none;
            width: 100%;
        }
        
        .search-input input::placeholder {
            color: var(--text-light);
        }
        
        /* زر إضافة مشروع جديد */
        .add-project-btn {
            position: fixed;
            bottom: 75px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gold);
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 90;
        }
        
        .add-project-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        /* أنماط إضافية خاصة بإدارة المشاريع */
        .admin-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }
        
        .admin-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            color: var(--text-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            background: rgba(255, 196, 54, 0.8);
            color: var(--bg-dark);
        }
        
        .admin-btn.edit {
            background: rgba(33, 150, 243, 0.6);
        }
        
        .admin-btn.delete {
            background: rgba(255, 82, 82, 0.6);
        }
        
        /* تصميم نافذة إضافة وتعديل المشاريع */
        .modal-content.large {
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: var(--border-radius-sm);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin-bottom: 15px;
            border: 1px dashed var(--gold-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
        }
        
        .image-preview i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .image-preview-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .text-editor {
            min-height: 150px;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(17, 24, 39, 0.5);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--text-white);
        }
        
        /* تحسينات على الأقسام الموجودة */
        
        /* الصفحة الرئيسية - تحسين عرض المشاريع */
        .projects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        /* تعديل نمط التصنيفات */
        .categories-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .categories-wrapper {
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 5px;
        }
        
        .categories-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            white-space: nowrap;
        }
        
        .categories-action {
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .add-category-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 196, 54, 0.2);
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-category-btn:hover {
            background: rgba(255, 196, 54, 0.3);
        }
        
        /* قسم إحصائيات الاستثمار (المنقول للبطاقة) */
        .stats-section {
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header .section-title {
            margin-bottom: 0;
        }
        
        .view-all {
            font-size: 0.8rem;
            color: var(--text-light);
            text-decoration: none;
        }
        
        /* تعديل الأكشن بتنس */
        .button-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .button-action {
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .button-action:hover {
            background: var(--gold-light);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }
        
        .button-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 196, 54, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            font-size: 1.3rem;
        }
        
        .button-action-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-white);
            text-align: center;
        }
        
        /* تعديل النشاطات الحديثة */
        .activities-section {
            margin-bottom: 30px;
        }
        
        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 360px) {
            .card-number {
                font-size: 1.5rem;
            }
            
            .info-card {
                padding: 12px 10px;
            }
            
            .info-card h3 {
                font-size: 0.8rem;
            }
            
            .info-card p {
                font-size: 1.1rem;
            }
            
            .transaction-item {
                padding: 10px 12px;
            }
            
            .transaction-icon {
                width: 36px;
                height: 36px;
                margin-left: 10px;
            }
            
            .transaction-type {
                font-size: 0.85rem;
            }
            
            .transaction-amount {
                font-size: 0.95rem;
            }
        }

        /* Adjust app container for fixed header and footer */
        .app-container {
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            position: relative;
            overflow-x: hidden;
            background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
            backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
            height: 100vh; /* Full screen height */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }

        /* Fix the header at the top */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background-color: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 196, 54, 0.2);
            padding: 15px 0;
            max-width: 430px;
            margin: 0 auto;
        }

        /* Fix the bottom navigation at the bottom */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            padding: 12px 0 8px;
            max-width: 430px;
            margin: 0 auto;
        }

        /* Allow scrolling for the main content */
        #homeSection,
        #profileSection,
        #transactionsSection,
        #cardSection,
        #investmentsSection,
        #notificationsSection {
            padding-top: 65px; /* Space for the fixed header */
            padding-bottom: 70px; /* Space for the fixed footer */
            overflow-y: auto; /* Enable vertical scrolling */
            height: 100vh; /* Full screen height */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for touch devices */
        }

        /* Prevent body scrolling */
        body {
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Smooth transitions for header and footer */
        .header, .bottom-nav {
            transition: transform 0.3s ease;
        }

        /* Optional: Hide header when scrolling down */
        .header.hidden {
            transform: translateY(-100%);
        }

        /* Optional: Hide footer when scrolling up */
        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        /* Adjust refresh button position */
        .refresh-btn {
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 101;
        }

        /* Adjust modal z-index */
        .modal {
            z-index: 2000;
        }

        /* Adjust loading screen z-index */
        .loading {
            z-index: 3000;
        }

        /* === قواعد إضافية لمعالجة المشاكل الشائعة === */

        /* تأكد من أن محتوى القوائم يمكن التمرير إليه بالكامل */
        #transactionsList, 
        #filteredTransactionsList,
        #notificationsList {
            padding-bottom: 40px;
        }

        /* تعديل حجم ونسبة النوافذ المنبثقة */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            width: 92%;
            max-width: 380px;
        }

        /* تحسين حجم النصوص في النماذج */
        .form-label {
            font-size: 0.8rem;
        }

        .form-control {
            padding: 12px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 12px;
            font-size: 0.95rem;
        }

        /* تصحيح للمشكلة الشائعة في الشاشات الطويلة حيث تختفي العناصر السفلية */
        .dashboard {
            height: calc(100vh - 112px); /* 56px للشريط العلوي + 56px للشريط السفلي */
            margin-top: 56px;
            margin-bottom: 56px;
        }

        /* تعديل أقسام التطبيق للعرض المناسب */
        #homeSection, 
        #profileSection, 
        #transactionsSection, 
        #cardSection,
        #investmentsSection,
        #notificationsSection {
            height: 100%;
            overflow-y: auto;
            padding-top: 0;
            padding-bottom: 20px;
        }

        /* إصلاحات إضافية لضمان عرض جميع العناصر */

        /* تعديل التخطيط العام للتطبيق */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden;
            background-color: rgba(13, 17, 23, 0.85);
        }

        /* ضبط حاوية المحتوى الرئيسية */
        .dashboard {
            flex: 1;
            overflow: hidden;
            position: relative;
            margin-top: 56px; /* ارتفاع الشريط العلوي */
            margin-bottom: 56px; /* ارتفاع الشريط السفلي */
            height: calc(100% - 112px); /* 100% - (ارتفاع الشريط العلوي + ارتفاع الشريط السفلي) */
        }

        /* تعديل الأقسام */
        #homeSection, 
        #profileSection, 
        #transactionsSection, 
        #cardSection,
        #investmentsSection,
        #notificationsSection {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0 20px;
            display: none;
        }

        /* إظهار القسم النشط */
        #homeSection.active, 
        #profileSection.active, 
        #transactionsSection.active, 
        #cardSection.active,
        #investmentsSection.active,
        #notificationsSection.active {
            display: block;
        }

        /* معالجة الشريط العلوي */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 430px;
            margin: 0 auto;
        }

        /* معالجة الشريط السفلي */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 56px;
            display: flex;
            justify-content: space-around;
            max-width: 430px;
            margin: 0 auto;
        }
        
        /* تصميم بطاقة المشروع مع الصورة والنص */
        .project-card {
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 196, 54, 0.2);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            position: relative;
        }

        .project-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        }

        .project-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            color: white;
            text-align: right;
        }

        .project-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
        }

        .project-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
        }
        
        .project-avatar {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gold);
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
        }

        /* أنماط الصفحة الرئيسية الجديدة */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            padding: 0 15px;
        }

        .welcome-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
        }

        .welcome-subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 3px;
        }

        .home-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
            margin: 25px 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }

        .featured-cards {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 15px;
            padding: 0 15px 10px;
            scrollbar-width: none;
            margin-bottom: 15px;
        }

        .featured-cards::-webkit-scrollbar {
            display: none;
        }

        .featured-card {
            scroll-snap-align: start;
            min-width: 250px;
            height: 150px;
            background-color: rgba(17, 24, 39, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(255, 196, 54, 0.3);
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .featured-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gold);
        }

        .featured-card-description {
            font-size: 0.8rem;
            color: var(--text-light);
            margin: 5px 0;
        }

        .featured-card-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .stats-item {
            text-align: center;
        }

        .stats-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold);
        }

        .stats-label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            padding: 0 15px;
        }

        .quick-action-btn {
            background-color: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-action-btn:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            font-size: 1.3rem;
        }

        .quick-action-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-white);
            text-align: center;
        }

        .recent-activity {
            margin-top: 25px;
            padding: 0 15px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background-color: rgba(17, 24, 39, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 196, 54, 0.1);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            margin-left: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 3px;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .activity-amount {
            font-weight: 700;
            color: var(--gold);
            text-align: left;
            direction: ltr;
        }

        /* تطبيق العناصر الإضافية للتصميم الجديد */
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-dark);
            box-shadow: 0 3px 8px rgba(255, 196, 54, 0.3);
        }
        
        /* الصفحة الرئيسية المعدلة - أزرار الإدارة للمشرف */
        .admin-mode-switch {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 24px;
            background: rgba(17, 24, 39, 0.8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 0 2px;
            cursor: pointer;
            z-index: 5;
        }
        
        .admin-mode-switch .toggle {
            width: 20px;
            height: 20px;
            background: var(--text-light);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .admin-mode-switch.active .toggle {
            transform: translateX(16px);
            background: var(--gold);
        }
        
        /* إضافة قائمة منسدلة لإدارة المشاريع */
        .admin-dropdown {
            position: absolute;
            top: 60px;
            left: 15px;
            background: rgba(17, 24, 39, 0.95);
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(255, 196, 54, 0.3);
            padding: 10px 0;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .admin-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .admin-dropdown-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-dropdown-item:hover {
            background: rgba(255, 196, 54, 0.1);
            color: var(--gold);
        }
        
        .admin-dropdown-item i {
            width: 20px;
            text-align: center;
            color: var(--gold);
        }


        /* تحسين أسلوب شريط التصنيفات */
.categories-container {
    margin-bottom: 20px;
    background-color: rgba(17, 24, 39, 0.4);
    border-radius: 15px;
    padding: 10px;
    border: 1px solid rgba(255, 196, 54, 0.15);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.categories-wrapper {
    padding: 3px 5px;
}

.filter-tabs {
    display: flex;
    gap: 8px;
    white-space: nowrap;
    padding: 2px;
}

.filter-tab {
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 196, 54, 0.2);
    border-radius: 20px;
    color: var(--text-light);
    white-space: nowrap;
    transition: all 0.3s ease;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    min-width: auto;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.filter-tab:hover {
    background: rgba(255, 196, 54, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.filter-tab.active {
    background: var(--gold);
    color: var(--bg-dark);
    border-color: var(--gold);
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(255, 196, 54, 0.3);
}

/* تعديل زر إضافة التصنيف ليتناسب مع التصميم الجديد */
.add-category-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 196, 54, 0.2);
    color: var(--gold);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-right: 5px;
}

.add-category-btn:hover {
    background: rgba(255, 196, 54, 0.4);
    transform: rotate(90deg);
}


.project-stages {
    display: flex;
    align-items: center;
    margin: 15px 0;
}
.stage-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.stage-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--gold);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 5px;
    color: var(--text-light);
}
.stage-circle.active {
    background-color: var(--gold);
    color: var(--bg-dark);
}
.stage-line {
    flex: 1;
    height: 2px;
    background-color: rgba(255, 255, 255, 0.1);
    margin: 0 5px;
}
.stage-line.active {
    background-color: var(--gold);
}
.stage-label {
    font-size: 0.8rem;
    color: var(--text-light);
    max-width: 70px;
}

/* تنسيق مقرات الشركة */
.office-card {
    background: var(--bg-card);
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--gold-medium);
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.office-card:hover {
    border-color: var(--gold);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
}

/* تنسيق الخريطة */
#investmentMap {
    border: 1px solid var(--gold-medium);
    background-color: rgba(17, 24, 39, 0.8);
}

/* تنسيق أزرار التحكم في الخريطة */
#adminMapControls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

/* تنسيق للمعلومات في نافذة الخريطة */
.marker-info-window {
    direction: rtl; 
    text-align: right; 
    padding: 10px;
    font-family: 'Tajawal', sans-serif;
}

.marker-info-window h3 {
    color: #1a73e8; 
    margin-bottom: 8px;
    font-size: 16px;
    font-weight: 600;
}

.marker-info-window p {
    margin-bottom: 5px;
    font-size: 14px;
}

/* تنسيق للعناوين في صفحة تفاصيل المشروع */
.section-subtitle {
    color: var(--gold);
    margin-bottom: 10px;
    font-size: 1.1rem;
    font-weight: 600;
}

/* تنسيق للمخاطر المحتملة */
.risk-item {
    margin-bottom: 8px;
    color: var(--text-light);
    display: flex;
    align-items: flex-start;
}

.risk-item i {
    color: var(--gold);
    margin-left: 8px;
    margin-top: 2px;
}

/* تنسيق لمراحل المشروع المتقدمة */
.timeline-container {
    margin: 20px 0;
    position: relative;
}

.timeline-line {
    position: absolute;
    right: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: rgba(255, 196, 54, 0.3);
}

.timeline-item {
    position: relative;
    padding-right: 40px;
    margin-bottom: 20px;
}

.timeline-dot {
    position: absolute;
    right: 11px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: var(--gold);
}

.timeline-dot.active {
    background-color: var(--gold);
}

.timeline-dot.inactive {
    background-color: rgba(255, 255, 255, 0.2);
}

.timeline-content {
    background-color: rgba(17, 24, 39, 0.5);
    border: 1px solid rgba(255, 196, 54, 0.2);
    border-radius: var(--border-radius-sm);
    padding: 10px;
}

.timeline-date {
    font-size: 0.8rem;
    color: var(--gold);
    margin-bottom: 5px;
}

.timeline-title {
    font-weight: 600;
    color: var(--text-white);
    margin-bottom: 5px;
}

.timeline-description {
    font-size: 0.9rem;
    color: var(--text-light);
}

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div class="loading" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">جاري التحميل...</div>
        </div>

        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="logo">
                <i class="fas fa-gem"></i>
            </div>
            
            <h2 style="margin-bottom: 30px; color: var(--gold); font-weight: 800;">سما بابل للاستثمار</h2>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('cardTab')">
                    <i class="fas fa-credit-card"></i> البطاقة
                </button>
                <button class="tab-btn" onclick="switchTab('qrTab')">
                    <i class="fas fa-qrcode"></i> QR Code
                </button>
            </div>

            <div id="errorMessage" class="error-message"></div>
            
            <div id="cardTab" class="tab-content active">
                <form id="loginForm" onsubmit="loginWithCard(event)">
                    <div class="form-group">
                        <label class="form-label">رقم البطاقة</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ الانتهاء</label>
                        <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رمز الأمان (CVV)</label>
                        <input type="password" class="form-control" id="cvv" placeholder="XXX" maxlength="3" required>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-sign-in-alt"></i> دخول
                    </button>
                </form>
            </div>
            
            <div id="qrTab" class="tab-content">
                <div id="qr-scanner"></div>
                <button id="startScanBtn" class="btn" onclick="startQRScan()">
                    <i class="fas fa-camera"></i> مسح رمز QR
                </button>
                
                <label for="qr-file-selector" class="btn btn-secondary img-upload-btn" style="margin-top: 15px;">
                    <i class="fas fa-upload"></i> تحميل صورة الباركود
                </label>
                <input type="file" id="qr-file-selector" accept="image/*" onchange="decodeQRFromImage(this.files[0])">
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="dashboard" id="dashboardScreen">
            <!-- Header -->
            <div class="header">
                <div id="headerTitle">
                    <h1 id="sectionTitle">مشاريع الاستثمار</h1>
                    <div class="header-user" id="headerUsername">مرحباً، المستثمر</div>
                </div>
                <button class="refresh-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <!-- أيقونة البحث -->
            <div class="search-icon-container" id="searchIcon" onclick="toggleSearch()">
                <i class="fas fa-search"></i>
            </div>
            
            <!-- خانة البحث القابلة للتوسيع -->
            <div class="search-container" id="searchContainer">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="البحث عن مشاريع..." oninput="searchProjects(this.value)">
                </div>
            </div>

            <!-- Home Section (New main screen) -->
            <div id="homeSection">
                <!-- صفحة مشاريع الاستثمار (صفحة الرئيسية) -->
                <div class="user-header">
                    <div>
                        <div class="welcome-text" id="welcomeText">مرحباً، المستثمر</div>
                        <div class="welcome-subtitle">استكشف مشاريع الاستثمار المتاحة</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">م</div>
                    
                    <!-- مفتاح وضع المشرف (مخفي للمستخدم العادي) -->
                    <div class="admin-mode-switch" id="adminModeSwitch" onclick="toggleAdminMode()">
                        <div class="toggle"></div>
                    </div>
                </div>
                
                <!-- قائمة منسدلة لإدارة المشاريع (تظهر للمشرف فقط) -->
                <div class="admin-dropdown" id="adminDropdown">
                    <div class="admin-dropdown-item" onclick="openAddCategoryModal()">
                        <i class="fas fa-folder-plus"></i>
                        <span>إضافة تصنيف جديد</span>
                    </div>
                    <div class="admin-dropdown-item" onclick="openManageCategoriesModal()">
                        <i class="fas fa-tasks"></i>
                        <span>إدارة التصنيفات</span>
                    </div>
                    <div class="admin-dropdown-item" onclick="openAddProjectModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>إضافة مشروع جديد</span>
                    </div>
                    <div class="admin-dropdown-item" onclick="toggleProjectEditMode()">
                        <i class="fas fa-edit"></i>
                        <span>تحرير المشاريع</span>
                    </div>
                </div>
                
                <!-- تصنيفات المشاريع -->
                <div class="categories-container">
                    <div class="categories-wrapper">
                        <div class="filter-tabs" id="projectCategories">
                            <div class="filter-tab active" data-category="all" onclick="filterProjects('all')">الكل</div>
                            <!-- سيتم إضافة التصنيفات ديناميكياً -->
                        </div>
                    </div>
                    <div class="categories-action" id="categoriesAction" style="display: none;">
                        <div class="add-category-btn" onclick="openAddCategoryModal()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>
                
                <!-- حاوية المشاريع - سيتم ملؤها ديناميكياً -->
                <div class="projects-grid" id="projectsGrid">
                    <!-- سيتم إضافة المشاريع هنا ديناميكياً من Firebase -->
                </div>
                
                <!-- زر إضافة مشروع جديد (يظهر للمشرف فقط) -->
                <div class="add-project-btn" id="addProjectBtn" onclick="openAddProjectModal()" style="display: none;">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            
            <!-- Card Section (محفظة المستثمر) -->
            <div id="cardSection">
                <!-- عرض البطاقة -->
                <div style="padding: 10px 10px 0;">
                    <div class="credit-card">
                        <div class="card-header">
                            <div class="card-chip"></div>
                            <div class="card-provider">INVESTOR</div>
                        </div>
                        <div class="card-number" id="displayCardNumber">2750 2380 1584 5063</div>
                        <div class="card-company" id="cardCompanyName">سما بابل للاستثمار</div>
                        <div class="card-info">
                            <div class="card-info-item">
                                <div class="card-info-label">الأرباح المستحقة</div>
                                <div class="card-info-value" id="cardDueProfit">1,458.333 د.ع</div>
                            </div>
                            <div class="card-info-item">
                                <div class="card-info-label">تاريخ الاستحقاق</div>
                                <div class="card-info-value" id="displayExpiryDate">05/27</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- معلومات الحساب -->
                <div class="info-cards">
                    <div class="info-card">
                        <h3>إجمالي المدفوع</h3>
                        <p id="totalInvestment">4,000.00 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>الأرباح المستحقة</h3>
                        <p id="dueProfit">51,036.03 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>تاريخ الاستحقاق</h3>
                        <p id="maturityDate">05/27</p>
                    </div>
                    <div class="info-card">
                        <h3>حالة الاستثمار</h3>
                        <p id="investmentStatus">نشط</p>
                    </div>
                </div>

                <!-- قسم إحصائيات الاستثمار (منقول من الصفحة الرئيسية) -->
                <div class="stats-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-chart-line"></i> إحصائيات استثماراتك
                        </h2>
                    </div>
                    
                    <div class="button-actions">
                        <div class="button-action" onclick="openWithdrawModal()">
                            <div class="button-action-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="button-action-label">طلب سحب</div>
                        </div>
                        <div
<div class="button-action" onclick="showDetails()">
                            <div class="button-action-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="button-action-label">تفاصيل الحساب</div>
                        </div>
                    </div>
                </div>

                <!-- قسم آخر النشاطات (منقول من الصفحة الرئيسية) -->
                <div class="activities-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-history"></i> آخر النشاطات
                        </h2>
                        <a href="#" class="view-all" onclick="switchSection('transactions')">عرض الكل</a>
                    </div>
                    
                    <div class="recent-activity" id="recentActivities">
                        <!-- سيتم تعبئة هذا القسم من خلال JavaScript -->
                    </div>
                </div>

                <!-- أزرار الإجراءات الأصلية -->
                <div class="actions">
                    <button class="action-btn" onclick="openWithdrawModal()">
                        <i class="fas fa-money-check-alt"></i> طلب سحب
                    </button>
                    <button class="action-btn" onclick="showDetails()">
                        <i class="fas fa-file-alt"></i> تفاصيل الحساب
                    </button>
                </div>

                <!-- آخر المعاملات الأصلية -->
                <div class="transactions">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i> آخر المعاملات
                    </h2>
                    <div id="transactionsList">
                        <!-- Transactions will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div class="profile-section" id="profileSection">
                <h2 class="section-title">
                    <i class="fas fa-user"></i> الملف الشخصي
                </h2>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">خالد السعدي</div>
                    <div class="profile-card" id="profileCardNumber">2750 2380 1584 5063</div>
                </div>
                
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">الاسم الكامل</div>
                        <div class="detail-value" id="profileFullName">خالد السعدي</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف</div>
                        <div class="detail-value" id="profilePhone">07701234567</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">البريد الإلكتروني</div>
                        <div class="detail-value" id="profileEmail">khalid@example.com</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانضمام</div>
                        <div class="detail-value" id="profileJoinDate">10/01/2024</div>
                    </div>
                </div>
                
                <button class="btn" style="margin-top: 20px;" onclick="showContactSupport()">
                    <i class="fas fa-headset"></i> اتصل بالدعم
                </button>
                
               <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
            
            <!-- Transactions Section -->
            <div class="transactions-section" id="transactionsSection">
                <h2 class="section-title">
                    <i class="fas fa-exchange-alt"></i> سجل المعاملات
                </h2>
                
                <div class="transaction-filter">
                    <div class="filter-btn active" onclick="filterTransactions('all')">الكل</div>
                    <div class="filter-btn" onclick="filterTransactions('investment')">الاستثمارات</div>
                    <div class="filter-btn" onclick="filterTransactions('profit')">الأرباح</div>
                    <div class="filter-btn" onclick="filterTransactions('withdrawal')">السحوبات</div>
                </div>
                
                <div id="filteredTransactionsList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="notifications-section" id="notificationsSection">
                <h2 class="section-title">
                    <i class="fas fa-bell"></i> التنبيهات والإشعارات
                </h2>
                
                <div id="notificationsList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="switchSection('home')">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </div>
            <div class="nav-item" onclick="switchSection('card')">
                <i class="fas fa-credit-card"></i>
                <span>البطاقة</span>
            </div>
            <div class="nav-item" onclick="switchSection('transactions')">
                <i class="fas fa-exchange-alt"></i>
                <span>المعاملات</span>
            </div>
            <div class="nav-item" onclick="switchSection('notifications')">
                <i class="fas fa-bell"></i>
                <span>التنبيهات</span>
            </div>
            <div class="nav-item" onclick="switchSection('profile')">
                <i class="fas fa-user"></i>
                <span>الشخصي</span>
            </div>
        </div>

        <!-- Withdraw Modal -->
        <div class="modal" id="withdrawModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">طلب سحب الأرباح</h2>
                    <button class="modal-close" onclick="closeWithdrawModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="withdrawForm" onsubmit="submitWithdrawRequest(event)">
                    <div class="form-group">
                        <label class="form-label">البطاقة</label>
                        <div class="card-display">
                            <span id="withdrawCardNumber" class="card-number-display">2750 2380 1584 5063</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الرصيد المتاح للسحب</label>
                        <input type="text" class="form-control" id="availableBalance" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المبلغ المطلوب سحبه</label>
                        <input type="number" class="form-control" id="withdrawAmount" min="50" required>
                        <div class="form-help-text">
                            <span id="withdrawMinAmount">الحد الأدنى: 50 د.ع</span>
                            <span id="withdrawMaxAmount">الحد الأقصى: 0 د.ع</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">طريقة الاستلام</label>
                        <select class="form-control" id="withdrawMethod" required>
                            <option value="cash">نقداً</option>
                            <option value="bank_transfer">حوالة بنكية</option>
                            <option value="e_wallet">محفظة إلكترونية</option>
                        </select>
                    </div>
                    <div class="form-group" id="bankDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل الحساب البنكي</label>
                        <input type="text" class="form-control" id="bankDetails" placeholder="اسم البنك ورقم الحساب">
                        <div class="form-help-text">يرجى إدخال اسم البنك ورقم الحساب بشكل صحيح</div>
                    </div>
                    <div class="form-group" id="walletDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل المحفظة الإلكترونية</label>
                        <input type="text" class="form-control" id="walletDetails" placeholder="نوع المحفظة ورقم الهاتف">
                        <div class="form-help-text">يرجى إدخال نوع المحفظة ورقم الهاتف بشكل صحيح</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="withdrawNotes" rows="3" placeholder="يمكنك إضافة أي ملاحظات خاصة بطلب السحب هنا"></textarea>
                    </div>
                    <div class="alert-container">
                        <div id="withdrawError" class="error-message"></div>
                        <div id="withdrawSuccess" class="success-message"></div>
                    </div>
                    <div class="form-notice">
                        <i class="fas fa-info-circle"></i>
                        <span>سيتم مراجعة طلب السحب وقد يستغرق المعالجة من 1-3 أيام عمل.</span>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال الطلب
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Contact Support Modal -->
        <div class="modal" id="supportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">اتصل بالدعم</h2>
                    <button class="modal-close" onclick="closeSupportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="supportForm" onsubmit="submitSupportRequest(event)">
                    <div class="form-group">
                        <label class="form-label">موضوع المراسلة</label>
                        <select class="form-control" id="supportTopic" required>
                            <option value="">اختر الموضوع</option>
                            <option value="technical">مشكلة تقنية</option>
                            <option value="account">استفسار عن الحساب</option>
                            <option value="investment">استفسار عن الاستثمار</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الرسالة</label>
                        <textarea class="form-control" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <div id="supportError" class="error-message"></div>
                    <div id="supportSuccess" class="success-message"></div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Account Details Modal -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">تفاصيل الحساب</h2>
                    <button class="modal-close" onclick="closeDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">اسم المستثمر</div>
                        <div class="detail-value" id="detailsName">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم البطاقة</div>
                        <div class="detail-value" id="detailsCardNumber">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانتهاء</div>
                        <div class="detail-value" id="detailsExpiryDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الاستثمار</div>
                        <div class="detail-value" id="detailsTotalInvestment">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الأرباح</div>
                        <div class="detail-value" id="detailsTotalProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المستحقة</div>
                        <div class="detail-value" id="detailsDueProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المدفوعة</div>
                        <div class="detail-value" id="detailsPaidProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">نوع الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentType">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستحقاق</div>
                        <div class="detail-value" id="detailsMaturityDate">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Details Modal -->
        <div class="modal" id="notificationDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);" id="notificationDetailsTitle">تفاصيل الإشعار</h2>
                    <button class="modal-close" onclick="closeNotificationDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="account-details" id="notificationDetailsContent">
                    <!-- تفاصيل الإشعار ستظهر هنا -->
                </div>
            </div>
        </div>
        
        <!-- Project Details Modal -->
        <div class="modal" id="projectDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);" id="projectDetailsTitle">تفاصيل المشروع</h2>
                    <button class="modal-close" onclick="closeProjectDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="projectDetailsContent">
                    <!-- محتوى المشروع سيظهر هنا -->
                </div>
                <div class="form-notice">
                    <i class="fas fa-info-circle"></i>
                    <span>لمزيد من المعلومات، يرجى التواصل مع فريق خدمة العملاء.</span>
                </div>
                <button class="btn" onclick="applyForProject()">
                    <i class="fas fa-handshake"></i> استثمر الآن
                </button>
            </div>
        </div>
        <!-- Office Locations and Map Modal -->
<div class="modal" id="investmentLocationsModal">
    <div class="modal-content" style="max-width: 90%; max-height: 90%; width: 90%; height: 90%;">
        <div class="modal-header">
            <h2 style="color: var(--gold);">مواقع الاستثمار والمقرات</h2>
            <button class="modal-close" onclick="closeInvestmentLocationsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="officesAndMapContainer">
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--gold); margin-bottom: 15px;">مقرات الشركة</h3>
                <div id="officesList">
                    <!-- المقرات ستظهر هنا -->
                </div>
            </div>
            
            <div class="form-notice" style="margin: 20px 0;">
                <i class="fas fa-info-circle"></i>
                <span>انقر على الموقع المناسب للاستثمار أو اتصل بأحد مقراتنا للمزيد من المعلومات</span>
            </div>
            
            <h3 style="color: var(--gold); margin-bottom: 15px;">مواقع الاستثمار</h3>
            <div id="investmentMap" style="width: 100%; height: 400px; border-radius: 12px; overflow: hidden;">
                <!-- الخريطة ستظهر هنا -->
            </div>
            
            <!-- أزرار للمشرف فقط -->
            <div id="adminMapControls" style="margin-top: 15px; display: none;">
                <button class="btn btn-secondary" style="margin-left: 10px;" onclick="toggleAddLocationMode()">
                    <i class="fas fa-map-marker-alt"></i> إضافة موقع جديد
                </button>
                <button class="btn btn-secondary" onclick="saveLocations()">
                    <i class="fas fa-save"></i> حفظ المواقع
                </button>
            </div>
        </div>
        
        <div class="form-notice" style="margin-top: 20px;">
            <i class="fas fa-phone"></i>
            <span>للاستفسار: +964 771 123 4567</span>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="confirmInvestment()">
                <i class="fas fa-check-circle"></i> تأكيد الاستثمار
            </button>
            <button class="btn btn-secondary" onclick="closeInvestmentLocationsModal()">
                <i class="fas fa-times-circle"></i> إلغاء
            </button>
        </div>
    </div>
</div>
        <!-- نوافذ إدارة المشاريع والتصنيفات -->
        
        <!-- نافذة إضافة مشروع جديد -->
        <div class="modal" id="addProjectModal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">إضافة مشروع جديد</h2>
                    <button class="modal-close" onclick="closeAddProjectModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addProjectForm" onsubmit="submitNewProject(event)">
                    <div class="form-group">
                        <label class="form-label">صورة المشروع</label>
                        <div class="image-preview" id="projectImagePreview" onclick="triggerImageUpload()">
                            <div class="image-preview-text">
                                <i class="fas fa-image"></i>
                                <span>انقر لتحميل صورة</span>
                            </div>
                        </div>
                        <input type="file" id="projectImageUpload" accept="image/*" style="display:none;" onchange="previewProjectImage(this)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">عنوان المشروع</label>
                        <input type="text" class="form-control" id="projectTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تصنيف المشروع</label>
                        <select class="form-control" id="projectCategory" required>
                            <!-- سيتم تعبئة التصنيفات ديناميكياً -->
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">العائد المتوقع</label>
                            <input type="text" class="form-control" id="projectReturn" placeholder="مثال: 15-20% سنوياً" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدة الاستثمار</label>
                            <input type="text" class="form-control" id="projectDuration" placeholder="مثال: 3-5 سنوات" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">الحد الأدنى للاستثمار</label>
                            <input type="text" class="form-control" id="projectMinInvestment" placeholder="مثال: 5,000 د.ع" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">القيمة الإجمالية للمشروع</label>
                            <input type="text" class="form-control" id="projectTotalValue" placeholder="مثال: 1,500,000 د.ع">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف المشروع</label>
                        <textarea class="form-control" id="projectDescription" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">مميزات المشروع</label>
                        <div class="text-editor" id="projectFeatures" contenteditable="true"></div>
                        <div class="form-help-text">أدخل كل ميزة في سطر منفصل</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">أيقونة المشروع</label>
                        <select class="form-control" id="projectIcon">
                            <option value="building">مبنى (مشروع سكني)</option>
                            <option value="seedling">نباتات (مشروع زراعي)</option>
                            <option value="industry">مصنع (مشروع صناعي)</option>
                            <option value="shopping-cart">تسوق (مشروع تجاري)</option>
                            <option value="truck">نقل (مشروع لوجستي)</option>
                            <option value="medkit">صحة (مشروع طبي)</option>
                            <option value="graduation-cap">تعليم (مشروع تعليمي)</option>
                            <option value="hotel">فندق (مشروع سياحي)</option>
                            <option value="solar-panel">طاقة (مشروع طاقة)</option>
                            <option value="coins">استثمار (مشروع مالي)</option>
                        </select>
                    </div>
                    
                    <div class="alert-container">
                        <div id="addProjectError" class="error-message"></div>
                        <div id="addProjectSuccess" class="success-message"></div>
                    </div>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-plus-circle"></i> إضافة المشروع
                    </button>
                </form>
            </div>
        </div>
        
        <!-- نافذة إضافة تصنيف جديد -->
        <div class="modal" id="addCategoryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">إضافة تصنيف جديد</h2>
                    <button class="modal-close" onclick="closeAddCategoryModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="addCategoryForm" onsubmit="submitNewCategory(event)">
                    <div class="form-group">
                        <label class="form-label">اسم التصنيف</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">معرّف التصنيف (بالإنجليزية)</label>
                        <input type="text" class="form-control" id="categoryId" required>
                        <div class="form-help-text">مثال: real-estate</div>
                    </div>
                    <div class="alert-container">
                        <div id="addCategoryError" class="error-message"></div>
                        <div id="addCategorySuccess" class="success-message"></div>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-plus-circle"></i> إضافة التصنيف
                    </button>
                </form>
            </div>
        </div>
        
        <!-- نافذة إدارة التصنيفات -->
        <div class="modal" id="manageCategoriesModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">إدارة التصنيفات</h2>
                    <button class="modal-close" onclick="closeManageCategoriesModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="categoriesList" class="account-details">
                    <!-- سيتم تعبئة التصنيفات هنا -->
                </div>
                <button class="btn" onclick="openAddCategoryModal()" style="margin-top: 20px;">
                    <i class="fas fa-plus-circle"></i> إضافة تصنيف جديد
                </button>
            </div>
        </div>
        
        <!-- نافذة تعديل مشروع -->
        <div class="modal" id="editProjectModal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">تعديل المشروع</h2>
                    <button class="modal-close" onclick="closeEditProjectModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="editProjectForm" onsubmit="submitEditProject(event)">
                    <input type="hidden" id="editProjectId">
                    
                    <div class="form-group">
                        <label class="form-label">صورة المشروع</label>
                        <div class="image-preview" id="editProjectImagePreview" onclick="triggerEditImageUpload()">
                            <div class="image-preview-text">
                                <i class="fas fa-image"></i>
                                <span>انقر لتغيير الصورة</span>
                            </div>
                        </div>
                        <input type="file" id="editProjectImageUpload" accept="image/*" style="display:none;" onchange="previewEditProjectImage(this)">
                    </div>
                    
                    <!-- نفس العناصر كما في نافذة الإضافة لكن مع معرفات مختلفة -->
                    <div class="form-group">
                        <label class="form-label">عنوان المشروع</label>
                        <input type="text" class="form-control" id="editProjectTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تصنيف المشروع</label>
                        <select class="form-control" id="editProjectCategory" required>
                            <!-- سيتم تعبئة التصنيفات ديناميكياً -->
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">العائد المتوقع</label>
                            <input type="text" class="form-control" id="editProjectReturn" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدة الاستثمار</label>
                            <input type="text" class="form-control" id="editProjectDuration" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">الحد الأدنى للاستثمار</label>
                            <input type="text" class="form-control" id="editProjectMinInvestment" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">القيمة الإجمالية للمشروع</label>
                            <input type="text" class="form-control" id="editProjectTotalValue">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف المشروع</label>
                        <textarea class="form-control" id="editProjectDescription" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">مميزات المشروع</label>
                        <div class="text-editor" id="editProjectFeatures" contenteditable="true"></div>
                        <div class="form-help-text">أدخل كل ميزة في سطر منفصل</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">أيقونة المشروع</label>
                        <select class="form-control" id="editProjectIcon">
                            <option value="building">مبنى (مشروع سكني)</option>
                            <option value="seedling">نباتات (مشروع زراعي)</option>
                            <option value="industry">مصنع (مشروع صناعي)</option>
                            <option value="shopping-cart">تسوق (مشروع تجاري)</option>
                            <option value="truck">نقل (مشروع لوجستي)</option>
                            <option value="medkit">صحة (مشروع طبي)</option>
                            <option value="graduation-cap">تعليم (مشروع تعليمي)</option>
                            <option value="hotel">فندق (مشروع سياحي)</option>
                            <option value="solar-panel">طاقة (مشروع طاقة)</option>
                            <option value="coins">استثمار (مشروع مالي)</option>
                        </select>
                    </div>
                    
                    <div class="alert-container">
                        <div id="editProjectError" class="error-message"></div>
                        <div id="editProjectSuccess" class="success-message"></div>
                    </div>
                    
                    <div class="form-row">
                        <button type="submit" class="btn" style="margin-left: 10px;">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="deleteProject()">
                            <i class="fas fa-trash-alt"></i> حذف المشروع
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification Toast Container -->
        <div id="notificationToastContainer"></div>
    </div>

    <script>
   // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
        authDomain: "messageemeapp.firebaseapp.com",
        databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
        projectId: "messageemeapp",
        storageBucket: "messageemeapp.appspot.com",
        messagingSenderId: "255034474844",
        appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Global variables
    let currentInvestor = null;
    let currentCard = null;
    let qrScanner = null;
    let currentFilter = 'all';
    let notifications = [];
    let currentProject = '';
    
    // متغيرات إضافية لإدارة المشاريع
    let categories = [];
    let projects = [];
    let isAdminMode = false;
    let isProjectEditMode = false;
    let projectImageFile = null;
    let editImageChanged = false;

    // متغيرات الخريطة والمواقع
    let map = null;
    let markers = [];
    let currentInfoWindow = null;
    let investmentLocations = [];
    let isAddLocationMode = false;

    // مقرات الشركة
    const companyOffices = [
        {
            name: "المقر الرئيسي - الحلة",
            address: "الحلة، شارع 40، بالقرب من مصرف الرافدين",
            phone: "07801234567",
            email: "info@samababel.com",
            location: { lat: 32.4722, lng: 44.4134 }
        },
        {
            name: "فرع بغداد",
            address: "بغداد، المنصور، شارع 14 رمضان",
            phone: "07711234567",
            email: "baghdad@samababel.com",
            location: { lat: 33.3152, lng: 44.3661 }
        },
        {
            name: "فرع النجف",
            address: "النجف، حي السلام، بالقرب من المسجد الكبير",
            phone: "07771234567",
            email: "najaf@samababel.com",
            location: { lat: 31.9926, lng: 44.3512 }
        }
    ];

    // المسار الصحيح في Firebase
    const FIREBASE_USER_ID = '6wS4ga5v6MXUMC0yzyDnxuI2dh03';
    const INVESTOR_CARD_ID = 'mai4v8cousf7soxqvt'; // معرف البطاقة المحدد
    const CARDS_PATH = `users/${FIREBASE_USER_ID}/investorCards`;
    const TRANSACTIONS_PATH = `users/${FIREBASE_USER_ID}/transactions`;
    const WITHDRAWAL_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/withdrawRequests`;
    const SUPPORT_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/supportRequests`;
    const NOTIFICATIONS_PATH = `users/${FIREBASE_USER_ID}/notifications`;
    const OPERATIONS_PATH = `users/${FIREBASE_USER_ID}/investorCards/${INVESTOR_CARD_ID}/recentOperations`;
    
    // المسارات الجديدة الخاصة بإدارة المشاريع
    const PROJECTS_PATH = `users/${FIREBASE_USER_ID}/projects`;
    const CATEGORIES_PATH = `users/${FIREBASE_USER_ID}/categories`;

    // Initialize app
    window.onload = function() {
        setupEventListeners();
        checkLocalStorage();
        hideLoading();
        
        // التحقق من وجود مستخدم مشرف (للاختبار فقط)
        checkAdminRights();
    };

    // Check for saved login info in localStorage
    function checkLocalStorage() {
        const savedCard = localStorage.getItem('investorCard');
        const savedInvestor = localStorage.getItem('investorData');
        
        if (savedCard && savedInvestor) {
            try {
                currentCard = JSON.parse(savedCard);
                currentInvestor = JSON.parse(savedInvestor);
                showDashboard();
            } catch (error) {
                console.error('Error parsing saved data:', error);
                localStorage.removeItem('investorCard');
                localStorage.removeItem('investorData');
            }
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Card number formatting
        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', formatCardNumber);
        }
        
        // Expiry date formatting
        const expiryDateInput = document.getElementById('expiryDate');
        if (expiryDateInput) {
            expiryDateInput.addEventListener('input', formatExpiryDate);
        }
        
        // CVV formatting
        const cvvInput = document.getElementById('cvv');
        if (cvvInput) {
            cvvInput.addEventListener('input', formatCVV);
        }
        
        // Withdraw method change
        const withdrawMethodSelect = document.getElementById('withdrawMethod');
        if (withdrawMethodSelect) {
            withdrawMethodSelect.addEventListener('change', function() {
                const method = this.value;
                document.getElementById('bankDetailsGroup').style.display = method === 'bank_transfer' ? 'block' : 'none';
                document.getElementById('walletDetailsGroup').style.display = method === 'e_wallet' ? 'block' : 'none';
            });
        }
        
        // Search input handling
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                searchProjects(this.value);
            });
        }
    }

    // Format card number input
    function formatCardNumber(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    }

    // Format expiry date input
    function formatExpiryDate(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    }

    // Format CVV input
    function formatCVV(e) {
        e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
    }

    // Switch between tabs
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }

    // Login with card
    async function loginWithCard(event) {
        event.preventDefault();
        showLoading();
        clearErrors();

        const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
        const expiryDate = document.getElementById('expiryDate').value;
        const cvv = document.getElementById('cvv').value;

        console.log("Attempting login with:", { cardNumber, expiryDate, cvv });

        try {
            // Search for card in Firebase with correct path
            const cardData = await findCardInDatabase(cardNumber, expiryDate, cvv);
            
            if (cardData) {
                currentCard = cardData;
                console.log("Card found:", cardData);
                
                // Load investor data from the card
                currentInvestor = {
                    id: cardData.investorId,
                    name: cardData.investorName,
                    phone: cardData.investorPhone,
                    email: cardData.investorEmail || '',
                    joinDate: cardData.joinDate || new Date().toISOString()
                };
                
                // Save to localStorage for persistent login
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                localStorage.setItem('investorData', JSON.stringify(currentInvestor));
                
                showDashboard();
            } else {
                showError('بيانات البطاقة غير صحيحة');
            }
        } catch (error) {
            console.error('Login error:', error);
            showError('حدث خطأ في النظام');
        } finally {
            hideLoading();
        }
    }

    // Find card in database with correct path
    async function findCardInDatabase(cardNumber, expiryDate, cvv) {
        console.log("Searching in path:", CARDS_PATH);
        
        const cardsRef = database.ref(CARDS_PATH);
        const snapshot = await cardsRef.once('value');
        const cards = snapshot.val() || {};
        
        console.log("Cards found:", cards);

        // Search through all cards
        for (const cardId in cards) {
            const card = cards[cardId];
            console.log("Checking card:", card);
            
            if (card.cardNumber === cardNumber && 
                formatCardExpiryDateFromDB(card.expiryDate) === expiryDate && 
                card.cvv === cvv) {
                console.log("Card match found!");
                return card;
            }
        }

        return null;
    }

    // Format expiry date from database format
    function formatCardExpiryDateFromDB(dateString) {
        const date = new Date(dateString);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear().toString().substr(-2);
        return `${month}/${year}`;
    }

    // Start QR scan
    async function startQRScan() {
        try {
            const qrScannerElement = document.getElementById('qr-scanner');
            qrScannerElement.style.display = 'block';
            
            qrScanner = new Html5QrcodeScanner(
                "qr-scanner", 
                { fps: 10, qrbox: 250 }
            );

            qrScanner.render(onQRSuccess, onQRError);
            document.getElementById('startScanBtn').style.display = 'none';
        } catch (error) {
            console.error('QR scanner error:', error);
            showError('خطأ في تشغيل الكاميرا');
        }
    }

    // Decode QR code from uploaded image
    function decodeQRFromImage(file) {
        if (!file) {
            return;
        }
        
        showLoading();
        
        const html5QrCode = new Html5Qrcode("qr-scanner");
        
        html5QrCode.scanFile(file, true)
            .then(decodedText => {
                console.log(`QR Code from image: ${decodedText}`);
                processQRData(decodedText);
            })
            .catch(err => {
                console.error(`Error scanning uploaded QR code: ${err}`);
                showError('فشل في قراءة رمز QR من الصورة');
                hideLoading();
            });
    }

    // Process QR data (used by both camera and uploaded image)
    async function processQRData(decodedText) {
        try {
            console.log("QR Code scanned:", decodedText);

            // Parse QR data
            const qrData = JSON.parse(decodedText);
            
            if (qrData.type === 'investor-card' && qrData.cardNumber) {
                // Auto-fill card data
                document.getElementById('cardNumber').value = formatCardNumberDisplay(qrData.cardNumber);
                document.getElementById('expiryDate').value = qrData.expiryDate;
                
                // Find card in database
                const cardData = await findCardByQR(qrData);
                
                if (cardData) {
                    currentCard = cardData;
                    
                    // Load investor data from the card
                    currentInvestor = {
                        id: cardData.investorId,
                        name: cardData.investorName,
                        phone: cardData.investorPhone,
                        email: cardData.investorEmail || '',
                        joinDate: cardData.joinDate || new Date().toISOString()
                    };
                    
                    // Save to localStorage for persistent login
                    localStorage.setItem('investorCard', JSON.stringify(currentCard));
                    localStorage.setItem('investorData', JSON.stringify(currentInvestor));
                    
                    showDashboard();
                } else {
                    showError('البطاقة غير موجودة في النظام');
                }
            } else {
                showError('رمز QR غير صالح');
            }
        } catch (error) {
            console.error('QR processing error:', error);
            showError('خطأ في معالجة رمز QR');
        } finally {
            hideLoading();
        }
    }

    // QR scan success
    function onQRSuccess(decodedText) {
        if (qrScanner) {
            qrScanner.clear();
            qrScanner = null;
        }
        
        processQRData(decodedText);
    }

    // QR scan error
    function onQRError(error) {
        console.warn('QR scan error:', error);
    }

    // Find card by QR data
    async function findCardByQR(qrData) {
        const cardsRef = database.ref(CARDS_PATH);
        const snapshot = await cardsRef.once('value');
        const cards = snapshot.val() || {};

        // Search by card ID or investor ID
        for (const cardId in cards) {
            const card = cards[cardId];
            if ((card.id === qrData.id || card.investorId === qrData.investorId) &&
                card.cardNumber === qrData.cardNumber) {
                return card;
            }
        }

        return null;
    }

    // Show dashboard
    function showDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        document.getElementById('bottomNav').style.display = 'flex';
        
        // Make sure home section is visible and others are hidden
        switchSection('home');

        // Update dashboard with card data
        updateDashboard();
        
        // Load notifications
        loadNotifications();
        
        // Load categories and projects
        loadCategories();
        loadProjects();
        
        // Check for withdrawal requests status
        setTimeout(checkWithdrawalRequestsStatus, 2000);
        
        // تحديث بيانات المستخدم في الصفحة الرئيسية
        updateHomeUserInfo();
        
        // تحميل النشاطات الأخيرة
        loadRecentActivities();
    }

    // Update dashboard
    function updateDashboard() {
        // Update header with investor name
        document.getElementById('headerUsername').textContent = `مرحباً، ${currentInvestor.name}`;
        
        // Update card display
        document.getElementById('displayCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
        document.getElementById('displayExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
        document.getElementById('cardDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
        document.getElementById('cardCompanyName').textContent = "سما بابل للاستثمار";

        // Update financial info
        document.getElementById('totalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
        document.getElementById('dueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
        document.getElementById('maturityDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
        document.getElementById('investmentStatus').textContent = currentCard.status || "نشط";

        // Update profile section
        updateProfileSection();
        
        // Load transactions
        loadTransactions();
        
        // Load filtered transactions
        loadFilteredTransactions(currentFilter);
    }

    // تحديث بيانات المستخدم في الصفحة الرئيسية
    function updateHomeUserInfo() {
        // تحديث اسم المستخدم في الترحيب
        document.getElementById('welcomeText').textContent = `مرحباً، ${currentInvestor.name}`;
        
        // تحديث الحرف الأول من اسم المستخدم في الصورة
        const avatarElement = document.getElementById('userAvatar');
        const firstLetter = currentInvestor.name.charAt(0);
        avatarElement.innerHTML = firstLetter;
    }

    // Refresh dashboard data
    async function refreshDashboard() {
        showLoading();
        
        try {
            // Reload card data from Firebase
            if (currentCard && currentCard.id) {
                const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
                const snapshot = await cardRef.once('value');
                const updatedCard = snapshot.val();
                
                if (updatedCard) {
                    currentCard = updatedCard;
                    
                    // Update localStorage
                    localStorage.setItem('investorCard', JSON.stringify(currentCard));
                    
                    // Update UI
                    updateDashboard();
                }
            }
            
            // Reload projects and categories from Firebase
            await loadCategories();
            await loadProjects();
            
            // Reload notifications
            loadNotifications();
            
            // تحديث النشاطات الأخيرة
            loadRecentActivities();
        } catch (error) {
            console.error('Error refreshing data:', error);
        } finally {
            hideLoading();
        }
    }

    // تحميل النشاطات الأخيرة للصفحة الرئيسية
    function loadRecentActivities() {
        const recentActivitiesContainer = document.getElementById('recentActivities');
        recentActivitiesContainer.innerHTML = '';
        
        // استخدام العمليات الحديثة من البطاقة إذا كانت متوفرة
        if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
            // ترتيب العمليات حسب التاريخ (الأحدث أولاً)
            const sortedOperations = [...currentCard.recentOperations]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // عرض آخر 3 عمليات فقط
            const recentOps = sortedOperations.slice(0, 3);
            
            recentOps.forEach(operation => {
                const activityItem = createActivityElement(operation);
                recentActivitiesContainer.appendChild(activityItem);
            });
        } else {
            // إذا لم تكن هناك عمليات، استخدم بيانات وهمية
            const mockActivities = generateMockActivities();
            mockActivities.forEach(activity => {
                const activityItem = createActivityElement(activity);
                recentActivitiesContainer.appendChild(activityItem);
            });
        }
    }

    // إنشاء عنصر نشاط
    function createActivityElement(activity) {
        const div = document.createElement('div');
        div.className = 'activity-item';
        
        // تحديد الأيقونة المناسبة
        let icon = 'fas fa-exchange-alt';
        if (activity.type === 'investment' || activity.type === 'deposit') {
            icon = 'fas fa-arrow-down';
        } else if (activity.type === 'withdrawal') {
            icon = 'fas fa-arrow-up';
        } else if (activity.type === 'profit') {
            icon = 'fas fa-hand-holding-usd';
        }
        
        // تحديد ما إذا كان المبلغ إيجابيًا أم سلبيًا
        const isPositive = activity.type === 'profit' || activity.type === 'investment';
        
        div.innerHTML = `
            <div class="activity-icon">
                <i class="${icon}"></i>
            </div>
            <div class="activity-content">
                <div class="activity-title">${getTransactionTypeName(activity.type)}</div>
                <div class="activity-time">${formatDate(activity.date)} ${formatTime(activity.date)}</div>
            </div>
            <div class="activity-amount ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? '+' : '-'} ${formatCurrency(activity.amount || 0)}
            </div>
        `;
        
        return div;
    }

    // إنشاء أنشطة وهمية للعرض
    function generateMockActivities() {
        return [
            {
                id: 'mock1',
                type: 'profit',
                amount: 150,
                date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                description: 'أرباح شهرية'
            },
            {
                id: 'mock2',
                type: 'investment',
                amount: 1000,
                date: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
                description: 'استثمار جديد'
            },
            {
                id: 'mock3',
                type: 'withdrawal',
                amount: 500,
                date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                description: 'سحب أرباح'
            }
        ];
    }

    // Update profile section
    function updateProfileSection() {
        // Set profile data
        document.getElementById('profileName').textContent = currentInvestor.name;
        document.getElementById('profileCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
        document.getElementById('profileFullName').textContent = currentInvestor.name;
        document.getElementById('profilePhone').textContent = currentInvestor.phone || '-';
        document.getElementById('profileEmail').textContent = currentInvestor.email || '-';
        document.getElementById('profileJoinDate').textContent = formatDate(currentInvestor.joinDate);
        
        // Set the first letter of the name as avatar text
        const avatarElement = document.getElementById('profileAvatar');
        const firstLetter = currentInvestor.name.charAt(0);
        avatarElement.innerHTML = `<span style="font-size: 2.5rem;">${firstLetter}</span>`;
    }

    // Format card number for display
    function formatCardNumberDisplay(cardNumber) {
        return cardNumber.match(/.{1,4}/g).join(' ');
    }

    // Format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('ar-IQ', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount) + " د.ع";
    }

    // Load transactions
    function loadTransactions() {
        const transactionsList = document.getElementById('transactionsList');
        transactionsList.innerHTML = '';
        
        try {
            // If we have recent operations in the card object
            if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
                // Sort operations by date (newest first)
                const sortedOperations = [...currentCard.recentOperations]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Display the 5 most recent transactions
                const recentOperations = sortedOperations.slice(0, 5);
                
                recentOperations.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            } else {
                // Load operations from Firebase
                loadRecentOperationsFromFirebase(transactionsList);
            }
        } catch (error) {
            console.error('Error loading transactions:', error);
            transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">حدث خطأ في تحميل المعاملات</p>';
        }
    }

    // Load recent operations from Firebase
    async function loadRecentOperationsFromFirebase(transactionsList) {
        try {
            const operationsRef = database.ref(OPERATIONS_PATH);
            const snapshot = await operationsRef.orderByChild('date').once('value');
            
            // Convert to array and sort by date (newest first)
            const operations = [];
            snapshot.forEach(childSnapshot => {
                operations.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            
            // Sort by date (newest first)
            operations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Display operations
            if (operations.length > 0) {
                // Update currentCard with recent operations
                if (!currentCard.recentOperations) {
                    currentCard.recentOperations = [];
                }
                currentCard.recentOperations = operations;
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                
                // Display the 5 most recent transactions
                const recentOperations = operations.slice(0, 5);
                recentOperations.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            } else {
                // No operations found, generate mock data
                const mockTransactions = generateMockTransactions();
                
                // Save mock transactions to card
                currentCard.recentOperations = mockTransactions;
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                
                // Display mock transactions
                mockTransactions.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            }
        } catch (error) {
            console.error('Error loading operations from Firebase:', error);
            
            // Use mock data as fallback
            const mockTransactions = generateMockTransactions();
            currentCard.recentOperations = mockTransactions;
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            
            mockTransactions.forEach(transaction => {
                const transactionElement = createTransactionElement(transaction);
                transactionsList.appendChild(transactionElement);
            });
        }
    }

    // Generate mock transactions if none exist
    function generateMockTransactions() {
        const transactions = [];
        const today = new Date();
        
        // Investment transaction
        transactions.push({
            id: generateId(),
            type: 'investment',
            amount: currentCard.totalInvestment || 4000,
            date: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString(), // 180 days ago
            status: 'completed',
            description: 'استثمار أولي'
        });
        
        // Generate multiple profit transactions for the past few months
        for (let i = 6; i > 0; i--) {
            transactions.push({
                id: generateId(),
                type: 'profit',
                amount: 500 + Math.random() * 300,
                date: new Date(today.getTime() - i * 30 * 24 * 60 * 60 * 1000).toISOString(), // i months ago
                status: 'completed',
                description: 'أرباح شهرية'
            });
        }
        
        // Add a withdrawal transaction
        transactions.push({
            id: generateId(),
            type: 'withdrawal',
            amount: 800,
            date: new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString(), // 90 days ago
            status: 'completed',
            description: 'سحب أرباح'
        });
        
        // Sort by date (newest first)
        return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    // Load filtered transactions
    function loadFilteredTransactions(filter) {
        const transactionsList = document.getElementById('filteredTransactionsList');
        transactionsList.innerHTML = '';
        
        // Activate the selected filter button
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.filter-btn[onclick="filterTransactions('${filter}')"]`).classList.add('active');
        
        // If we have recent operations in the card object
        if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
            // Sort operations by date (newest first)
            const sortedOperations = [...currentCard.recentOperations]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Filter transactions based on selected filter
            let filteredOperations = sortedOperations;
            if (filter !== 'all') {
                filteredOperations = sortedOperations.filter(op => op.type === filter);
            }
            
            // Group transactions by date
            const groupedTransactions = groupTransactionsByDate(filteredOperations);
            
            // Display grouped transactions
            Object.keys(groupedTransactions).forEach(date => {
                // Add date header
                const dateHeader = document.createElement('div');
                dateHeader.className = 'transaction-date-header';
                dateHeader.textContent = date;
                transactionsList.appendChild(dateHeader);
                
                // Add transactions for this date
                groupedTransactions[date].forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            });
            
            // If no transactions found for this filter
            if (filteredOperations.length === 0) {
                transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات لهذا النوع</p>';
            }
        } else {
            transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات</p>';
        }
    }

    // Group transactions by date
    function groupTransactionsByDate(transactions) {
        const groups = {};
        
        transactions.forEach(transaction => {
            const dateString = formatDate(transaction.date);
            
            if (!groups[dateString]) {
                groups[dateString] = [];
            }
            
            groups[dateString].push(transaction);
        });
        
        return groups;
    }

    // Filter transactions
    function filterTransactions(filter) {
        currentFilter = filter;
        loadFilteredTransactions(filter);
    }

    // Create transaction element
    function createTransactionElement(transaction) {
        const div = document.createElement('div');
        div.className = 'transaction-item';
        div.dataset.id = transaction.id || '';

        const icon = getTransactionIcon(transaction.type);
        const amount = transaction.amount;
        const isPositive = transaction.type === 'profit' || transaction.type === 'investment';
        
        // Extract time from date for display
        const transactionDate = new Date(transaction.date);
        const hours = transactionDate.getHours().toString().padStart(2, '0');
        const minutes = transactionDate.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        div.innerHTML = `
            <div class="transaction-icon">
                <i class="${icon}"></i>
            </div>
            <div class="transaction-info">
                <div class="transaction-type">${getTransactionTypeName(transaction.type)}</div>
                <div class="transaction-date">${formatDate(transaction.date)}</div>
            </div>
            <div style="text-align: left; direction: ltr;">
                <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                    ${isPositive ? '+' : '-'} ${formatCurrency(amount)}
                </div>
                <div class="transaction-time">${timeString}</div>
            </div>
        `;

        return div;
    }

    // Get transaction icon
    function getTransactionIcon(type) {
        switch (type) {
            case 'deposit':
            case 'investment':
                return 'fas fa-arrow-down';
            case 'withdrawal':
                return 'fas fa-arrow-up';
            case 'profit':
                return 'fas fa-hand-holding-usd';
            default:
                return 'fas fa-exchange-alt';
        }
    }

    // Get transaction type name
    function getTransactionTypeName(type) {
        switch (type) {
            case 'deposit':
                return 'إيداع';
            case 'investment':
                return 'استثمار';
            case 'withdrawal':
                return 'سحب';
            case 'profit':
                return 'أرباح';
            default:
                return type;
        }
    }

    // تحديث دالة تحميل الإشعارات لجلب البيانات الحقيقية من Firebase
    async function loadNotifications() {
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">جاري تحميل الإشعارات...</p>';
        
        try {
            // مسار الإشعارات للمستثمر الحالي في Firebase
            // مسار الإشعارات الصحيح يستخدم معرف المستخدم وبطاقة المستثمر
            const investorId = currentInvestor?.id || '';
            const cardId = currentCard?.id || '';
            
            // تحقق من صحة المعرفات قبل الاستمرار
            if (!investorId || !cardId) {
                console.error('معرفات المستثمر أو البطاقة غير متوفرة');
                notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا يمكن تحميل الإشعارات، الرجاء إعادة تسجيل الدخول</p>';
                return;
            }
            
            // الحصول على الإشعارات من Firebase - استخدام المسار الصحيح
            const notificationsRef = database.ref(`${NOTIFICATIONS_PATH}`);
            const snapshot = await notificationsRef.orderByChild('date').once('value');
            
            // إنشاء مصفوفة من الإشعارات
            const notificationsArray = [];
            snapshot.forEach(childSnapshot => {
                const notification = childSnapshot.val();
                // إضافة معرف الإشعار للاستخدام لاحقًا
                notification.id = childSnapshot.key;
                notificationsArray.push(notification);
            });
            
            // جلب العمليات الحالية وتحويلها إلى إشعارات
            const operationsRef = database.ref(`${OPERATIONS_PATH}`);
            const operationsSnapshot = await operationsRef.once('value');
            const operations = [];
            
            operationsSnapshot.forEach(childSnapshot => {
                const operation = childSnapshot.val();
                // إضافة معرف العملية
                operation.id = childSnapshot.key;
                operations.push(operation);
                
                // تحويل العملية إلى إشعار وإضافته إلى مصفوفة الإشعارات
                const notification = createNotificationFromOperation(operation);
                if (notification) {
                    notificationsArray.push(notification);
                }
            });
            
            // ترتيب الإشعارات حسب التاريخ (الأحدث أولاً)
            notifications = notificationsArray.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            // عرض الإشعارات
            displayNotifications(notifications);
            
            // تحديث عدد الإشعارات غير المقروءة
            updateUnreadCount();
            
            // الاستماع للتغييرات في الإشعارات في الوقت الفعلي
            listenForNotificationChanges();
        } catch (error) {
            console.error('خطأ في تحميل الإشعارات:', error);
            notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">حدث خطأ في تحميل الإشعارات</p>';
        }
    }

    // دالة لعرض الإشعارات
    function displayNotifications(notificationsArray) {
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = '';
        
        if (notificationsArray.length === 0) {
            notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد إشعارات</p>';
            return;
        }
        
        // عرض كل إشعار
        notificationsArray.forEach(notification => {
            const notificationElement = createNotificationElement(notification);
            notificationsList.appendChild(notificationElement);
        });
    }

    // تحديث دالة تحويل العملية إلى إشعار
    function createNotificationFromOperation(operation) {
        if (!operation || !operation.type) return null;
        
        // تخصيص عنوان الإشعار ونص الرسالة حسب نوع العملية
        let title = '';
        let message = '';
        let notificationType = operation.type;
        
        switch (operation.type) {
            case 'investment':
            case 'deposit':
                title = 'استثمار جديد';
                message = `تم إضافة استثمار جديد بقيمة ${formatCurrency(operation.amount)}`;
                if (operation.notes) {
                    message += `. ${operation.notes}`;
                }
                break;
            case 'withdrawal':
                title = 'طلب سحب';
                message = `تم تسجيل طلب سحب بقيمة ${formatCurrency(operation.amount)}`;
                if (operation.status === 'pending') {
                    message += `. الطلب قيد المراجعة`;
                } else if (operation.status === 'completed') {
                    message += `. تمت الموافقة على الطلب`;
                } else if (operation.status === 'rejected') {
                    message += `. تم رفض الطلب`;
                }
                break;
            case 'profit':
                title = 'أرباح جديدة';
                message = `تم إضافة أرباح بقيمة ${formatCurrency(operation.amount)} إلى حسابك`;
                if (operation.notes) {
                    message += `. ${operation.notes}`;
                }
                break;
            case 'system':
                title = 'إشعار نظام';
                message = operation.message || 'إشعار من النظام';
                break;
            default:
                title = 'إشعار جديد';
                message = operation.message || `تم تسجيل عملية جديدة بقيمة ${formatCurrency(operation.amount || 0)}`;
                if (operation.notes) {
                    message += `. ${operation.notes}`;
                }
                break;
        }
        
        // إنشاء كائن الإشعار
        return {
            id: operation.id || generateId(),
            title: title,
            message: message,
            type: notificationType,
            read: false,
            date: operation.date || new Date().toISOString(),
            amount: operation.amount,
            status: operation.status,
            operation: operation // تخزين العملية الأصلية للرجوع إليها عند الحاجة
        };
    }

    // تحديث دالة إنشاء عنصر الإشعار
    function createNotificationElement(notification) {
        const div = document.createElement('div');
        div.className = `notification-item ${notification.read ? '' : 'unread'} ${Date.now() - new Date(notification.date) < 3600000 ? 'new-notification' : ''}`;
        div.dataset.id = notification.id;
        
        const icon = getNotificationIcon(notification.type);
        
        let statusHTML = '';
        if (notification.status) {
            let statusClass = notification.status;
            let statusText = 'قيد المراجعة';
            
            if (notification.status === 'completed') {
                statusText = 'مكتمل';
            } else if (notification.status === 'rejected') {
                statusText = 'مرفوض';
            } else if (notification.status === 'active') {
                statusText = 'نشط';
            }
            
            statusHTML = `<div class="notification-status ${statusClass}">الحالة: ${statusText}</div>`;
        }
        
        div.innerHTML = `
            <div class="notification-icon">
                <i class="${icon}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-message">${notification.message}</div>
                ${notification.amount ? `<div class="notification-amount">${formatCurrency(notification.amount)}</div>` : ''}
                ${statusHTML}
                <div class="notification-date">${formatDate(notification.date)} - ${formatTime(notification.date)}</div>
            </div>
        `;
        
        // إضافة حدث النقر لعرض تفاصيل الإشعار
        div.addEventListener('click', () => {
            markNotificationAsRead(notification.id);
            div.classList.remove('unread');
            openNotificationDetails(notification);
        });
        
        return div;
    }

    // دالة للاستماع للتغييرات في الإشعارات في الوقت الفعلي
    function listenForNotificationChanges() {
        // الاستماع للإشعارات الجديدة
        const notificationsRef = database.ref(`${NOTIFICATIONS_PATH}`);
        notificationsRef.off(); // إزالة المستمعين السابقين
        
        notificationsRef.on('child_added', (snapshot) => {
            const newNotification = snapshot.val();
            if (newNotification) {
                newNotification.id = snapshot.key;
                
                // التحقق من عدم وجود الإشعار مسبقًا
                const existingIndex = notifications.findIndex(n => n.id === newNotification.id);
                if (existingIndex === -1) {
                    // إضافة الإشعار الجديد إلى القائمة
                    notifications.unshift(newNotification);
                    
                    // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                    if (document.getElementById('notificationsSection').style.display === 'block') {
                        displayNotifications(notifications);
                    } else {
                        // إظهار مؤشر على وجود إشعارات جديدة
                        showNotificationIndicator();
                    }
                    
                    // تحديث عدد الإشعارات غير المقروءة
                    updateUnreadCount();
                }
            }
        });
        
        // الاستماع لتحديثات الإشعارات
        notificationsRef.on('child_changed', (snapshot) => {
            const updatedNotification = snapshot.val();
            if (updatedNotification) {
                updatedNotification.id = snapshot.key;
                
                // تحديث الإشعار في القائمة
                const existingIndex = notifications.findIndex(n => n.id === updatedNotification.id);
                if (existingIndex !== -1) {
                    notifications[existingIndex] = updatedNotification;
                    
                    // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                    if (document.getElementById('notificationsSection').style.display === 'block') {
                        displayNotifications(notifications);
                    }
                    
                    // تحديث عدد الإشعارات غير المقروءة
                    updateUnreadCount();
                }
            }
        });
        
        // الاستماع لحذف الإشعارات
        notificationsRef.on('child_removed', (snapshot) => {
            const removedId = snapshot.key;
            
            // حذف الإشعار من القائمة
            notifications = notifications.filter(n => n.id !== removedId);
            
            // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
            if (document.getElementById('notificationsSection').style.display === 'block') {
                displayNotifications(notifications);
            }
            
            // تحديث عدد الإشعارات غير المقروءة
            updateUnreadCount();
        });
        
        // الاستماع للعمليات الجديدة
        const operationsRef = database.ref(`${OPERATIONS_PATH}`);
        operationsRef.off(); // إزالة المستمعين السابقين
        
        operationsRef.on('child_added', (snapshot) => {
            const newOperation = snapshot.val();
            if (newOperation) {
                newOperation.id = snapshot.key;
                
                // إنشاء إشعار من العملية
                const newNotification = createNotificationFromOperation(newOperation);
                if (newNotification) {
                    // التحقق من عدم وجود الإشعار مسبقًا
                    const existingIndex = notifications.findIndex(n => n.id === newNotification.id);
                    if (existingIndex === -1) {
                        // إضافة الإشعار الجديد إلى القائمة
                        notifications.unshift(newNotification);
                        
                        // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
                        if (document.getElementById('notificationsSection').style.display === 'block') {
                            displayNotifications(notifications);
                        } else {
                            // إظهار مؤشر على وجود إشعارات جديدة
                            showNotificationIndicator();
                        }
                        
                        // تحديث عدد الإشعارات غير المقروءة
                        updateUnreadCount();
                    }
                }
            }
        });
    }

    // تحديث دالة وضع علامة "مقروء" على الإشعار
    async function markNotificationAsRead(notificationId) {
        // التحقق من وجود الإشعار
        const notificationIndex = notifications.findIndex(n => n.id === notificationId);
        if (notificationIndex === -1) return;
        
        // تحديث حالة الإشعار في المصفوفة
        notifications[notificationIndex].read = true;
        
        try {
            // تحديث حالة الإشعار في Firebase - استخدام المسار الصحيح
            await database.ref(`${NOTIFICATIONS_PATH}/${notificationId}`).update({ read: true });
            
            // تحديث عدد الإشعارات غير المقروءة
            updateUnreadCount();
        } catch (error) {
            console.error('خطأ في تحديث حالة الإشعار:', error);
        }
    }

    // دالة لإظهار مؤشر على وجود إشعارات جديدة
    function showNotificationIndicator() {
        const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
        if (notificationNav) {
            // إضافة نقطة حمراء صغيرة لتنبيه المستخدم بوجود إشعارات جديدة
            if (!notificationNav.querySelector('.notification-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'notification-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    width: 8px;
                    height: 8px;
                    background-color: var(--red);
                    border-radius: 50%;
                `;
                notificationNav.appendChild(indicator);
                notificationNav.style.position = 'relative';
            }
        }
    }

    // تحديث دالة تحديد عدد الإشعارات غير المقروءة
    function updateUnreadCount() {
        const unreadCount = notifications.filter(notification => !notification.read).length;
        
        const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
        const countBadge = notificationNav.querySelector('.notification-count');
        
        if (unreadCount > 0) {
            if (countBadge) {
                countBadge.textContent = unreadCount;
            } else {
                const badge = document.createElement('div');
                badge.className = 'notification-count';
                badge.textContent = unreadCount;
                badge.style.cssText = `
                    position: absolute;
                    top: 0;
                    right: 0;
                    min-width: 16px;
                    height: 16px;
                    background-color: var(--red);
                    border-radius: 8px;
                    color: white;
                    font-size: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0 4px;
                `;
                notificationNav.appendChild(badge);
                notificationNav.style.position = 'relative';
            }
        } else if (countBadge) {
            countBadge.remove();
        }
    }

    // تحديث دالة تنسيق الوقت
    function formatTime(dateString) {
        const date = new Date(dateString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // تحديث switchSection لتحديث قراءة الإشعارات عند الانتقال إلى قسم الإشعارات
    function switchSection(section) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="switchSection('${section}')"]`).classList.add('active');
        
        // تغيير عنوان الصفحة
        updateSectionTitle(section);
        
        // Hide all sections
        document.getElementById('homeSection').style.display = 'none';
        document.getElementById('cardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('transactionsSection').style.display = 'none';
        document.getElementById('notificationsSection').style.display = 'none';
        
        // Show the selected section
        if (section === 'home') {
            document.getElementById('homeSection').style.display = 'block';
            // تحديث المشاريع والمعلومات في الصفحة الرئيسية
            updateHomeDisplay();
        } else if (section === 'card') {
            document.getElementById('cardSection').style.display = 'block';
            // تحديث النشاطات الأخيرة في صفحة البطاقة
            loadRecentActivities();
        } else if (section === 'profile') {
            document.getElementById('profileSection').style.display = 'block';
        } else if (section === 'transactions') {
            document.getElementById('transactionsSection').style.display = 'block';
            // Make sure transactions are loaded with current filter
            loadFilteredTransactions(currentFilter);
        } else if (section === 'notifications') {
            document.getElementById('notificationsSection').style.display = 'block';
            // Make sure notifications are loaded
            loadNotifications();
            
            // تحديث قراءة الإشعارات وإزالة المؤشر
            const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
            const indicator = notificationNav.querySelector('.notification-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            // تحديث حالة القراءة للإشعارات المعروضة
            const notificationItems = document.querySelectorAll('#notificationsList .notification-item.unread');
            notificationItems.forEach(item => {
                const notificationId = item.dataset.id;
                if (notificationId) {
                    markNotificationAsRead(notificationId);
                    item.classList.remove('unread');
                }
            });
            
            // تحديث عدد الإشعارات غير المقروءة
            updateUnreadCount();
        }
    }

    // تحديث عرض الصفحة الرئيسية
    function updateHomeDisplay() {
        // تحديث النشاطات الأخيرة
        loadRecentActivities();
        
        // تحديث معلومات المستخدم
        updateHomeUserInfo();
    }

    // تحديث عنوان الصفحة
    function updateSectionTitle(section) {
        const titleElement = document.getElementById('sectionTitle');
        
        switch (section) {
            case 'home':
                titleElement.textContent = 'مشاريع الاستثمار';
                break;
            case 'card':
                titleElement.textContent = 'بطاقة المستثمر';
                break;
            case 'profile':
                titleElement.textContent = 'الملف الشخصي';
                break;
            case 'transactions':
                titleElement.textContent = 'سجل المعاملات';
                break;
            case 'notifications':
                titleElement.textContent = 'الإشعارات';
                break;
            default:
                titleElement.textContent = 'سما بابل للاستثمار';
        }
    }

    // إضافة دالة لفتح نافذة تفاصيل الإشعار
    function openNotificationDetails(notification) {
        // التأكد من وجود النافذة المنبثقة في الصفحة
        const modal = document.getElementById('notificationDetailsModal');
        const modalTitle = document.getElementById('notificationDetailsTitle');
        const modalContent = document.getElementById('notificationDetailsContent');
        
        if (!modal || !modalTitle || !modalContent) {
            console.error('عناصر نافذة تفاصيل الإشعار غير موجودة');
            return;
        }
        
        // تعيين عنوان النافذة
        modalTitle.textContent = notification.title;
        
        // تحديد نوع المحتوى بناءً على نوع الإشعار
        let detailsContent = '';
        
        if (notification.operation) {
            const operation = notification.operation;
            
            switch (operation.type) {
                case 'investment':
                case 'deposit':
                    detailsContent = `
                        <div class="detail-item">
                            <div class="detail-label">المبلغ المستثمر</div>
                            <div class="detail-value">${formatCurrency(operation.amount)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">تاريخ الاستثمار</div>
                            <div class="detail-value">${formatDate(operation.date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الحالة</div>
                            <div class="detail-value">${operation.status === 'active' ? 'نشط' : operation.status === 'completed' ? 'مكتمل' : 'قيد المراجعة'}</div>
                        </div>
                    `;
                    break;
                case 'withdrawal':
                    detailsContent = `
                        <div class="detail-item">
                            <div class="detail-label">المبلغ المسحوب</div>
                            <div class="detail-value">${formatCurrency(operation.amount)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">تاريخ الطلب</div>
                            <div class="detail-value">${formatDate(operation.date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">طريقة الاستلام</div>
                            <div class="detail-value">${operation.method === 'cash' ? 'نقداً' : operation.method === 'bank_transfer' ? 'حوالة بنكية' : 'محفظة إلكترونية'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الحالة</div>
                            <div class="detail-value">${operation.status === 'completed' ? 'مكتمل' : operation.status === 'rejected' ? 'مرفوض' : 'قيد المراجعة'}</div>
                        </div>
                    `;
                    break;
                case 'profit':
                    detailsContent = `
                        <div class="detail-item">
                            <div class="detail-label">مبلغ الربح</div>
                            <div class="detail-value">${formatCurrency(operation.amount)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">تاريخ الإضافة</div>
                            <div class="detail-value">${formatDate(operation.date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الفترة</div>
                            <div class="detail-value">${operation.period || 'غير محدد'}</div>
                        </div>
                    `;
                    break;
                default:
                    detailsContent = `
                        <div class="detail-item">
                            <div class="detail-label">التاريخ</div>
                            <div class="detail-value">${formatDate(operation.date)}</div>
                        </div>
                        <div class="detail-label">الوصف</div>
                            <div class="detail-value">${operation.description || 'غير متوفر'}</div>
                        </div>
                    `;
            }
        } else {
            detailsContent = `
                <div class="detail-item">
                    <div class="detail-label">التاريخ</div>
                    <div class="detail-value">${formatDate(notification.date)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">الوصف</div>
                    <div class="detail-value">${notification.message}</div>
                </div>
            `;
        }
        
        // إضافة المحتوى إلى النافذة
        modalContent.innerHTML = detailsContent;
        
        // عرض النافذة
        modal.classList.add('active');
    }

    // إغلاق نافذة تفاصيل الإشعار
    function closeNotificationDetailsModal() {
        const modal = document.getElementById('notificationDetailsModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // وظائف إدارة المشاريع والتصنيفات
    
    // تحميل التصنيفات من Firebase
    async function loadCategories() {
        try {
            const categoriesRef = database.ref(CATEGORIES_PATH);
            const snapshot = await categoriesRef.once('value');
            
            if (snapshot.exists()) {
                // تحويل البيانات إلى مصفوفة
                categories = [];
                snapshot.forEach(childSnapshot => {
                    categories.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                console.log('تم تحميل التصنيفات:', categories);
                
                // عرض التصنيفات في واجهة المستخدم
                updateCategoriesUI();
            } else {
                console.log('لا توجد تصنيفات، سيتم إنشاء التصنيفات الافتراضية');
                
                // إنشاء التصنيفات الافتراضية
                createDefaultCategories();
            }
        } catch (error) {
            console.error('خطأ في تحميل التصنيفات:', error);
            
            // استخدام بيانات افتراضية في حالة الخطأ
            createDefaultCategories();
        }
    }
    
    // إنشاء تصنيفات افتراضية
    async function createDefaultCategories() {
        const defaultCategories = [
            { id: 'real-estate', name: 'مشاريع عقارية' },
            { id: 'agriculture', name: 'مشاريع زراعية' },
            { id: 'industrial', name: 'مشاريع صناعية' }
        ];
        
        categories = defaultCategories;
        
        try {
            // حفظ التصنيفات الافتراضية في Firebase
            const categoriesRef = database.ref(CATEGORIES_PATH);
            
            for (const category of defaultCategories) {
                await categoriesRef.child(category.id).set({
                    name: category.name,
                    created_at: new Date().toISOString()
                });
            }
            
            console.log('تم إنشاء التصنيفات الافتراضية');
            
            // عرض التصنيفات في واجهة المستخدم
            updateCategoriesUI();
        } catch (error) {
            console.error('خطأ في إنشاء التصنيفات الافتراضية:', error);
        }
    }
    
    // تحديث واجهة المستخدم بالتصنيفات
    function updateCategoriesUI() {
        // تحديث التصنيفات في الصفحة الرئيسية
        const categoriesContainer = document.getElementById('projectCategories');
        if (categoriesContainer) {
            // حفظ التصنيف النشط الحالي
            const activeCategory = categoriesContainer.querySelector('.filter-tab.active')?.dataset.category || 'all';
            
            // مسح التصنيفات الحالية مع الاحتفاظ بزر "الكل"
            categoriesContainer.innerHTML = `
                <div class="filter-tab ${activeCategory === 'all' ? 'active' : ''}" data-category="all" onclick="filterProjects('all')">الكل</div>
            `;
            
            // إضافة التصنيفات من المصفوفة
            categories.forEach(category => {
                const categoryTab = document.createElement('div');
                categoryTab.className = `filter-tab ${activeCategory === category.id ? 'active' : ''}`;
                categoryTab.dataset.category = category.id;
                categoryTab.textContent = category.name;
                categoryTab.onclick = function() { filterProjects(category.id); };
                categoriesContainer.appendChild(categoryTab);
            });
        }
        
        // تحديث التصنيفات في نموذج إضافة مشروع جديد
        const projectCategorySelect = document.getElementById('projectCategory');
        if (projectCategorySelect) {
            projectCategorySelect.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                projectCategorySelect.appendChild(option);
            });
        }
        
        // تحديث التصنيفات في نموذج تعديل مشروع
        const editProjectCategorySelect = document.getElementById('editProjectCategory');
        if (editProjectCategorySelect) {
            editProjectCategorySelect.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                editProjectCategorySelect.appendChild(option);
            });
        }
    }
    
    // تحميل المشاريع من Firebase
    async function loadProjects() {
        try {
            const projectsRef = database.ref(PROJECTS_PATH);
            const snapshot = await projectsRef.once('value');
            
            if (snapshot.exists()) {
                // تحويل البيانات إلى مصفوفة
                projects = [];
                snapshot.forEach(childSnapshot => {
                    projects.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                console.log('تم تحميل المشاريع:', projects);
                
                // عرض المشاريع في واجهة المستخدم
                displayProjects();
            } else {
                console.log('لا توجد مشاريع، سيتم إنشاء المشاريع الافتراضية');
                
                // إنشاء المشاريع الافتراضية
                createDefaultProjects();
            }
        } catch (error) {
            console.error('خطأ في تحميل المشاريع:', error);
            
            // استخدام بيانات افتراضية في حالة الخطأ
            createDefaultProjects();
        }
    }
    
    // إنشاء مشاريع افتراضية
    async function createDefaultProjects() {
        const defaultProjects = [
            {
                id: 'residential',
                title: 'مجمع سكني',
                category: 'real-estate',
                description: 'مشروع سكني متميز يضم شققاً مفروشة في موقع استراتيجي بالقرب من مركز المدينة. يتكون المشروع من 32 وحدة سكنية فاخرة مجهزة بأحدث التقنيات والتصاميم العصرية.',
                return: '15-20% سنوياً',
                duration: '3-5 سنوات',
                minInvestment: '5,000 د.ع',
                totalValue: '1,500,000 د.ع',
                features: [
                    'موقع استراتيجي بالقرب من مركز المدينة',
                    'تشطيبات فاخرة وتصاميم عصرية',
                    'خدمات متكاملة للسكان',
                    'عوائد مضمونة من الإيجارات'
                ],
                imageUrl: 'https://cdn.pixabay.com/photo/2016/11/18/17/46/house-1836070_1280.jpg',
                icon: 'building'
            },
            {
                id: 'farm',
                title: 'مزرعة زراعية',
                category: 'agriculture',
                description: 'مشروع زراعي متكامل لزراعة وإنتاج المحاصيل الاستراتيجية على مساحة 500 دونم من الأراضي الخصبة. يعتمد المشروع على أحدث التقنيات الزراعية وأنظمة الري الحديثة.',
                return: '18-25% سنوياً',
                duration: '2-4 سنوات',
                minInvestment: '3,000 د.ع',
                totalValue: '800,000 د.ع',
                features: [
                    'القمح والشعير',
                    'الخضروات الموسمية',
                    'النخيل وأشجار الفاكهة'
                ],
                imageUrl: 'https://cdn.pixabay.com/photo/2016/09/21/04/46/agriculture-landscape-1684052_1280.jpg',
                icon: 'seedling'
            },
            {
                id: 'factory',
                title: 'مصنع إنتاج',
                category: 'industrial',
                description: 'مشروع صناعي متخصص في إنتاج وتصنيع المنتجات المعدنية والإنشائية لتلبية احتياجات السوق المحلي والإقليمي. يعتمد المصنع على خطوط إنتاج حديثة وتقنيات متطورة.',
                return: '20-30% سنوياً',
                duration: '5-7 سنوات',
                minInvestment: '10,000 د.ع',
                totalValue: '3,000,000 د.ع',
                features: [
                    'هياكل معدنية للبناء',
                    'أنابيب وملحقات معدنية',
                    'منتجات الألمنيوم'
                ],
                imageUrl: 'https://cdn.pixabay.com/photo/2020/06/09/13/09/factory-5278865_1280.jpg',
                icon: 'industry'
            }
        ];
        
        projects = defaultProjects;
        
        try {
            // حفظ المشاريع الافتراضية في Firebase
            const projectsRef = database.ref(PROJECTS_PATH);
            
            for (const project of defaultProjects) {
                const projectId = project.id;
                delete project.id; // حذف الـ ID من الكائن قبل الحفظ
                
                await projectsRef.child(projectId).set({
                    ...project,
                    created_at: new Date().toISOString()
                });
            }
            
            console.log('تم إنشاء المشاريع الافتراضية');
            
            // عرض المشاريع في واجهة المستخدم
            displayProjects();
        } catch (error) {
            console.error('خطأ في إنشاء المشاريع الافتراضية:', error);
        }
    }
    
    // عرض المشاريع في واجهة المستخدم
    function displayProjects() {
        const projectsGrid = document.getElementById('projectsGrid');
        if (!projectsGrid) return;
        
        // الحصول على التصنيف النشط
        const activeCategory = document.querySelector('.filter-tab.active')?.dataset.category || 'all';
        
        // فلترة المشاريع حسب التصنيف
        let filteredProjects = projects;
        if (activeCategory !== 'all') {
            filteredProjects = projects.filter(project => project.category === activeCategory);
        }
        
        if (filteredProjects.length === 0) {
            projectsGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); margin-top: 30px;">لا توجد مشاريع متاحة في هذا التصنيف</p>';
            return;
        }
        
        // مسح المحتوى الحالي
        projectsGrid.innerHTML = '';
        
        // عرض المشاريع
        filteredProjects.forEach(project => {
            const projectElement = createProjectElement(project);
            projectsGrid.appendChild(projectElement);
        });
    }
    
    // إنشاء عنصر مشروع
    function createProjectElement(project) {
        const div = document.createElement('div');
        div.className = 'project-card';
        div.dataset.id = project.id;
        div.dataset.category = project.category;
        
        // تحديد أيقونة المشروع المناسبة
        let iconClass = 'fas fa-building';
        switch (project.icon) {
            case 'seedling':
                iconClass = 'fas fa-seedling';
                break;
            case 'industry':
                iconClass = 'fas fa-industry';
                break;
            case 'shopping-cart':
                iconClass = 'fas fa-shopping-cart';
                break;
            case 'truck':
                iconClass = 'fas fa-truck';
                break;
            case 'medkit':
                iconClass = 'fas fa-medkit';
                break;
            case 'graduation-cap':
                iconClass = 'fas fa-graduation-cap';
                break;
            case 'hotel':
                iconClass = 'fas fa-hotel';
                break;
            case 'solar-panel':
                iconClass = 'fas fa-solar-panel';
                break;
            case 'coins':
                iconClass = 'fas fa-coins';
                break;
        }
        
        // إضافة أزرار التحرير والحذف في وضع المشرف
        let adminButtons = '';
        if (isProjectEditMode) {
            adminButtons = `
                <div class="admin-actions">
                    <div class="admin-btn edit" onclick="editProject('${project.id}')">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="admin-btn delete" onclick="confirmDeleteProject('${project.id}')">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                </div>
            `;
        }
        
        div.innerHTML = `
            ${adminButtons}
            <div class="project-image" style="background-image: url('${project.imageUrl}');">
                <div class="project-avatar">
                    <i class="${iconClass}"></i>
                </div>
            </div>
            <div class="project-content">
                <div class="project-title">${project.title}</div>
                <div class="project-description">${shortenText(project.description, 100)}</div>
            </div>
        `;
        
        // إضافة حدث النقر لفتح تفاصيل المشروع
        div.addEventListener('click', function(event) {
            // تجنب فتح التفاصيل عند النقر على أزرار الإدارة
            if (event.target.closest('.admin-actions')) {
                return;
            }
            
            showProjectDetails(project.id);
        });
        
        return div;
    }
    
    // تصفية المشاريع حسب الفئة
    function filterProjects(category) {
        // تحديد زر التصفية النشط
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.filter-tab[data-category="${category}"]`).classList.add('active');
        
        // عرض المشاريع المفلترة
        displayProjects();
    }
    
    // البحث في المشاريع
    function searchProjects(query) {
        if (!query) {
            // إذا كان البحث فارغاً، عرض جميع المشاريع حسب التصفية الحالية
            displayProjects();
            return;
        }
        
        // تحويل البحث إلى أحرف صغيرة للمقارنة دون حساسية للحالة
        query = query.toLowerCase();
        
        // البحث في العنوان والوصف
        const searchResults = projects.filter(project => {
            return project.title.toLowerCase().includes(query) || 
                   project.description.toLowerCase().includes(query);
        });
        
        // عرض نتائج البحث
        const projectsGrid = document.getElementById('projectsGrid');
        if (!projectsGrid) return;
        
        if (searchResults.length === 0) {
            projectsGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); margin-top: 30px;">لا توجد نتائج مطابقة للبحث</p>';
            return;
        }
        
        // مسح المحتوى الحالي
        projectsGrid.innerHTML = '';
        
        // عرض نتائج البحث
        searchResults.forEach(project => {
            const projectElement = createProjectElement(project);
            projectsGrid.appendChild(projectElement);
        });
    }
    
    // عرض تفاصيل المشروع
    function showProjectDetails(projectId) {
        // العثور على المشروع بواسطة المعرف
        const project = projects.find(p => p.id === projectId);
        if (!project) {
            console.error('المشروع غير موجود:', projectId);
            return;
        }
        
        // تخزين معرف المشروع الحالي
        currentProject = projectId;
        
        const modal = document.getElementById('projectDetailsModal');
        const modalTitle = document.getElementById('projectDetailsTitle');
        const modalContent = document.getElementById('projectDetailsContent');
        
        // تعيين العنوان والمحتوى
        modalTitle.textContent = project.title;
        
        // تحويل القائمة إلى HTML
        let featuresList = '';
        if (project.features && project.features.length > 0) {
            featuresList = '<ul style="list-style-type: none; padding: 0;">';
            project.features.forEach(feature => {
                featuresList += `<li style="margin-bottom: 8px; color: var(--text-light);"><i class="fas fa-check" style="color: var(--gold); margin-left: 8px;"></i> ${feature}</li>`;
            });
            featuresList += '</ul>';
        }
        
        modalContent.innerHTML = `
            <div style="margin-bottom: 15px;">
                <img src="${project.imageUrl}" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
                <p style="color: var(--text-light); line-height: 1.6; margin-bottom: 20px;">
                    ${project.description}
                </p>
            </div>
            
            <div class="account-details" style="margin-bottom: 20px;">
                <div class="detail-item">
                    <div class="detail-label">العائد المتوقع</div>
                    <div class="detail-value">${project.return}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">مدة الاستثمار</div>
                    <div class="detail-value">${project.duration}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">الحد الأدنى للاستثمار</div>
                    <div class="detail-value">${project.minInvestment}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">القيمة الإجمالية للمشروع</div>
                    <div class="detail-value">${project.totalValue || 'غير محدد'}</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--gold); margin-bottom: 10px;">مميزات المشروع</h3>
                ${featuresList}
            </div>
        `;
        
        // عرض النافذة
        modal.classList.add('active');
    }
    
    // إغلاق نافذة تفاصيل المشروع
    function closeProjectDetailsModal() {
        const modal = document.getElementById('projectDetailsModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }
    
    // التقدم للاستثمار في المشروع - تم تحديثها لعرض خريطة مواقع الاستثمار
    function applyForProject() {
        // العثور على المشروع بواسطة المعرف
        const project = projects.find(p => p.id === currentProject);
        if (!project) {
            console.error('المشروع غير موجود:', currentProject);
            return;
        }
        
        // إغلاق نافذة تفاصيل المشروع
        closeProjectDetailsModal();
        
        // تحميل مواقع الاستثمار من Firebase
        loadInvestmentLocations().then(() => {
            // عرض نافذة مواقع الاستثمار
            showInvestmentLocationsModal(project);
        });
    }

    // فتح نافذة مواقع الاستثمار
    function showInvestmentLocationsModal(project) {
        // عرض مقرات الشركة
        renderOfficesList();
        
        // عرض خيارات المشرف إذا كان في وضع المشرف
        const adminMapControls = document.getElementById('adminMapControls');
        if (adminMapControls) {
            adminMapControls.style.display = isAdminMode ? 'flex' : 'none';
        }
        
        // عرض النافذة
        document.getElementById('investmentLocationsModal').classList.add('active');
        
        // تهيئة الخريطة بعد ظهور النافذة (تأخير صغير لضمان تحميل العناصر)
        setTimeout(() => {
            initMap();
        }, 300);
    }

    // إغلاق نافذة مواقع الاستثمار
    function closeInvestmentLocationsModal() {
        document.getElementById('investmentLocationsModal').classList.remove('active');
    }

    // عرض مقرات الشركة
    function renderOfficesList() {
        const officesList = document.getElementById('officesList');
        if (!officesList) return;
        
        officesList.innerHTML = '';
        
        companyOffices.forEach(office => {
            const officeCard = document.createElement('div');
            officeCard.className = 'notification-item';
            officeCard.style.cursor = 'pointer';
            officeCard.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${office.name}</div>
                    <div class="notification-message">${office.address}</div>
                    <div class="notification-date">
                        <i class="fas fa-phone" style="margin-left: 5px;"></i> ${office.phone}
                    </div>
                </div>
            `;
            
            // إضافة حدث النقر لتوجيه الخريطة إلى موقع المقر
            officeCard.addEventListener('click', () => {
                if (map) {
                    map.setCenter(office.location);
                    map.setZoom(15);
                    
                    // العثور على العلامة المناسبة وفتح نافذة المعلومات الخاصة بها
                    markers.forEach(marker => {
                        if (marker.title === office.name) {
                            google.maps.event.trigger(marker, 'click');
                        }
                    });
                }
            });
            
            officesList.appendChild(officeCard);
        });
    }

    // تهيئة الخريطة
    function initMap() {
        const mapContainer = document.getElementById('investmentMap');
        if (!mapContainer) return;
        
        // إذا كانت واجهة برمجة خرائط Google غير محملة، قم بتحميلها
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            // إنشاء وإضافة نص في النافذة لإخبار المستخدم أنه يجب إضافة مفتاح الواجهة البرمجية
            mapContainer.innerHTML = `
                <div style="padding: 20px; text-align: center; background-color: rgba(17, 24, 39, 0.8); border-radius: 10px;">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">تحتاج إلى إضافة مفتاح واجهة برمجة خرائط Google</h3>
                    <p style="color: var(--text-light);">للمشرف: قم بإضافة سكريبت الخرائط في رأس الصفحة أو استخدم خدمة خرائط بديلة</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">مقرات الشركة موجودة في:</p>
                        <ul style="text-align: right; padding-right: 20px; margin-top: 10px;">
                            <li style="color: var(--text-light); margin-bottom: 5px;">الحلة: شارع 40، بالقرب من مصرف الرافدين</li>
                            <li style="color: var(--text-light); margin-bottom: 5px;">بغداد: المنصور، شارع 14 رمضان</li>
                            <li style="color: var(--text-light); margin-bottom: 5px;">النجف: حي السلام، بالقرب من المسجد الكبير</li>
                        </ul>
                    </div>
                </div>
            `;
            return;
        }
        
        // مسح العلامات الحالية
        markers.forEach(marker => {
            marker.setMap(null);
        });
        markers = [];
        
        // إنشاء الخريطة
        map = new google.maps.Map(mapContainer, {
            center: { lat: 33.3152, lng: 44.3661 }, // بغداد كمركز افتراضي
            zoom: 7,
            styles: [ // نمط خريطة داكن مناسب للواجهة
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
                { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
                { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
                { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
                { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
                { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
            ]
        });
        
        // إضافة حدث النقر على الخريطة لإضافة مواقع جديدة (في وضع المشرف فقط)
        map.addListener('click', function(event) {
            if (isAdminMode && isAddLocationMode) {
                addMarker(event.latLng);
            }
        });
        
        // إضافة العلامات لمقرات الشركة
        companyOffices.forEach(office => {
            const marker = new google.maps.Marker({
                position: office.location,
                map: map,
                title: office.name,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                }
            });
            
            // إضافة نافذة معلومات عند النقر على العلامة
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="marker-info-window">
                        <h3>${office.name}</h3>
                        <p>${office.address}</p>
                        <p><strong>هاتف:</strong> ${office.phone}</p>
                        <p><strong>بريد إلكتروني:</strong> ${office.email}</p>
                    </div>
                `
            });
            
            marker.addListener('click', function() {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
                infoWindow.open(map, marker);
                currentInfoWindow = infoWindow;
            });
            
            markers.push(marker);
        });
        
        // إضافة مواقع الاستثمار المحفوظة
        investmentLocations.forEach((location, index) => {
            addLocationMarker(location, index);
        });
    }

    // تنفيذ إضافة علامة لموقع استثمار
    function addLocationMarker(location, index) {
        const marker = new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: location.name || 'موقع استثمار',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
            },
            draggable: isAdminMode // يمكن سحب العلامة فقط في وضع المشرف
        });
        
        // إضافة نافذة معلومات
        const infoWindow = new google.maps.InfoWindow({
            content: isAdminMode ? 
                `
                    <div class="marker-info-window">
                        <input type="text" id="marker-name-${index}" placeholder="اسم الموقع" value="${location.name || ''}" style="width: 100%; margin-bottom: 5px; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <textarea id="marker-description-${index}" placeholder="وصف الموقع" style="width: 100%; margin-bottom: 5px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; height: 60px;">${location.description || ''}</textarea>
                        <button onclick="updateMarkerInfo(${index})" style="background-color: #188038; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">حفظ</button>
                        <button onclick="removeMarker(${index})" style="background-color: #ea4335; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">حذف</button>
                    </div>
                ` : 
                `
                    <div class="marker-info-window">
                        <h3>${location.name || 'موقع استثمار'}</h3>
                        <p>${location.description || 'موقع مشروع استثماري متاح'}</p>
                    </div>
                `
        });
        
        marker.addListener('click', function() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            infoWindow.open(map, marker);
            currentInfoWindow = infoWindow;
        });
        
        // مستمع لحدث تغيير الموقع
        if (isAdminMode) {
            marker.addListener('dragend', function() {
                if (index < investmentLocations.length) {
                    investmentLocations[index].lat = marker.getPosition().lat();
                    investmentLocations[index].lng = marker.getPosition().lng();
                }
            });
        }
        
        markers.push(marker);
    }

    // إضافة علامة جديدة على الخريطة
    function addMarker(location) {
        // إنشاء معلومات الموقع
        const locationInfo = {
            lat: location.lat(),
            lng: location.lng(),
            name: 'موقع استثمار جديد',
            description: 'موقع مشروع استثماري متاح'
        };
        
        // إضافة الموقع إلى المصفوفة
        investmentLocations.push(locationInfo);
        
        // إضافة علامة للموقع
        const index = investmentLocations.length - 1;
        addLocationMarker(locationInfo, index);
        
        // فتح نافذة المعلومات للموقع الجديد
        if (markers.length > 0) {
            const newMarker = markers[markers.length - 1];
            google.maps.event.trigger(newMarker, 'click');
        }
    }

    // تحديث معلومات العلامة
    function updateMarkerInfo(markerIndex) {
        if (markerIndex >= investmentLocations.length) return;
        
        // الحصول على القيم المدخلة
        const nameInput = document.getElementById(`marker-name-${markerIndex}`);
        const descriptionInput = document.getElementById(`marker-description-${markerIndex}`);
        
        if (nameInput && descriptionInput) {
            // تحديث المعلومات
            investmentLocations[markerIndex].name = nameInput.value || 'موقع استثمار';
            investmentLocations[markerIndex].description = descriptionInput.value || 'موقع مشروع استثماري متاح';
            
            // إغلاق نافذة المعلومات
            if (currentInfoWindow) {
                currentInfoWindow.close();
                
                // تحديث محتوى نافذة المعلومات
                const marker = markers[markerIndex + companyOffices.length];
                if (marker) {
                    // إنشاء نافذة معلومات جديدة
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="marker-info-window">
                                <input type="text" id="marker-name-${markerIndex}" placeholder="اسم الموقع" value="${investmentLocations[markerIndex].name}" style="width: 100%; margin-bottom: 5px; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                                <textarea id="marker-description-${markerIndex}" placeholder="وصف الموقع" style="width: 100%; margin-bottom: 5px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; height: 60px;">${investmentLocations[markerIndex].description}</textarea>
                                <button onclick="updateMarkerInfo(${markerIndex})" style="background-color: #188038; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">حفظ</button>
                                <button onclick="removeMarker(${markerIndex})" style="background-color: #ea4335; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">حذف</button>
                            </div>
                        `
                    });
                    
                    // استبدال مستمع النقر
                    google.maps.event.clearListeners(marker, 'click');
                    marker.addListener('click', function() {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });
                }
                
                // إظهار رسالة نجاح
                createNotification('تم التحديث', 'تم تحديث معلومات الموقع بنجاح', 'success');
            }
        }
    }

    // إزالة علامة
    function removeMarker(markerIndex) {
        // تحويل الفهرس لمراعاة مقرات الشركة
        const actualIndex = markerIndex + companyOffices.length;
        
        if (actualIndex >= markers.length) return;
        
        // إزالة العلامة من الخريطة
        markers[actualIndex].setMap(null);
        
        // إزالة الموقع من المصفوفة
        if (markerIndex < investmentLocations.length) {
            investmentLocations.splice(markerIndex, 1);
        }
        
        // إزالة العلامة من المصفوفة
        markers.splice(actualIndex, 1);
        
        // إغلاق نافذة المعلومات
        if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
        }
        
        // إظهار رسالة نجاح
        createNotification('تم الحذف', 'تم حذف الموقع بنجاح', 'info');
    }

    // تبديل وضع إضافة موقع جديد
    function toggleAddLocationMode() {
        isAddLocationMode = !isAddLocationMode;
        
        // إظهار رسالة للمستخدم
        createNotification(
            isAddLocationMode ? 'وضع إضافة موقع مفعل' : 'تم إلغاء وضع إضافة موقع',
            isAddLocationMode ? 'انقر على الخريطة لإضافة مواقع استثمار جديدة' : 'تم إلغاء وضع إضافة المواقع',
            'info'
        );
        
        // تغيير مؤشر الخريطة
        if (map) {
            map.setOptions({
                draggableCursor: isAddLocationMode ? 'crosshair' : null
            });
        }
    }

    // حفظ مواقع الاستثمار
    async function saveLocations() {
        if (!isAdminMode) return;
        
        try {
            showLoading();
            
            // الحصول على المشروع الحالي
            const project = projects.find(p => p.id === currentProject);
            if (!project) {
                throw new Error('المشروع غير موجود');
            }
            
            // حفظ المواقع في Firebase
            await database.ref(`${PROJECTS_PATH}/${currentProject}/locations`).set(investmentLocations);
            
            // تحديث المشروع في المصفوفة المحلية
            const projectIndex = projects.findIndex(p => p.id === currentProject);
            if (projectIndex !== -1) {
                projects[projectIndex].locations = investmentLocations;
            }
            
            // عرض رسالة نجاح
            createNotification('تم حفظ المواقع', 'تم حفظ مواقع الاستثمار بنجاح', 'success');
        } catch (error) {
            console.error('خطأ في حفظ المواقع:', error);
            createNotification('خطأ في حفظ المواقع', error.message, 'danger');
        } finally {
            hideLoading();
        }
    }

    // تحميل مواقع الاستثمار من Firebase
    async function loadInvestmentLocations() {
        try {
            // الحصول على المشروع الحالي
            const project = projects.find(p => p.id === currentProject);
            if (!project) {
                console.error('المشروع غير موجود:', currentProject);
                return;
            }
            
            // تحميل المواقع من Firebase
            const locationsRef = database.ref(`${PROJECTS_PATH}/${currentProject}/locations`);
            const snapshot = await locationsRef.once('value');
            
            if (snapshot.exists()) {
                // تحديث المصفوفة المحلية
                investmentLocations = snapshot.val();
            } else {
                // إنشاء مواقع افتراضية إذا لم تكن موجودة
                investmentLocations = generateDefaultLocations(project);
            }
        } catch (error) {
            console.error('خطأ في تحميل مواقع الاستثمار:', error);
            // استخدام مواقع افتراضية في حالة الخطأ
            investmentLocations = generateDefaultLocations();
        }
    }

    // إنشاء مواقع افتراضية للمشروع
    function generateDefaultLocations(project) {
        // إذا كان هناك مشروع، أنشئ موقعًا افتراضيًا قرب مدينة الحلة
        if (project) {
            // إنشاء موقع بالقرب من مدينة الحلة مع تغيير طفيف لكل مشروع
            const randomLat = 32.4722 + (Math.random() * 0.1 - 0.05);
            const randomLng = 44.4134 + (Math.random() * 0.1 - 0.05);
            
            return [
                {
                    lat: randomLat,
                    lng: randomLng,
                    name: 'موقع مشروع ' + project.title,
                    description: 'موقع مقترح لمشروع ' + project.title + ' - يمكنك زيارة أحد مقراتنا للحصول على تفاصيل أكثر.'
                }
            ];
        }
        
        // إرجاع مصفوفة فارغة في حالة عدم وجود مشروع
        return [];
    }

    // تأكيد الاستثمار
    function confirmInvestment() {
        // العثور على المشروع بواسطة المعرف
        const project = projects.find(p => p.id === currentProject);
        if (!project) {
            console.error('المشروع غير موجود:', currentProject);
            return;
        }
        
        // إغلاق نافذة مواقع الاستثمار
        closeInvestmentLocationsModal();
        
        // عرض رسالة نجاح
        createNotification(
            'تم تقديم الطلب',
            'تم استلام طلب الاستثمار بنجاح وسيتم التواصل معك قريباً',
            'success'
        );
        
        // إنشاء إشعار للمستخدم
        const notification = {
            id: generateId(),
            title: 'طلب استثمار جديد',
            message: `تم استلام طلب الاستثمار في ${project.title} بنجاح وسيتم مراجعته قريباً`,
            type: 'investment',
            read: false,
            date: new Date().toISOString(),
            status: 'pending'
        };
        
        // إضافة الإشعار إلى المصفوفة
        notifications.unshift(notification);
        
        // تحديث عدد الإشعارات غير المقروءة وإظهار المؤشر
        updateUnreadCount();
        showNotificationIndicator();
        
        // حفظ الإشعار في Firebase
        database.ref(`${NOTIFICATIONS_PATH}/${notification.id}`).set(notification)
            .catch(error => console.error('خطأ في حفظ الإشعار:', error));
        
        // استخراج قيمة الاستثمار
        const investmentAmount = parseFloat(project.minInvestment.replace(/[^\d.]/g, ''));
        
        // إنشاء عملية استثمار جديدة
        const operation = {
            id: generateId(),
            type: 'investment',
            amount: investmentAmount,
            date: new Date().toISOString(),
            status: 'pending',
            description: `استثمار في ${project.title}`,
            investorId: currentInvestor.id,
            investorName: currentInvestor.name,
            projectId: project.id,
            projectTitle: project.title
        };
        
        // حفظ العملية في Firebase
        database.ref(`${OPERATIONS_PATH}/${operation.id}`).set(operation)
            .catch(error => console.error('خطأ في حفظ العملية:', error));
        
        // إضافة العملية إلى مصفوفة العمليات
        if (!currentCard.recentOperations) {
            currentCard.recentOperations = [];
        }
        
        currentCard.recentOperations.unshift(operation);
        localStorage.setItem('investorCard', JSON.stringify(currentCard));
        
        // تحديث النشاطات الأخيرة
        loadRecentActivities();
    }
    
    // وظائف إدارة المشاريع
    
    // التحقق من حقوق المشرف
    function checkAdminRights() {
        // في البيئة الحقيقية، يمكن التحقق من حقوق المستخدم عبر Firebase Authentication
        // لغرض الاختبار، سنضع مفتاح في localStorage لتفعيل ميزات المشرف
        
        isAdminMode = localStorage.getItem('adminMode') === 'true';
        toggleAdminUI(isAdminMode);
    }
    
    // تبديل وضع المشرف
    function toggleAdminMode() {
        isAdminMode = !isAdminMode;
        localStorage.setItem('adminMode', isAdminMode);
        
        // عرض/إخفاء عناصر واجهة المشرف
        toggleAdminUI(isAdminMode);
        
        // عرض القائمة المنسدلة
        const adminDropdown = document.getElementById('adminDropdown');
        if (adminDropdown) {
            adminDropdown.classList.toggle('active', isAdminMode);
        }
        
        // تحديث حالة مفتاح التبديل
        const adminSwitch = document.getElementById('adminModeSwitch');
        if (adminSwitch) {
            adminSwitch.classList.toggle('active', isAdminMode);
        }
    }
    
    // تبديل عناصر واجهة المشرف
    function toggleAdminUI(isAdmin) {
        // عرض/إخفاء زر إضافة مشروع
        const addProjectBtn = document.getElementById('addProjectBtn');
        if (addProjectBtn) {
            addProjectBtn.style.display = isAdmin ? 'flex' : 'none';
        }
        
        // عرض/إخفاء مفتاح وضع المشرف
        const adminSwitch = document.getElementById('adminModeSwitch');
        if (adminSwitch) {
            adminSwitch.style.display = isAdmin ? 'flex' : 'none';
            adminSwitch.classList.toggle('active', isAdmin);
        }
        
        // عرض/إخفاء زر إضافة تصنيف
        const categoriesAction = document.getElementById('categoriesAction');
        if (categoriesAction) {
            categoriesAction.style.display = isAdmin ? 'flex' : 'none';
        }
    }
    
    // تبديل وضع تحرير المشاريع
    function toggleProjectEditMode() {
        isProjectEditMode = !isProjectEditMode;
        
        // إغلاق القائمة المنسدلة
        document.getElementById('adminDropdown').classList.remove('active');
        
        // إعادة عرض المشاريع مع/بدون أزرار التحرير
        displayProjects();
        
        // إظهار إشعار
        createNotification(
            isProjectEditMode ? 'وضع التحرير مفعل' : 'تم إلغاء وضع التحرير',
            isProjectEditMode ? 'يمكنك الآن تعديل أو حذف المشاريع' : 'تم إلغاء وضع تحرير المشاريع',
            'info'
        );
    }
    
    // فتح نافذة إضافة مشروع جديد
    function openAddProjectModal() {
        // مسح النموذج
        document.getElementById('addProjectForm').reset();
        
        // مسح معاينة الصورة
        const imagePreview = document.getElementById('projectImagePreview');
        imagePreview.style.backgroundImage = '';
        imagePreview.querySelector('.image-preview-text').style.display = 'flex';
        
        // مسح مميزات المشروع
        document.getElementById('projectFeatures').innerHTML = '';
        
        // مسح رسائل الخطأ والنجاح
        document.getElementById('addProjectError').style.display = 'none';
        document.getElementById('addProjectSuccess').style.display = 'none';
        
        // تحميل التصنيفات
        updateCategoriesUI();
        
        // إعادة تعيين ملف الصورة
        projectImageFile = null;
        
        // عرض النافذة
        document.getElementById('addProjectModal').classList.add('active');
    }
    
    // إغلاق نافذة إضافة مشروع جديد
    function closeAddProjectModal() {
        document.getElementById('addProjectModal').classList.remove('active');
    }
    
    // تشغيل محدد الصورة
    function triggerImageUpload() {
        document.getElementById('projectImageUpload').click();
    }
    
    // معاينة صورة المشروع المختارة
    function previewProjectImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const preview = document.getElementById('projectImagePreview');
                preview.style.backgroundImage = `url('${e.target.result}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                preview.querySelector('.image-preview-text').style.display = 'none';
                
                // حفظ الملف للتحميل
                projectImageFile = input.files[0];
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // تحميل صورة إلى Firebase Storage
    async function uploadProjectImage(imageFile, projectId) {
        if (!imageFile) {
            return null; // لا توجد صورة للتحميل
        }
        
        try {
            // إنشاء مسار التخزين للصورة
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`projects/${projectId}/${Date.now()}_${imageFile.name}`);
            
            // تحميل الصورة
            const snapshot = await imageRef.put(imageFile);
            
            // الحصول على رابط التنزيل
            const downloadURL = await snapshot.ref.getDownloadURL();
            
            return downloadURL;
        } catch (error) {
            console.error('خطأ في تحميل الصورة:', error);
            throw error;
        }
    }
    
    // إرسال مشروع جديد
    async function submitNewProject(event) {
        event.preventDefault();
        showLoading();
        
        try {
            // جمع بيانات المشروع من النموذج
            const title = document.getElementById('projectTitle').value;
            const category = document.getElementById('projectCategory').value;
            const returnValue = document.getElementById('projectReturn').value;
            const duration = document.getElementById('projectDuration').value;
            const minInvestment = document.getElementById('projectMinInvestment').value;
            const totalValue = document.getElementById('projectTotalValue').value;
            const description = document.getElementById('projectDescription').value;
            const featuresText = document.getElementById('projectFeatures').innerHTML;
            const icon = document.getElementById('projectIcon').value;
            
            // تحويل مميزات المشروع من HTML إلى مصفوفة
            const features = featuresText
                .split('<br>')
                .map(feature => feature.trim())
                .filter(feature => feature.length > 0);
            
            // التحقق من البيانات الإلزامية
            if (!title || !category || !returnValue || !duration || !minInvestment || !description) {
                throw new Error('يرجى ملء جميع الحقول الإلزامية');
            }
            
            // إنشاء معرف فريد للمشروع
            const projectId = generateId();
            
            // تحميل الصورة إذا تم اختيارها
            let imageUrl = 'https://cdn.pixabay.com/photo/2018/01/10/23/53/buildings-3075053_1280.jpg'; // صورة افتراضية
            
            if (projectImageFile) {
                imageUrl = await uploadProjectImage(projectImageFile, projectId);
            }
            
            // إنشاء كائن المشروع
            const project = {
                title,
                category,
                return: returnValue,
                duration,
                minInvestment,
                totalValue,
                description,
                features,
                imageUrl,
                icon,
                created_at: new Date().toISOString()
            };
            
            // حفظ المشروع في Firebase
            await database.ref(`${PROJECTS_PATH}/${projectId}`).set(project);
            
            // إضافة المشروع إلى المصفوفة المحلية
            projects.push({
                id: projectId,
                ...project
            });
            
            // عرض رسالة نجاح
            document.getElementById('addProjectSuccess').textContent = 'تم إضافة المشروع بنجاح!';
            document.getElementById('addProjectSuccess').style.display = 'block';
            
            // إعادة عرض المشاريع
            displayProjects();
            
            // إغلاق النافذة بعد 2 ثانية
            setTimeout(() => {
                closeAddProjectModal();
            }, 2000);
        } catch (error) {
            console.error('خطأ في إضافة المشروع:', error);
            
            // عرض رسالة الخطأ
            document.getElementById('addProjectError').textContent = error.message || 'حدث خطأ في إضافة المشروع';
            document.getElementById('addProjectError').style.display = 'block';
        } finally {
            hideLoading();
        }
    }
    
    // فتح نافذة إضافة تصنيف جديد
    function openAddCategoryModal() {
        // مسح النموذج
        document.getElementById('addCategoryForm').reset();
        
        // مسح رسائل الخطأ والنجاح
        document.getElementById('addCategoryError').style.display = 'none';
        document.getElementById('addCategorySuccess').style.display = 'none';
        
        // إغلاق القائمة المنسدلة
        document.getElementById('adminDropdown').classList.remove('active');
        
        // عرض النافذة
        document.getElementById('addCategoryModal').classList.add('active');
    }
    
    // إغلاق نافذة إضافة تصنيف جديد
    function closeAddCategoryModal() {
        document.getElementById('addCategoryModal').classList.remove('active');
    }
    
    // إرسال تصنيف جديد
    async function submitNewCategory(event) {
        event.preventDefault();
        showLoading();
        
        try {
            // جمع بيانات التصنيف من النموذج
            const name = document.getElementById('categoryName').value;
            const id = document.getElementById('categoryId').value;
            
            // التحقق من البيانات
            if (!name || !id) {
                throw new Error('يرجى ملء جميع الحقول');
            }
            
            // التحقق من عدم وجود تصنيف بنفس المعرف
            const existingCategory = categories.find(c => c.id === id);
            if (existingCategory) {
                throw new Error('يوجد تصنيف بنفس المعرف، يرجى اختيار معرف آخر');
            }
            
            // إنشاء كائن التصنيف
            const category = {
                name,
                created_at: new Date().toISOString()
            };
            
            // حفظ التصنيف في Firebase
            await database.ref(`${CATEGORIES_PATH}/${id}`).set(category);
            
            // إضافة التصنيف إلى المصفوفة المحلية
            categories.push({
                id,
                ...category
            });
            
            // عرض رسالة نجاح
            document.getElementById('addCategorySuccess').textContent = 'تم إضافة التصنيف بنجاح!';
            document.getElementById('addCategorySuccess').style.display = 'block';
            
            // تحديث واجهة المستخدم
            updateCategoriesUI();
            
            // إغلاق النافذة بعد 2 ثانية
            setTimeout(() => {
                closeAddCategoryModal();
            }, 2000);
        } catch (error) {
            console.error('خطأ في إضافة التصنيف:', error);
            
            // عرض رسالة الخطأ
            document.getElementById('addCategoryError').textContent = error.message || 'حدث خطأ في إضافة التصنيف';
            document.getElementById('addCategoryError').style.display = 'block';
        } finally {
            hideLoading();
        }
    }
    
    // فتح نافذة إدارة التصنيفات
    function openManageCategoriesModal() {
        // مسح القائمة الحالية
        document.getElementById('categoriesList').innerHTML = '';
        
        // إضافة التصنيفات
        categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'detail-item';
            categoryItem.innerHTML = `
                <div class="detail-label">${category.name}</div>
                <div class="detail-value" style="display: flex; gap: 10px;">
                    <button class="admin-btn edit" onclick="editCategory('${category.id}')" style="background: rgba(33, 150, 243, 0.6);">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="admin-btn delete" onclick="deleteCategory('${category.id}')" style="background: rgba(255, 82, 82, 0.6);">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            document.getElementById('categoriesList').appendChild(categoryItem);
        });
        
        // إغلاق القائمة المنسدلة
        document.getElementById('adminDropdown').classList.remove('active');
        
        // عرض النافذة
        document.getElementById('manageCategoriesModal').classList.add('active');
    }
    
    // إغلاق نافذة إدارة التصنيفات
    function closeManageCategoriesModal() {
        document.getElementById('manageCategoriesModal').classList.remove('active');
    }
    
    // تعديل تصنيف
    function editCategory(categoryId) {
        // للتبسيط، سنقوم بحذف التصنيف وإضافة جديد
        closeManageCategoriesModal();
        openAddCategoryModal();
        
        // البحث عن التصنيف
        const category = categories.find(c => c.id === categoryId);
        if (category) {
            // ملء النموذج بالبيانات الحالية
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryId').value = categoryId;
        }
    }
    
    // حذف تصنيف
    async function deleteCategory(categoryId) {
        if (!confirm('هل أنت متأكد من حذف هذا التصنيف؟')) {
            return;
        }
        
        showLoading();
        
        try {
            // التحقق من وجود مشاريع تستخدم هذا التصنيف
            const categoryProjects = projects.filter(p => p.category === categoryId);
            if (categoryProjects.length > 0) {
                throw new Error(`لا يمكن حذف التصنيف لأنه يحتوي على ${categoryProjects.length} مشاريع. قم بنقلها إلى تصنيف آخر أولاً.`);
            }
            
            // حذف التصنيف من Firebase
            await database.ref(`${CATEGORIES_PATH}/${categoryId}`).remove();
            
            // حذف التصنيف من المصفوفة المحلية
            categories = categories.filter(c => c.id !== categoryId);
            
            // تحديث واجهة المستخدم
            updateCategoriesUI();
            
            // إعادة فتح نافذة إدارة التصنيفات
            openManageCategoriesModal();
            
            // عرض إشعار نجاح
            createNotification('تم حذف التصنيف', 'تم حذف التصنيف بنجاح', 'success');
        } catch (error) {
            console.error('خطأ في حذف التصنيف:', error);
            
            // عرض إشعار خطأ
            createNotification('خطأ في حذف التصنيف', error.message, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // تعديل مشروع
    function editProject(projectId) {
        // البحث عن المشروع
        const project = projects.find(p => p.id === projectId);
        if (!project) {
            console.error('المشروع غير موجود:', projectId);
            return;
        }
        
        // فتح نافذة التعديل
        openEditProjectModal(project);
    }
    
    // فتح نافذة تعديل مشروع
    function openEditProjectModal(project) {
        // ملء النموذج بالبيانات الحالية
        document.getElementById('editProjectId').value = project.id;
        document.getElementById('editProjectTitle').value = project.title;
        document.getElementById('editProjectCategory').value = project.category;
        document.getElementById('editProjectReturn').value = project.return;
        document.getElementById('editProjectDuration').value = project.duration;
        document.getElementById('editProjectMinInvestment').value = project.minInvestment;
        document.getElementById('editProjectTotalValue').value = project.totalValue || '';
        document.getElementById('editProjectDescription').value = project.description;
        document.getElementById('editProjectIcon').value = project.icon || 'building';
        
        // تعيين مميزات المشروع
        if (project.features && project.features.length > 0) {
            document.getElementById('editProjectFeatures').innerHTML = project.features.join('<br>');
        } else {
            document.getElementById('editProjectFeatures').innerHTML = '';
        }
        
        // تعيين معاينة الصورة
        const imagePreview = document.getElementById('editProjectImagePreview');
        imagePreview.style.backgroundImage = `url('${project.imageUrl}')`;
        imagePreview.style.backgroundSize = 'cover';
        imagePreview.style.backgroundPosition = 'center';
        imagePreview.querySelector('.image-preview-text').style.display = 'none';
        
        // مسح رسائل الخطأ والنجاح
        document.getElementById('editProjectError').style.display = 'none';
        document.getElementById('editProjectSuccess').style.display = 'none';
        
        // إعادة تعيين متغير التحقق من تغيير الصورة
        editImageChanged = false;
        
        // عرض النافذة
        document.getElementById('editProjectModal').classList.add('active');
    }
    
    // إغلاق نافذة تعديل مشروع
    function closeEditProjectModal() {
        document.getElementById('editProjectModal').classList.remove('active');
    }
    
    // تشغيل محدد الصورة للتعديل
    function triggerEditImageUpload() {
        document.getElementById('editProjectImageUpload').click();
    }
    
    // معاينة صورة المشروع المعدلة
    function previewEditProjectImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const preview = document.getElementById('editProjectImagePreview');
                preview.style.backgroundImage = `url('${e.target.result}')`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                preview.querySelector('.image-preview-text').style.display = 'none';
                
                // تعيين متغير لتأكيد تغيير الصورة
                editImageChanged = true;
                projectImageFile = input.files[0];
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // إرسال تعديلات المشروع
    async function submitEditProject(event) {
        event.preventDefault();
        showLoading();
        
        try {
            // جمع بيانات المشروع من النموذج
            const projectId = document.getElementById('editProjectId').value;
            const title = document.getElementById('editProjectTitle').value;
            const category = document.getElementById('editProjectCategory').value;
            const returnValue = document.getElementById('editProjectReturn').value;
            const duration = document.getElementById('editProjectDuration').value;
            const minInvestment = document.getElementById('editProjectMinInvestment').value;
            const totalValue = document.getElementById('editProjectTotalValue').value;
            const description = document.getElementById('editProjectDescription').value;
            const featuresText = document.getElementById('editProjectFeatures').innerHTML;
            const icon = document.getElementById('editProjectIcon').value;
            
            // تحويل مميزات المشروع من HTML إلى مصفوفة
            const features = featuresText
                .split('<br>')
                .map(feature => feature.trim())
                .filter(feature => feature.length > 0);
            
            // التحقق من البيانات الإلزامية
            if (!title || !category || !returnValue || !duration || !minInvestment || !description) {
                throw new Error('يرجى ملء جميع الحقول الإلزامية');
            }
            
            // البحث عن المشروع الحالي للحصول على الصورة
            const existingProject = projects.find(p => p.id === projectId);
            if (!existingProject) {
                throw new Error('المشروع غير موجود');
            }
            
            // تحميل الصورة الجديدة إذا تم تغييرها
            let imageUrl = existingProject.imageUrl;
            
            if (editImageChanged && projectImageFile) {
                imageUrl = await uploadProjectImage(projectImageFile, projectId);
            }
            
            // إنشاء كائن المشروع المعدل
            const updatedProject = {
                title,
                category,
                return: returnValue,
                duration,
                minInvestment,
                totalValue,
                description,
                features,
                imageUrl,
                icon,
                updated_at: new Date().toISOString()
            };
            
            // حفظ التعديلات في Firebase
            await database.ref(`${PROJECTS_PATH}/${projectId}`).update(updatedProject);
            
            // تحديث المشروع في المصفوفة المحلية
            const projectIndex = projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                projects[projectIndex] = {
                    id: projectId,
                    ...updatedProject,
                    created_at: existingProject.created_at // الاحتفاظ بتاريخ الإنشاء الأصلي
                };
            }
            
            // عرض رسالة نجاح
            document.getElementById('editProjectSuccess').textContent = 'تم تحديث المشروع بنجاح!';
            document.getElementById('editProjectSuccess').style.display = 'block';
            
            // إعادة عرض المشاريع
            displayProjects();
            
            // إغلاق النافذة بعد 2 ثانية
            setTimeout(() => {
                closeEditProjectModal();
            }, 2000);
        } catch (error) {
            console.error('خطأ في تحديث المشروع:', error);
            
            // عرض رسالة الخطأ
            document.getElementById('editProjectError').textContent = error.message || 'حدث خطأ في تحديث المشروع';
            document.getElementById('editProjectError').style.display = 'block';
        } finally {
            hideLoading();
        }
    }
    
    // تأكيد حذف مشروع
    function confirmDeleteProject(projectId) {
        if (confirm('هل أنت متأكد من حذف هذا المشروع؟')) {
            deleteProject(projectId);
        }
    }
    
    // حذف مشروع
    async function deleteProject(projectId) {
        showLoading();
        
        try {
            // حذف المشروع من Firebase
            await database.ref(`${PROJECTS_PATH}/${projectId}`).remove();
            
            // حذف المشروع من المصفوفة المحلية
            projects = projects.filter(p => p.id !== projectId);
            
            // إعادة عرض المشاريع
            displayProjects();
            
            // عرض إشعار نجاح
            createNotification('تم حذف المشروع', 'تم حذف المشروع بنجاح', 'success');
            
            // إغلاق نافذة التعديل إذا كانت مفتوحة
            closeEditProjectModal();
        } catch (error) {
            console.error('خطأ في حذف المشروع:', error);
            
            // عرض إشعار خطأ
            createNotification('خطأ في حذف المشروع', error.message, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // وظائف واجهة المستخدم الإضافية
    
    // تبديل عرض خانة البحث
    function toggleSearch() {
        const searchContainer = document.getElementById('searchContainer');
        searchContainer.classList.toggle('active');
        
        if (searchContainer.classList.contains('active')) {
            // التركيز على حقل البحث
            setTimeout(() => {
                document.getElementById('searchInput').focus();
            }, 300);
        } else {
            // مسح البحث وإعادة عرض جميع المشاريع
            document.getElementById('searchInput').value = '';
            displayProjects();
        }
    }
    
    // تحسين وظيفة طلب السحب
    async function openWithdrawModal() {
        document.getElementById('withdrawModal').classList.add('active');
        
        try {
            // تحديث المبلغ المتاح للسحب من البيانات الحالية
            // احصل على أحدث بيانات البطاقة من قاعدة البيانات
            if (currentCard && currentCard.id) {
                const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
                const snapshot = await cardRef.once('value');
                const updatedCard = snapshot.val();
                
                if (updatedCard) {
                    // تحديث البيانات المحلية
                    currentCard = updatedCard;
                    localStorage.setItem('investorCard', JSON.stringify(currentCard));
                }
            }
            
            // عرض المبلغ المتاح للسحب
            document.getElementById('availableBalance').value = formatCurrency(currentCard.dueProfit || 0);
            
            // إضافة رقم البطاقة
            const withdrawCardNumber = document.getElementById('withdrawCardNumber');
            if (withdrawCardNumber) {
                withdrawCardNumber.textContent = formatCardNumberDisplay(currentCard.cardNumber);
            }
            
            // إضافة الحد الأدنى والأقصى
            const withdrawMinAmount = document.getElementById('withdrawMinAmount');
            if (withdrawMinAmount) {
                // تحديد الحد الأدنى (مثال: 50 دينار)
                const minAmount = 50;
                withdrawMinAmount.textContent = `الحد الأدنى: ${formatCurrency(minAmount)}`;
                
                // تعيين قيمة الحد الأدنى في حقل المبلغ
                document.getElementById('withdrawAmount').min = minAmount;
            }
            
            const withdrawMaxAmount = document.getElementById('withdrawMaxAmount');
            if (withdrawMaxAmount) {
                // تحديد الحد الأقصى (مبلغ الأرباح المستحقة)
                const maxAmount = currentCard.dueProfit || 0;
                withdrawMaxAmount.textContent = `الحد الأقصى: ${formatCurrency(maxAmount)}`;
                
                // تعيين قيمة الحد الأقصى في حقل المبلغ
                document.getElementById('withdrawAmount').max = maxAmount;
            }
        } catch (error) {
            console.error('خطأ في تحديث بيانات طلب السحب:', error);
        }
        
        // إعادة ضبط النموذج
        document.getElementById('withdrawForm').reset();
        document.getElementById('withdrawError').style.display = 'none';
        document.getElementById('withdrawSuccess').style.display = 'none';
        document.getElementById('bankDetailsGroup').style.display = 'none';
        document.getElementById('walletDetailsGroup').style.display = 'none';
    }

    // تحسين وظيفة إرسال طلب السحب
    async function submitWithdrawRequest(event) {
        event.preventDefault();
        showLoading();

        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        const method = document.getElementById('withdrawMethod').value;
        const notes = document.getElementById('withdrawNotes').value;
        
        // الحصول على التفاصيل الإضافية حسب طريقة السحب
        let details = '';
        if (method === 'bank_transfer') {
            details = document.getElementById('bankDetails').value;
            
            // التحقق من صحة تفاصيل البنك
            if (!details) {
                showWithdrawError('يرجى إدخال تفاصيل الحساب البنكي');
                hideLoading();
                return;
            }
        } else if (method === 'e_wallet') {
            details = document.getElementById('walletDetails').value;
            
            // التحقق من صحة تفاصيل المحفظة
            if (!details) {
                showWithdrawError('يرجى إدخال تفاصيل المحفظة الإلكترونية');
                hideLoading();
                return;
            }
        }

        try {
            // التحقق من صحة البيانات
            if (amount <= 0) {
                showWithdrawError('يرجى إدخال مبلغ صحيح');
                hideLoading();
                return;
            }
            
            // احصل على أحدث بيانات البطاقة
            let dueProfit = currentCard.dueProfit || 0;
            
            if (currentCard && currentCard.id) {
                try {
                    const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
                    const snapshot = await cardRef.once('value');
                    const updatedCard = snapshot.val();
                    
                    if (updatedCard) {
                        dueProfit = updatedCard.dueProfit || 0;
                        
                        // تحديث البيانات المحلية
                        currentCard = updatedCard;
                        localStorage.setItem('investorCard', JSON.stringify(currentCard));
                    }
                } catch (cardError) {
                    console.error('خطأ في تحديث بيانات البطاقة:', cardError);
                }
            }
            
            if (amount > dueProfit) {
                showWithdrawError('المبلغ المطلوب أكبر من الرصيد المتاح');
                hideLoading();
                return;
            }
            
            // التحقق من الحد الأدنى للسحب
            const minAmount = 50; // الحد الأدنى للسحب
            if (amount < minAmount) {
                showWithdrawError(`الحد الأدنى للسحب هو ${formatCurrency(minAmount)}`);
                hideLoading();
                return;
            }

            // إنشاء طلب سحب
            const withdrawRequest = {
                id: generateId(),
                type: 'withdrawal',
                investorId: currentInvestor.id,
                investorName: currentInvestor.name,
                cardId: currentCard.id,
                cardNumber: currentCard.cardNumber,
                amount: amount,
                method: method,
                details: details,
                notes: notes,
                status: 'pending',
                requestDate: new Date().toISOString(),
                created_at: new Date().toISOString()
            };

            // حفظ طلب السحب في Firebase
            await database.ref(`${WITHDRAWAL_REQUESTS_PATH}/${withdrawRequest.id}`).set(withdrawRequest);
            
            // إضافة العملية إلى عمليات البطاقة
            const operationId = generateId();
            const operation = {
                id: operationId,
                type: 'withdrawal',
                investorId: currentInvestor.id,
                investorName: currentInvestor.name,
                cardId: currentCard.id,
                cardNumber: currentCard.cardNumber,
                amount: amount,
                date: new Date().toISOString(),
                status: 'pending',
                description: 'طلب سحب قيد المراجعة',
                method: method,
                details: details,
                notes: notes
            };
            
            // حفظ العملية في Firebase
            await database.ref(`${OPERATIONS_PATH}/${operationId}`).set(operation);
            
            // إضافة العملية إلى مصفوفة العمليات المحلية
            if (!currentCard.recentOperations) {
                currentCard.recentOperations = [];
            }
            
            currentCard.recentOperations.push(operation);
            localStorage.setItem('investorCard', JSON.stringify(currentCard));
            
            // إنشاء إشعار للمستخدم
            const notificationId = generateId();
            const notification = {
                id: notificationId,
                title: 'تم استلام طلب السحب',
                message: `تم استلام طلب سحب بقيمة ${formatCurrency(amount)} وسيتم مراجعته في أقرب وقت.`,
                type: 'withdrawal',
                read: false,
                date: new Date().toISOString(),
                investorId: currentInvestor.id,
                amount: amount,
                operation: operation
            };
            
            // حفظ الإشعار في Firebase
            await database.ref(`${NOTIFICATIONS_PATH}/${notificationId}`).set(notification);
            
            // عرض رسالة نجاح
            showWithdrawSuccess('تم إرسال طلب السحب بنجاح. سيتم مراجعة طلبك قريبًا وستتلقى إشعارًا عند معالجته.');
            
            // تحديث صفحة الرئيسية والمعاملات
            loadTransactions();
            
            // تحديث النشاطات الأخيرة
            loadRecentActivities();
            
            // إغلاق النافذة بعد فترة
            setTimeout(() => {
                closeWithdrawModal();
            }, 3000);
        } catch (error) {
            console.error('خطأ في إرسال طلب السحب:', error);
            showWithdrawError('حدث خطأ في إرسال الطلب. الرجاء المحاولة مرة أخرى لاحقًا.');
        } finally {
            hideLoading();
        }
    }

    // دالة لعرض خطأ في نافذة السحب
    function showWithdrawError(message) {
        const errorElement = document.getElementById('withdrawError');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        
        // التمرير إلى رسالة الخطأ
        errorElement.scrollIntoView({ behavior: 'smooth' });
        
        // إخفاء الرسالة بعد 5 ثوان
        setTimeout(() => {
            errorElement.style.display = 'none';
        }, 5000);
    }

    // دالة لعرض رسالة نجاح في نافذة السحب
    function showWithdrawSuccess(message) {
        const successElement = document.getElementById('withdrawSuccess');
        successElement.textContent = message;
        successElement.style.display = 'block';
        
        // التمرير إلى رسالة النجاح
        successElement.scrollIntoView({ behavior: 'smooth' });
    }

    // تحسين دالة إغلاق نافذة السحب
    function closeWithdrawModal() {
        document.getElementById('withdrawModal').classList.remove('active');
        
        // إعادة تحميل البيانات المحلية للتأكد من التحديثات
        loadTransactions();
    }

    // التحقق من حالة طلبات السحب
    async function checkWithdrawalRequestsStatus() {
        try {
            // التحقق من وجود مستثمر حالي
            if (!currentInvestor || !currentInvestor.id) {
                return;
            }
            
            // الحصول على طلبات السحب الحالية
            const withdrawalsRef = database.ref(WITHDRAWAL_REQUESTS_PATH);
            const query = withdrawalsRef.orderByChild('investorId').equalTo(currentInvestor.id);
            const snapshot = await query.once('value');
            
            // المعالجة إذا كان هناك طلبات
            if (snapshot.exists()) {
                const withdrawals = [];
                
                snapshot.forEach(childSnapshot => {
                    withdrawals.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // فرز الطلبات حسب التاريخ (الأحدث أولاً)
                withdrawals.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
                
                // التحقق من طلبات تمت معالجتها مؤخرًا
                const recentWithdrawals = withdrawals.filter(w => {
                    // تحقق من الحالة وما إذا تم التحديث خلال الساعة الماضية
                    const isRecent = new Date(w.requestDate) > new Date(Date.now() - 24 * 60 * 60 * 1000);
                    return isRecent && (w.status === 'completed' || w.status === 'rejected');
                });
                
                // عرض إشعارات للطلبات المعالجة حديثًا
                recentWithdrawals.forEach(withdrawal => {
                    // التحقق من أنه لم يتم إنشاء إشعار مسبقًا
                    const statusText = withdrawal.status === 'completed' ? 'تمت الموافقة على' : 'تم رفض';
                    const message = `${statusText} طلب السحب بقيمة ${formatCurrency(withdrawal.amount)}`;
                    
                    createNotification(
                        withdrawal.status === 'completed' ? 'تم الموافقة على الطلب' : 'تم رفض الطلب',
                        message,
                        withdrawal.status === 'completed' ? 'success' : 'danger'
                    );
                });
            }
        } catch (error) {
            console.error('خطأ في التحقق من حالة طلبات السحب:', error);
        }
    }

    // دالة إنشاء إشعار مرئي
    function createNotification(title, message, type = 'info') {
        // إنشاء عنصر الإشعار
        const notification = document.createElement('div');
        notification.className = `notification-toast ${type}`;
        
        // إضافة المحتوى
        notification.innerHTML = `
            <div class="notification-toast-header">
                <div class="notification-toast-title">${title}</div>
                <button class="notification-toast-close">&times;</button>
            </div>
            <div class="notification-toast-body">${message}</div>
        `;
        
        // إضافة الإشعار إلى الصفحة
        const container = document.getElementById('notificationToastContainer');
        if (!container) {
            // إنشاء حاوية الإشعارات إذا لم تكن موجودة
            const newContainer = document.createElement('div');
            newContainer.id = 'notificationToastContainer';
            newContainer.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                right: 20px;
                z-index: 9999;
                direction: rtl;
            `;
            document.body.appendChild(newContainer);
            newContainer.appendChild(notification);
        } else {
            container.appendChild(notification);
        }
        
        // إضافة سلوك زر الإغلاق
        const closeButton = notification.querySelector('.notification-toast-close');
        closeButton.addEventListener('click', () => {
            notification.classList.add('hiding');
            setTimeout(() => {
                notification.remove();
            }, 300);
        });
        
        // إغلاق الإشعار تلقائيًا بعد 5 ثوان
        setTimeout(() => {
            notification.classList.add('hiding');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 5000);
        
        return notification;
    }

    // Show contact support modal
    function showContactSupport() {
        document.getElementById('supportModal').classList.add('active');
        
        // Reset form
        document.getElementById('supportForm').reset();
        document.getElementById('supportError').style.display = 'none';
        document.getElementById('supportSuccess').style.display = 'none';
    }

    // Close support modal
    function closeSupportModal() {
        document.getElementById('supportModal').classList.remove('active');
    }

    // Submit support request
    async function submitSupportRequest(event) {
        event.preventDefault();
        showLoading();
        
        const topic = document.getElementById('supportTopic').value;
        const message = document.getElementById('supportMessage').value;
        
        try {
            // Validate inputs
            if (!topic || !message) {
                document.getElementById('supportError').textContent = 'يرجى ملء جميع الحقول';
                document.getElementById('supportError').style.display = 'block';
                hideLoading();
                return;
            }
            
            // Create support request
            const supportRequest = {
                id: generateId(),
                investorId: currentInvestor.id,
                investorName: currentInvestor.name,
                phone: currentInvestor.phone,
                email: currentInvestor.email,
                topic: topic,
                message: message,
                status: 'new',
                date: new Date().toISOString()
            };
            
            // Save to Firebase
            await database.ref(`${SUPPORT_REQUESTS_PATH}/${supportRequest.id}`).set(supportRequest);
            
            // Add notification for support request
            const supportNotification = {
                id: generateId(),
                title: 'تم استلام طلب الدعم',
                message: 'تم استلام رسالتك وسيتم التواصل معك في أقرب وقت ممكن.',
                type: 'support',
                read: false,
                date: new Date().toISOString()
            };
            
            // Save notification to Firebase
            await database.ref(`${NOTIFICATIONS_PATH}/${supportNotification.id}`).set(supportNotification);
            
            // Show success
            document.getElementById('supportSuccess').textContent = 'تم إرسال طلبك بنجاح وسيتم التواصل معك قريبًا';
            document.getElementById('supportSuccess').style.display = 'block';
            
            // Clear form
            document.getElementById('supportForm').reset();
            
            // Close modal after delay
            setTimeout(() => {
                document.getElementById('supportSuccess').style.display = 'none';
                closeSupportModal();
            }, 3000);
        } catch (error) {
            console.error('Support request error:', error);
            document.getElementById('supportError').textContent = 'حدث خطأ في إرسال الطلب';
            document.getElementById('supportError').style.display = 'block';
        } finally {
            hideLoading();
        }
    }

    // تحديث دالة عرض تفاصيل الحساب
    function showDetails() {
        // Populate the details modal
        document.getElementById('detailsName').textContent = currentInvestor.name;
        document.getElementById('detailsCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
        document.getElementById('detailsExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
        document.getElementById('detailsTotalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
        document.getElementById('detailsTotalProfit').textContent = formatCurrency(currentCard.totalProfit || 0);
        document.getElementById('detailsDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
        document.getElementById('detailsPaidProfit').textContent = formatCurrency(currentCard.paidProfit || 0);
        
        // Set investment details
        document.getElementById('detailsInvestmentType').textContent = currentCard.investmentType || 'استثمار عام';
        
        // Set investment date (use 60 days ago if not available)
        const investmentDate = currentCard.investmentDate || 
            new Date(new Date().getTime() - 180 * 24 * 60 * 60 * 1000).toISOString();
        document.getElementById('detailsInvestmentDate').textContent = formatDate(investmentDate);
        
        // Set maturity date (use 300 days from investment date if not available)
        const maturityDate = currentCard.maturityDate || 
            new Date(new Date(investmentDate).getTime() + 300 * 24 * 60 * 60 * 1000).toISOString();
        document.getElementById('detailsMaturityDate').textContent = formatDate(maturityDate);
        
        // Show the modal
        document.getElementById('detailsModal').classList.add('active');
    }

    // Close details modal
    function closeDetailsModal() {
        document.getElementById('detailsModal').classList.remove('active');
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-IQ');
    }

    // Logout
    function logout() {
        // Clear localStorage
        localStorage.removeItem('investorCard');
        localStorage.removeItem('investorData');
        localStorage.removeItem('loginTime');
        
        currentInvestor = null;
        currentCard = null;
        
        // Reset forms
        document.getElementById('loginForm').reset();
        
        // Hide dashboard, show login
        document.getElementById('dashboardScreen').style.display = 'none';
        document.getElementById('bottomNav').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        
        // Clear any QR scanner
        if (qrScanner) {
            qrScanner.clear();
            qrScanner = null;
        }
        
        // Reset QR scanner UI
        document.getElementById('qr-scanner').style.display = 'none';
        document.getElementById('startScanBtn').style.display = 'block';
    }

    // Generate unique ID
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Show loading
    function showLoading() {
        document.getElementById('loadingScreen').style.display = 'flex';
    }

    // Hide loading
    function hideLoading() {
        document.getElementById('loadingScreen').style.display = 'none';
    }

    // Show error
    function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        setTimeout(() => errorElement.style.display = 'none', 5000);
    }

    // Clear errors
    function clearErrors() {
        document.getElementById('errorMessage').style.display = 'none';
    }
    
    // وظائف مساعدة إضافية
    
    // تقصير النص
    function shortenText(text, maxLength) {
        if (text.length <= maxLength) {
            return text;
        }
        
        return text.substr(0, maxLength) + '...';
    }
    
    // الحصول على أيقونة الإشعار
    function getNotificationIcon(type) {
        switch (type) {
            case 'investment':
            case 'deposit':
                return 'fas fa-chart-line';
            case 'withdrawal':
                return 'fas fa-money-bill-wave';
            case 'profit':
                return 'fas fa-coins';
            case 'welcome':
                return 'fas fa-handshake';
            case 'system':
                return 'fas fa-cogs';
            default:
                return 'fas fa-bell';
        }
    }

    // تعزيز الاتصال بين الإشعارات والعمليات
    function syncNotificationsWithOperations() {
        try {
            if (!currentCard || !currentCard.recentOperations) {
                return;
            }
            
            // تحويل جميع العمليات إلى إشعارات إذا لم يكن لديها إشعار بالفعل
            currentCard.recentOperations.forEach(operation => {
                // التحقق من عدم وجود إشعار بالفعل لهذه العملية
                const hasNotification = notifications.some(n => n.operation && n.operation.id === operation.id);
                
                if (!hasNotification) {
                    // إنشاء إشعار من العملية
                    const notification = createNotificationFromOperation(operation);
                    
                    if (notification) {
                        // إضافة الإشعار إلى مصفوفة الإشعارات
                        notifications.push(notification);
                        
                        // حفظ الإشعار في Firebase
                        database.ref(`${NOTIFICATIONS_PATH}/${notification.id}`).set(notification)
                            .catch(error => console.error('خطأ في حفظ الإشعار:', error));
                    }
                }
            });
            
            // إعادة عرض الإشعارات إذا كان قسم الإشعارات مفتوحًا
            if (document.getElementById('notificationsSection').style.display === 'block') {
                displayNotifications(notifications);
            }
            
            // تحديث عدد الإشعارات غير المقروءة
            updateUnreadCount();
        } catch (error) {
            console.error('خطأ في مزامنة الإشعارات مع العمليات:', error);
        }
    }

    // دالة لاستعادة البيانات المحذوفة أو لإصلاح مشاكل التخزين المحلي
    function repairLocalStorage() {
        try {
            // التحقق من وجود بيانات في التخزين المحلي
            const savedCard = localStorage.getItem('investorCard');
            const savedInvestor = localStorage.getItem('investorData');
            
            if (!savedCard || !savedInvestor) {
                console.warn('بيانات التخزين المحلي غير متوفرة');
                return false;
            }
            
            // محاولة تحليل البيانات
            try {
                const card = JSON.parse(savedCard);
                const investor = JSON.parse(savedInvestor);
                
                // التحقق من صحة البيانات
                if (!card.id || !card.cardNumber || !investor.id || !investor.name) {
                    console.warn('بيانات التخزين المحلي غير صالحة');
                    return false;
                }
                
                // تعيين البيانات الصالحة
                currentCard = card;
                currentInvestor = investor;
                
                return true;
            } catch (error) {
                console.error('خطأ في تحليل بيانات التخزين المحلي:', error);
                
                // مسح البيانات غير الصالحة
                localStorage.removeItem('investorCard');
                localStorage.removeItem('investorData');
                
                return false;
            }
        } catch (error) {
            console.error('خطأ في إصلاح التخزين المحلي:', error);
            return false;
        }
    }

    // تحسين الأمان بتشفير البيانات المحلية
    function secureLocalStorage() {
        // يمكن تنفيذ هذه الدالة لاحقًا عند الحاجة لتحسين الأمان
        // يمكن استخدام مكتبات مثل CryptoJS للتشفير
    }

    // الاستماع المستمر لتغييرات بيانات البطاقة
    function listenForCardChanges() {
        if (!currentCard || !currentCard.id) {
            return;
        }
        
        const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
        
        // إزالة المستمعين السابقين
        cardRef.off();
        
        // إضافة مستمع جديد
        cardRef.on('value', (snapshot) => {
            const updatedCard = snapshot.val();
            
            if (updatedCard) {
                // تحديث البيانات المحلية
                currentCard = updatedCard;
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                
                // تحديث واجهة المستخدم
                updateDashboard();
            }
        });
    }

    // التحقق من حالة الاتصال بالإنترنت
    function checkInternetConnection() {
        return navigator.onLine;
    }

    // معالجة حالة عدم الاتصال بالإنترنت
    function handleOfflineMode() {
        if (!checkInternetConnection()) {
            // إظهار رسالة للمستخدم
            createNotification(
                'انقطاع الاتصال',
                'أنت حاليًا غير متصل بالإنترنت. سيتم استخدام البيانات المخزنة محليًا.',
                'warning'
            );
            
            // تعطيل الوظائف التي تتطلب اتصالًا بالإنترنت
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
        } else {
            // إعادة تفعيل الوظائف
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        }
    }

    // إضافة مستمع لحالة الاتصال
    window.addEventListener('online', () => {
        // إعادة تفعيل الوظائف وتحديث البيانات
        createNotification('تم استعادة الاتصال', 'تم استعادة الاتصال بالإنترنت', 'success');
        refreshDashboard();
        handleOfflineMode();
    });

    window.addEventListener('offline', () => {
        // تفعيل وضع عدم الاتصال
        handleOfflineMode();
    });

    // التحقق من الجلسة منتهية الصلاحية
    function checkSessionExpiry() {
        const loginTime = localStorage.getItem('loginTime');
        
        if (loginTime) {
            const now = new Date().getTime();
            const lastLogin = parseInt(loginTime);
            
            // تحقق مما إذا كانت قد مرت أكثر من 24 ساعة (مثال)
            if (now - lastLogin > 24 * 60 * 60 * 1000) {
                // تسجيل خروج تلقائي
                createNotification('انتهت الجلسة', 'انتهت صلاحية الجلسة. يرجى تسجيل الدخول مرة أخرى.', 'warning');
                logout();
                return true;
            }
        }
        
        return false;
    }

    // تحديث وقت تسجيل الدخول
    function updateLoginTime() {
        localStorage.setItem('loginTime', new Date().getTime().toString());
    }

    // إضافة تحديث وقت تسجيل الدخول إلى دالة showDashboard
    const originalShowDashboard = showDashboard;
    window.showDashboard = function() {
        originalShowDashboard();
        updateLoginTime(); // تحديث وقت تسجيل الدخول
        
        // استماع لتغييرات البطاقة
        listenForCardChanges();
        
        // التحقق من حالة الاتصال
        handleOfflineMode();
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
        
        // مزامنة الإشعارات والعمليات
        syncNotificationsWithOperations();
    };

    // تعريف السلوك العام للإغلاق عند النقر خارج النوافذ المنبثقة
    document.addEventListener('click', function(event) {
        // إغلاق النوافذ المنبثقة عندما يتم النقر خارجها
        const modals = document.querySelectorAll('.modal.active');
        
        modals.forEach(modal => {
            // التحقق من أن النقرة كانت خارج مربع الحوار وعلى الطبقة الخلفية
            if (event.target === modal && !modal.id.includes('loadingScreen')) {
                // الحصول على دالة الإغلاق المناسبة للنافذة المنبثقة
                if (modal.id === 'withdrawModal') {
                    closeWithdrawModal();
                } else if (modal.id === 'supportModal') {
                    closeSupportModal();
                } else if (modal.id === 'detailsModal') {
                    closeDetailsModal();
                } else if (modal.id === 'notificationDetailsModal') {
                    closeNotificationDetailsModal();
                } else if (modal.id === 'projectDetailsModal') {
                    closeProjectDetailsModal();
                } else if (modal.id === 'addProjectModal') {
                    closeAddProjectModal();
                } else if (modal.id === 'addCategoryModal') {
                    closeAddCategoryModal();
                } else if (modal.id === 'manageCategoriesModal') {
                    closeManageCategoriesModal();
                } else if (modal.id === 'editProjectModal') {
                    closeEditProjectModal();
                } else if (modal.id === 'investmentLocationsModal') {
                    closeInvestmentLocationsModal();
                }
            }
        });
        
        // إغلاق القائمة المنسدلة للمشرف عند النقر خارجها
        const adminDropdown = document.getElementById('adminDropdown');
        if (adminDropdown && adminDropdown.classList.contains('active') && 
            !event.target.closest('#adminDropdown') && 
            !event.target.closest('#adminModeSwitch')) {
            adminDropdown.classList.remove('active');
        }
        
        // إغلاق خانة البحث عند النقر خارجها
        const searchContainer = document.getElementById('searchContainer');
        if (searchContainer && searchContainer.classList.contains('active') && 
            !event.target.closest('#searchContainer') && 
            !event.target.closest('#searchIcon')) {
            searchContainer.classList.remove('active');
            // إعادة عرض جميع المشاريع
            document.getElementById('searchInput').value = '';
            displayProjects();
        }
    });

    // استدعاء وظائف البدء النهائية
    (function initialize() {
        // تعيين الوظائف في النافذة العالمية للاستخدام من HTML
        window.switchTab = switchTab;
        window.loginWithCard = loginWithCard;
        window.startQRScan = startQRScan;
        window.decodeQRFromImage = decodeQRFromImage;
        window.refreshDashboard = refreshDashboard;
        window.switchSection = switchSection;
        window.openWithdrawModal = openWithdrawModal;
        window.closeWithdrawModal = closeWithdrawModal;
        window.submitWithdrawRequest = submitWithdrawRequest;
        window.showDetails = showDetails;
        window.closeDetailsModal = closeDetailsModal;
        window.showContactSupport = showContactSupport;
        window.closeSupportModal = closeSupportModal;
        window.submitSupportRequest = submitSupportRequest;
        window.filterTransactions = filterTransactions;
        window.logout = logout;
        window.closeNotificationDetailsModal = closeNotificationDetailsModal;
        
        // وظائف الصفحة الرئيسية الجديدة (صفحة المشاريع)
        window.filterProjects = filterProjects;
        window.showProjectDetails = showProjectDetails;
        window.closeProjectDetailsModal = closeProjectDetailsModal;
        window.applyForProject = applyForProject;
        window.toggleSearch = toggleSearch;
        window.searchProjects = searchProjects;
        
        // وظائف المشرف
        window.toggleAdminMode = toggleAdminMode;
        window.openAddProjectModal = openAddProjectModal;
        window.closeAddProjectModal = closeAddProjectModal;
        window.triggerImageUpload = triggerImageUpload;
        window.previewProjectImage = previewProjectImage;
        window.submitNewProject = submitNewProject;
        window.openAddCategoryModal = openAddCategoryModal;
        window.closeAddCategoryModal = closeAddCategoryModal;
        window.submitNewCategory = submitNewCategory;
        window.openManageCategoriesModal = openManageCategoriesModal;
        window.closeManageCategoriesModal = closeManageCategoriesModal;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.toggleProjectEditMode = toggleProjectEditMode;
        window.editProject = editProject;
        window.confirmDeleteProject = confirmDeleteProject;
        window.deleteProject = deleteProject;
        window.triggerEditImageUpload = triggerEditImageUpload;
        window.previewEditProjectImage = previewEditProjectImage;
        window.submitEditProject = submitEditProject;
        
        // وظائف خريطة مواقع الاستثمار
        window.closeInvestmentLocationsModal = closeInvestmentLocationsModal;
        window.toggleAddLocationMode = toggleAddLocationMode;
        window.updateMarkerInfo = updateMarkerInfo;
        window.removeMarker = removeMarker;
        window.saveLocations = saveLocations;
        window.confirmInvestment = confirmInvestment;
    })();
    </script>
</body>
</html>

                        
