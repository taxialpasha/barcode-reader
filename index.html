<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محفظة المستثمر | سما بابل للاستثمار</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Tajawal for Arabic UI -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        /* ===== COLORS & THEME ===== */
        :root {
            --bg-dark: #0d1117;
            --bg-card: #111827;
            --gold: #FFC436;
            --gold-light: rgba(255, 196, 54, 0.1);
            --gold-medium: rgba(255, 196, 54, 0.3);
            --gold-bright: rgba(255, 196, 54, 0.8);
            --text-white: #ffffff;
            --text-light: rgba(255, 255, 255, 0.7);
            --text-dark: #000000;
            --red: #ff5252;
            --green: #4CAF50;
            --blue: #2196F3;
            --border-radius-sm: 10px;
            --border-radius-md: 16px;
            --border-radius-lg: 20px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

     /* تعديل خلفية الجسم بالكامل */
body {
    background-color: var(--bg-dark); /* لون احتياطي في حال لم تظهر الصورة */
    background-image: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445');
    background-size: cover;
    background-position: center center;
    background-attachment: fixed; /* جعل الخلفية ثابتة عند التمرير */
    background-repeat: no-repeat;
    color: var(--gold);
    line-height: 1.5;
}
      /* إضافة طبقة شفافة فوق الخلفية للتباين وتحسين مقروئية العناصر */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
    background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
    backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
    height: 100vh; /* Full screen height */
    display: flex;
    flex-direction: column; /* Stack elements vertically */
}

/* تحديث شامل لتثبيت شريط الأدوات والعناوين */

/* إعادة ضبط حاوية التطبيق للتعامل مع التمرير بشكل أفضل */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: fixed; /* تثبيت الحاوية الرئيسية */
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    overflow: hidden; /* منع التمرير على مستوى الحاوية */
    background-color: rgba(13, 17, 23, 0.85);
    backdrop-filter: blur(5px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
}

/* إعادة تصميم الشريط العلوي للتثبيت الكامل */
.header {
    position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    height: 60px; /* تحديد ارتفاع ثابت */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* إعادة تصميم شريط الأدوات السفلي للتثبيت الكامل */
.bottom-nav {
    position: absolute; /* تغيير من fixed إلى absolute لمنع مشاكل التموضع */
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    height: 60px; /* تحديد ارتفاع ثابت */
}

/* إعادة تصميم منطقة المحتوى الرئيسية للتمرير بشكل صحيح */
.dashboard {
    flex: 1; /* يأخذ المساحة المتبقية */
    position: relative;
    overflow: hidden;
    margin-top: 60px; /* مساحة للشريط العلوي */
    margin-bottom: 60px; /* مساحة للشريط السفلي */
    height: calc(100% - 120px); /* الارتفاع الكلي ناقص ارتفاع الشريطين */
}

/* تعديل هيكل الأقسام المختلفة للتمرير المناسب */
#homeSection, 
#profileSection, 
#transactionsSection, 
#notificationsSection {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto; /* تفعيل التمرير العمودي */
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* تمرير سلس على الأجهزة التي تعمل باللمس */
    padding: 15px 0 30px; /* تباعد أعلى وأسفل المحتوى */
    display: none; /* سيتم تفعيله عبر JavaScript */
    height: 100%; /* ارتفاع كامل */
}

/* إظهار القسم النشط */
#homeSection.active, 
#profileSection.active, 
#transactionsSection.active, 
#notificationsSection.active {
    display: block;
}

/* معالجة المودالات لضمان تموضعها بشكل صحيح */
.modal {
    z-index: 2000;
}

/* معالجة شاشة التحميل */
.loading {
    z-index: 3000;
}

/* معالجة تمرير جسم الصفحة */
body {
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    margin: 0;
    padding: 0;
}

/* تأكيد تموضع زر التحديث بشكل صحيح */
.refresh-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1001;
}

/* تعديلات للشاشات الصغيرة */
@media (max-height: 600px) {
    .header {
        padding: 10px 0;
        height: 50px;
    }
    
    .bottom-nav {
        padding: 8px 0 5px;
        height: 50px;
    }
    
    .dashboard {
        margin-top: 50px;
        margin-bottom: 50px;
        height: calc(100% - 100px);
    }
}

/* تعديل أنماط العناصر المتنقلة في الشريط السفلي */
.nav-item {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* إصلاح مشكلة شاشة تسجيل الدخول */
.login-screen {
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1500;
}

/* تعديلات خاصة بمنطقة البطاقة والمعلومات */
.credit-card, .info-cards, .actions, .transactions {
    padding-left: 15px;
    padding-right: 15px;
}

/* منع وجود فراغات زائدة في أسفل المحتوى */
.transactions {
    margin-bottom: 0;
    padding-bottom: 20px;
}

/* تبسيط تباعد العناصر */
.section-title {
    margin-top: 15px;
}

/* تعديل لحل مشكلة التمرير في نهاية الصفحة */
#transactionsList, #filteredTransactionsList, #notificationsList {
    padding-bottom: 30px; /* ضمان وجود مساحة كافية في نهاية القوائم */
}

/* تعديل خلفيات العناصر الفرعية لتكون شبه شفافة */
.header, 
.bottom-nav, 
.login-screen,
.dashboard,
.profile-section,
.transactions-section,
.notifications-section {
    background-color: transparent; /* إزالة الخلفية ليظهر التأثير */
}




/* جعل بعض العناصر مثل البطاقات والنوافذ المنبثقة أكثر وضوحًا */
.credit-card,
.info-card,
.transaction-item,
.notification-item,
.modal-content,
.account-details,
.form-control {
    background-color: rgba(17, 24, 39, 0.8); /* خلفية داكنة شبه شفافة */
    backdrop-filter: blur(8px); /* تأثير ضبابي أقوى */
    border: 1px solid rgba(255, 196, 54, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}


/* تعديل زر التحديث والأزرار الإضافية لتكون أكثر وضوحًا */
.refresh-btn,
.nav-item {
    background-color: rgba(17, 24, 39, 0.7);
    backdrop-filter: blur(5px);
}



    /* تحديث نمط البطاقة لإضافة صورة الخلفية */
.credit-card {
    width: 100%;
    aspect-ratio: 1.6/1;
    background: url('https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2F17e54e3c-0100-43ce-af71-45bfd80202fe.png?alt=media&token=8040b8c4-7847-43c6-987f-c05e9e32b445') no-repeat center center;
    background-size: cover;
    border-radius: var(--border-radius-lg);
    padding: 24px;
    position: relative;
    overflow: hidden;
    margin: 0 auto 25px;
    border: 1px solid rgba(255, 196, 54, 0.3);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* تعديل طبقة التراكب لتناسب لون الخلفية الجديدة */
.credit-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%);
    z-index: 1;
    pointer-events: none;
}

/* تحسين لون النصوص لتكون مقروءة على الخلفية الجديدة */
.card-number,
.card-company,
.card-info-label,
.card-info-value,
.card-logo,
.card-provider {
    color: var(--gold);
    text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.7);
    position: relative;
    z-index: 2;
}

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .card-chip {
            width: 45px;
            height: 35px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 8px;
            margin-right: auto;
        }

        .card-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-provider {
            width: 60px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--gold);
            font-size: 0.9rem;
        }

        .card-number {
            font-size: 1.8rem;
            color: var(--gold);
            letter-spacing: 2px;
            text-align: center;
            margin: 10px 0 20px;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }

        .card-holder-name {
            font-size: 1.1rem;
            color: var(--gold);
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }

        .card-company {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 2;
        }

        .card-info-item {
            position: relative;
            z-index: 2;
        }

        .card-info-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .card-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
        }

        /* ===== INFO CARDS ===== */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .info-card h3 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .info-card p {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: var(--gold);
        }

        /* ===== ACTION BUTTONS ===== */
        .actions {
            padding: 0 15px;
            margin-bottom: 25px;
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--gold-medium);
            border-radius: var(--border-radius-md);
            color: var(--gold);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .action-btn:hover {
            background: var(--gold-light);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.15);
        }

        .action-btn i {
            font-size: 1.3rem;
        }

        /* ===== TRANSACTIONS ===== */
        .transactions {
            padding: 5px 15px 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-white);
            font-size: 0.95rem;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .transaction-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-right: 5px;
        }

        .transaction-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-white);
            text-align: left;
            direction: ltr;
        }

        .transaction-amount.positive {
            color: var(--gold);
        }

        .transaction-amount.negative {
            color: var(--red);
        }

       /* تعديل رأس التطبيق */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    max-width: 430px;
    margin: 0 auto;
}



/* تعديل قائمة التنقل السفلية */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    max-width: 430px;
    margin: 0 auto;
}

/* تحسين التباين لتحسين مقروئية النصوص */
h1, h2, h3, .section-title, .profile-name, .card-number, .card-company {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

/* تعديل شاشة تسجيل الدخول لتكون متوافقة مع الخلفية الجديدة */
.login-screen {
    background-color: rgba(13, 17, 23, 0.85);
    backdrop-filter: blur(5px);
}

/* تعديل طبقة التحميل */
.loading {
    background-color: rgba(13, 17, 23, 0.9);
    backdrop-filter: blur(10px);
}

        .header h1 {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            color: var(--gold);
        }

        .header-user {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 3px;
        }

        .refresh-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--gold-light);
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 196, 54, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 8px;
            max-width: 430px;
            margin: 0 auto;
        }

        .nav-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-light);
            width: 70px;
        }

        .nav-item.active {
            color: var(--gold);
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            padding: 40px 20px;
            text-align: center;
            background-color: var(--bg-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gold) 0%, #FFA500 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(255, 196, 54, 0.3);
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--bg-dark);
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 196, 54, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            color: var(--gold);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--text-white);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 196, 54, 0.3);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--gold);
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--bg-dark);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold);
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(255, 196, 54, 0.2);
        }

        /* ===== QR Scanner ===== */
        #qr-scanner {
            width: 100%;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            display: none;
        }

        .img-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #qr-file-selector {
            display: none;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            display: none;
            padding-bottom: 80px;
            background-color: var(--bg-dark);
        }

        /* ===== PROFILE SECTION ===== */
        .profile-section {
            padding: 20px 15px;
            display: none;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            background: var(--gold);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--bg-dark);
            box-shadow: 0 5px 15px rgba(255, 196, 54, 0.2);
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .profile-card {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .account-details {
            background: var(--bg-card);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-top: 10px;
            border: 1px solid rgba(255, 196, 54, 0.2);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-white);
        }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: var(--border-radius-sm);
            color: var(--red);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: rgba(255, 82, 82, 0.2);
            border-color: var(--red);
        }

        /* ===== TRANSACTIONS SECTION ===== */
        .transactions-section {
            padding: 20px 15px;
            display: none;
        }

        .transaction-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none; /* Firefox */
        }

        .transaction-filter::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 196, 54, 0.2);
            border-radius: 30px;
            color: var(--text-light);
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: transparent;
            font-weight: 600;
        }

        .transaction-date-header {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 196, 54, 0.1);
        }

        /* ===== NOTIFICATIONS SECTION ===== */
        .notifications-section {
            padding: 20px 15px;
            display: none;
        }

        .notification-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 196, 54, 0.1);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 196, 54, 0.05);
            border-color: rgba(255, 196, 54, 0.3);
        }

        .notification-item.unread {
            border-right: 3px solid var(--gold);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 196, 54, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: var(--gold);
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--gold);
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-white);
            margin-bottom: 5px;
        }

        .notification-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            position: relative;
            border: 1px solid rgba(255, 196, 54, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 196, 54, 0.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--gold);
            font-size: 1rem;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MESSAGES ===== */
        .error-message {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            color: var(--red);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--green);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            text-align: center;
            display: none;
            font-size: 0.9rem;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 360px) {
            .card-number {
                font-size: 1.5rem;
            }
            
            .info-card {
                padding: 12px 10px;
            }
            
            .info-card h3 {
                font-size: 0.8rem;
            }
            
            .info-card p {
                font-size: 1.1rem;
            }
            
            .transaction-item {
                padding: 10px 12px;
            }
            
            .transaction-icon {
                width: 36px;
                height: 36px;
                margin-left: 10px;
            }
            
            .transaction-type {
                font-size: 0.85rem;
            }
            
            .transaction-amount {
                font-size: 0.95rem;
            }
        }

        /* Adjust app container for fixed header and footer */
.app-container {
    width: 100%;
    max-width: 430px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
    background-color: rgba(13, 17, 23, 0.85); /* خلفية شبه شفافة */
    backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ظل للحاوية */
    height: 100vh; /* Full screen height */
    display: flex;
    flex-direction: column; /* Stack elements vertically */
}

/* Fix the header at the top */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: rgba(13, 17, 23, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 196, 54, 0.2);
    padding: 15px 0;
    max-width: 430px;
    margin: 0 auto;
}

/* Fix the bottom navigation at the bottom */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 196, 54, 0.2);
    padding: 12px 0 8px;
    max-width: 430px;
    margin: 0 auto;
}

/* Allow scrolling for the main content */
#homeSection,
#profileSection,
#transactionsSection,
#notificationsSection {
    padding-top: 65px; /* Space for the fixed header */
    padding-bottom: 70px; /* Space for the fixed footer */
    overflow-y: auto; /* Enable vertical scrolling */
    height: 100vh; /* Full screen height */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling for touch devices */
}

/* Prevent body scrolling */
body {
    overflow: hidden;
    height: 100vh;
    margin: 0;
    padding: 0;
}

/* Smooth transitions for header and footer */
.header, .bottom-nav {
    transition: transform 0.3s ease;
}

/* Optional: Hide header when scrolling down */
.header.hidden {
    transform: translateY(-100%);
}

/* Optional: Hide footer when scrolling up */
.bottom-nav.hidden {
    transform: translateY(100%);
}

/* Adjust refresh button position */
.refresh-btn {
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 101;
}

/* Adjust modal z-index */
.modal {
    z-index: 2000;
}

/* Adjust loading screen z-index */
.loading {
    z-index: 3000;
}

/* Responsive adjustments for smaller screens */
@media (max-height: 600px) {
    .header {
        padding: 10px 0;
    }
    .bottom-nav {
        padding: 8px 0 5px;
    }
    #homeSection,
    #profileSection,
    #transactionsSection,
    #notificationsSection {
        padding-top: 55px;
        padding-bottom: 60px;
    }
}

/* ...existing code... */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div class="loading" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">جاري التحميل...</div>
        </div>

        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="logo">
                <i class="fas fa-gem"></i>
            </div>
            
            <h2 style="margin-bottom: 30px; color: var(--gold); font-weight: 800;">سما بابل للاستثمار</h2>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('cardTab')">
                    <i class="fas fa-credit-card"></i> البطاقة
                </button>
                <button class="tab-btn" onclick="switchTab('qrTab')">
                    <i class="fas fa-qrcode"></i> QR Code
                </button>
            </div>

            <div id="errorMessage" class="error-message"></div>
            
            <div id="cardTab" class="tab-content active">
                <form id="loginForm" onsubmit="loginWithCard(event)">
                    <div class="form-group">
                        <label class="form-label">رقم البطاقة</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ الانتهاء</label>
                        <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رمز الأمان (CVV)</label>
                        <input type="password" class="form-control" id="cvv" placeholder="XXX" maxlength="3" required>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-sign-in-alt"></i> دخول
                    </button>
                </form>
            </div>
            
            <div id="qrTab" class="tab-content">
                <div id="qr-scanner"></div>
                <button id="startScanBtn" class="btn" onclick="startQRScan()">
                    <i class="fas fa-camera"></i> مسح رمز QR
                </button>
                
                <label for="qr-file-selector" class="btn btn-secondary img-upload-btn" style="margin-top: 15px;">
                    <i class="fas fa-upload"></i> تحميل صورة الباركود
                </label>
                <input type="file" id="qr-file-selector" accept="image/*" onchange="decodeQRFromImage(this.files[0])">
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="dashboard" id="dashboardScreen">
            <!-- Header -->
            <div class="header">
                <div>
                    <div class="header-user" id="headerUsername">مرحباً، المستثمر</div>
                </div>
                <button class="refresh-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <!-- Home Section (Dashboard) -->
            <div id="homeSection">
                <!-- Card Display -->
                <div style="padding: 20px;">
                    <div class="credit-card">
                        <div class="card-header">
                            <div class="card-chip"></div>
                            <div class="card-provider">INVESTOR</div>
                        </div>
                        <div class="card-number" id="displayCardNumber" style="font-size: 1.5rem;">2750 2380 1584 5063</div>
                        <div class="card-company" id="cardCompanyName" style="font-size: 1rem;">سما بابل للاستثمار</div>
                        <div class="card-info">
                            <div class="card-info-item">
                                <div class="card-info-label" style="font-size: 0.8rem;">الأرباح المستحقة</div>
                                <div class="card-info-value" id="cardDueProfit" style="font-size: 1rem;">1,458.333 د.ع</div>
                            </div>
                            <div class="card-info-item">
                                <div class="card-info-label" style="font-size: 0.8rem;">تاريخ الاستحقاق</div>
                                <div class="card-info-value" id="displayExpiryDate" style="font-size: 1rem;">05/27</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Cards -->
                <div class="info-cards">
                    <div class="info-card">
                        <h3>إجمالي المدفوع</h3>
                        <p id="totalInvestment">4,000.00 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>الأرباح المستحقة</h3>
                        <p id="dueProfit">51,036.03 د.ع</p>
                    </div>
                    <div class="info-card">
                        <h3>تاريخ الاستحقاق</h3>
                        <p id="maturityDate">05/27</p>
                    </div>
                    <div class="info-card">
                        <h3>حالة الاستثمار</h3>
                        <p id="investmentStatus">نشط</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button class="action-btn" onclick="openWithdrawModal()">
                        <i class="fas fa-money-check-alt"></i> طلب سحب
                    </button>
                    <button class="action-btn" onclick="showDetails()">
                        <i class="fas fa-file-alt"></i> تفاصيل الحساب
                    </button>
                </div>

                <!-- Recent Transactions -->
                <div class="transactions">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i> آخر المعاملات
                    </h2>
                    <div id="transactionsList">
                        <!-- Transactions will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div class="profile-section" id="profileSection">
                <h2 class="section-title">
                    <i class="fas fa-user"></i> الملف الشخصي
                </h2>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name" id="profileName">خالد السعدي</div>
                    <div class="profile-card" id="profileCardNumber">2750 2380 1584 5063</div>
                </div>
                
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">الاسم الكامل</div>
                        <div class="detail-value" id="profileFullName">خالد السعدي</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف</div>
                        <div class="detail-value" id="profilePhone">07701234567</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">البريد الإلكتروني</div>
                        <div class="detail-value" id="profileEmail">khalid@example.com</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانضمام</div>
                        <div class="detail-value" id="profileJoinDate">10/01/2024</div>
                    </div>
                </div>
                
                <button class="btn" style="margin-top: 20px;" onclick="showContactSupport()">
                    <i class="fas fa-headset"></i> اتصل بالدعم
                </button>
                
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
            
            <!-- Transactions Section -->
            <div class="transactions-section" id="transactionsSection">
                <h2 class="section-title">
                    <i class="fas fa-exchange-alt"></i> سجل المعاملات
                </h2>
                
                <div class="transaction-filter">
                    <div class="filter-btn active" onclick="filterTransactions('all')">الكل</div>
                    <div class="filter-btn" onclick="filterTransactions('investment')">الاستثمارات</div>
                    <div class="filter-btn" onclick="filterTransactions('profit')">الأرباح</div>
                    <div class="filter-btn" onclick="filterTransactions('withdrawal')">السحوبات</div>
                </div>
                
                <div id="filteredTransactionsList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div class="notifications-section" id="notificationsSection">
                <h2 class="section-title">
                    <i class="fas fa-bell"></i> التنبيهات والإشعارات
                </h2>
                
                <div id="notificationsList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="switchSection('home')">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </div>
            <div class="nav-item" onclick="switchSection('transactions')">
                <i class="fas fa-exchange-alt"></i>
                <span>المعاملات</span>
            </div>
            <div class="nav-item" onclick="switchSection('notifications')">
                <i class="fas fa-bell"></i>
                <span>التنبيهات</span>
            </div>
            <div class="nav-item" onclick="switchSection('profile')">
                <i class="fas fa-user"></i>
                <span>الشخصي</span>
            </div>
        </div>

        <!-- Withdraw Modal -->
        <div class="modal" id="withdrawModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">طلب سحب</h2>
                    <button class="modal-close" onclick="closeWithdrawModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="withdrawForm" onsubmit="submitWithdrawRequest(event)">
                    <div class="form-group">
                        <label class="form-label">المبلغ المتاح للسحب</label>
                        <input type="text" class="form-control" id="availableBalance" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">المبلغ المطلوب سحبه</label>
                        <input type="number" class="form-control" id="withdrawAmount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">طريقة الاستلام</label>
                        <select class="form-control" id="withdrawMethod" required>
                            <option value="cash">نقداً</option>
                            <option value="bank_transfer">حوالة بنكية</option>
                            <option value="e_wallet">محفظة إلكترونية</option>
                        </select>
                    </div>
                    <div class="form-group" id="bankDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل الحساب البنكي</label>
                        <input type="text" class="form-control" id="bankDetails" placeholder="اسم البنك ورقم الحساب">
                    </div>
                    <div class="form-group" id="walletDetailsGroup" style="display: none;">
                        <label class="form-label">تفاصيل المحفظة الإلكترونية</label>
                        <input type="text" class="form-control" id="walletDetails" placeholder="نوع المحفظة ورقم الهاتف">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="withdrawNotes" rows="3"></textarea>
                    </div>
                    <div id="withdrawError" class="error-message"></div>
                    <div id="withdrawSuccess" class="success-message"></div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال الطلب
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Contact Support Modal -->
        <div class="modal" id="supportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">اتصل بالدعم</h2>
                    <button class="modal-close" onclick="closeSupportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="supportForm" onsubmit="submitSupportRequest(event)">
                    <div class="form-group">
                        <label class="form-label">موضوع المراسلة</label>
                        <select class="form-control" id="supportTopic" required>
                            <option value="">اختر الموضوع</option>
                            <option value="technical">مشكلة تقنية</option>
                            <option value="account">استفسار عن الحساب</option>
                            <option value="investment">استفسار عن الاستثمار</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الرسالة</label>
                        <textarea class="form-control" id="supportMessage" rows="5" required></textarea>
                    </div>
                    <div id="supportError" class="error-message"></div>
                    <div id="supportSuccess" class="success-message"></div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> إرسال
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Account Details Modal -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--gold);">تفاصيل الحساب</h2>
                    <button class="modal-close" onclick="closeDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="account-details">
                    <div class="detail-item">
                        <div class="detail-label">اسم المستثمر</div>
                        <div class="detail-value" id="detailsName">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم البطاقة</div>
                        <div class="detail-value" id="detailsCardNumber">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الانتهاء</div>
                        <div class="detail-value" id="detailsExpiryDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الاستثمار</div>
                        <div class="detail-value" id="detailsTotalInvestment">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">إجمالي الأرباح</div>
                        <div class="detail-value" id="detailsTotalProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المستحقة</div>
                        <div class="detail-value" id="detailsDueProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الأرباح المدفوعة</div>
                        <div class="detail-value" id="detailsPaidProfit">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">نوع الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentType">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستثمار</div>
                        <div class="detail-value" id="detailsInvestmentDate">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الاستحقاق</div>
                        <div class="detail-value" id="detailsMaturityDate">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentInvestor = null;
        let currentCard = null;
        let qrScanner = null;
        let currentFilter = 'all';
        let notifications = [];
        // المسار الصحيح في Firebase
        const FIREBASE_USER_ID = '6wS4ga5v6MXUMC0yzyDnxuI2dh03';
        const INVESTOR_CARD_ID = 'mai4v8cousf7soxqvt'; // معرف البطاقة المحدد
        const CARDS_PATH = `users/${FIREBASE_USER_ID}/investorCards`;
        const TRANSACTIONS_PATH = `users/${FIREBASE_USER_ID}/transactions`;
        const WITHDRAWAL_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/withdrawRequests`;
        const SUPPORT_REQUESTS_PATH = `users/${FIREBASE_USER_ID}/supportRequests`;
        const NOTIFICATIONS_PATH = `users/${FIREBASE_USER_ID}/notifications`;
        const OPERATIONS_PATH = `users/${FIREBASE_USER_ID}/investorCards/${INVESTOR_CARD_ID}/recentOperations`;

        // Initialize app
        window.onload = function() {
            setupEventListeners();
            checkLocalStorage();
            hideLoading();
        };
        
        // Check for saved login info in localStorage
        function checkLocalStorage() {
            const savedCard = localStorage.getItem('investorCard');
            const savedInvestor = localStorage.getItem('investorData');
            
            if (savedCard && savedInvestor) {
                try {
                    currentCard = JSON.parse(savedCard);
                    currentInvestor = JSON.parse(savedInvestor);
                    showDashboard();
                } catch (error) {
                    console.error('Error parsing saved data:', error);
                    localStorage.removeItem('investorCard');
                    localStorage.removeItem('investorData');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Card number formatting
            document.getElementById('cardNumber').addEventListener('input', formatCardNumber);
            
            // Expiry date formatting
            document.getElementById('expiryDate').addEventListener('input', formatExpiryDate);
            
            // CVV formatting
            document.getElementById('cvv').addEventListener('input', formatCVV);
            
            // Withdraw method change
            document.getElementById('withdrawMethod').addEventListener('change', function() {
                const method = this.value;
                document.getElementById('bankDetailsGroup').style.display = method === 'bank_transfer' ? 'block' : 'none';
                document.getElementById('walletDetailsGroup').style.display = method === 'e_wallet' ? 'block' : 'none';
            });
        }

        // Format card number input
        function formatCardNumber(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        }

        // Format expiry date input
        function formatExpiryDate(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        }

        // Format CVV input
        function formatCVV(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
        }

        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Login with card
        async function loginWithCard(event) {
            event.preventDefault();
            showLoading();
            clearErrors();

            const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;

            console.log("Attempting login with:", { cardNumber, expiryDate, cvv });

            try {
                // Search for card in Firebase with correct path
                const cardData = await findCardInDatabase(cardNumber, expiryDate, cvv);
                
                if (cardData) {
                    currentCard = cardData;
                    console.log("Card found:", cardData);
                    
                    // Load investor data from the card
                    currentInvestor = {
                        id: cardData.investorId,
                        name: cardData.investorName,
                        phone: cardData.investorPhone,
                        email: cardData.investorEmail || '',
                        joinDate: cardData.joinDate || new Date().toISOString()
                    };
                    
                    // Save to localStorage for persistent login
                    localStorage.setItem('investorCard', JSON.stringify(currentCard));
                    localStorage.setItem('investorData', JSON.stringify(currentInvestor));
                    
                    showDashboard();
                } else {
                    showError('بيانات البطاقة غير صحيحة');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('حدث خطأ في النظام');
            } finally {
                hideLoading();
            }
        }

        // Find card in database with correct path
        async function findCardInDatabase(cardNumber, expiryDate, cvv) {
            console.log("Searching in path:", CARDS_PATH);
            
            const cardsRef = database.ref(CARDS_PATH);
            const snapshot = await cardsRef.once('value');
            const cards = snapshot.val() || {};
            
            console.log("Cards found:", cards);

            // Search through all cards
            for (const cardId in cards) {
                const card = cards[cardId];
                console.log("Checking card:", card);
                
                if (card.cardNumber === cardNumber && 
                    formatCardExpiryDateFromDB(card.expiryDate) === expiryDate && 
                    card.cvv === cvv) {
                    console.log("Card match found!");
                    return card;
                }
            }

            return null;
        }

        // Format expiry date from database format
        function formatCardExpiryDateFromDB(dateString) {
            const date = new Date(dateString);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().substr(-2);
            return `${month}/${year}`;
        }

        // Start QR scan
        async function startQRScan() {
            try {
                const qrScannerElement = document.getElementById('qr-scanner');
                qrScannerElement.style.display = 'block';
                
                qrScanner = new Html5QrcodeScanner(
                    "qr-scanner", 
                    { fps: 10, qrbox: 250 }
                );

                qrScanner.render(onQRSuccess, onQRError);
                document.getElementById('startScanBtn').style.display = 'none';
            } catch (error) {
                console.error('QR scanner error:', error);
                showError('خطأ في تشغيل الكاميرا');
            }
        }

        // Decode QR code from uploaded image
        function decodeQRFromImage(file) {
            if (!file) {
                return;
            }
            
            showLoading();
            
            const html5QrCode = new Html5Qrcode("qr-scanner");
            
            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    console.log(`QR Code from image: ${decodedText}`);
                    processQRData(decodedText);
                })
                .catch(err => {
                    console.error(`Error scanning uploaded QR code: ${err}`);
                    showError('فشل في قراءة رمز QR من الصورة');
                    hideLoading();
                });
        }

        // Process QR data (used by both camera and uploaded image)
        async function processQRData(decodedText) {
            try {
                console.log("QR Code scanned:", decodedText);

                // Parse QR data
                const qrData = JSON.parse(decodedText);
                
                if (qrData.type === 'investor-card' && qrData.cardNumber) {
                    // Auto-fill card data
                    document.getElementById('cardNumber').value = formatCardNumberDisplay(qrData.cardNumber);
                    document.getElementById('expiryDate').value = qrData.expiryDate;
                    
                    // Find card in database
                    const cardData = await findCardByQR(qrData);
                    
                    if (cardData) {
                        currentCard = cardData;
                        
                        // Load investor data from the card
                        currentInvestor = {
                            id: cardData.investorId,
                            name: cardData.investorName,
                            phone: cardData.investorPhone,
                            email: cardData.investorEmail || '',
                            joinDate: cardData.joinDate || new Date().toISOString()
                        };
                        
                        // Save to localStorage for persistent login
                        localStorage.setItem('investorCard', JSON.stringify(currentCard));
                        localStorage.setItem('investorData', JSON.stringify(currentInvestor));
                        
                        showDashboard();
                    } else {
                        showError('البطاقة غير موجودة في النظام');
                    }
                } else {
                    showError('رمز QR غير صالح');
                }
            } catch (error) {
                console.error('QR processing error:', error);
                showError('خطأ في معالجة رمز QR');
            } finally {
                hideLoading();
            }
        }

        // QR scan success
        function onQRSuccess(decodedText) {
            if (qrScanner) {
                qrScanner.clear();
                qrScanner = null;
            }
            
            processQRData(decodedText);
        }

        // QR scan error
        function onQRError(error) {
            console.warn('QR scan error:', error);
        }

        // Find card by QR data
        async function findCardByQR(qrData) {
            const cardsRef = database.ref(CARDS_PATH);
            const snapshot = await cardsRef.once('value');
            const cards = snapshot.val() || {};

            // Search by card ID or investor ID
            for (const cardId in cards) {
                const card = cards[cardId];
                if ((card.id === qrData.id || card.investorId === qrData.investorId) &&
                    card.cardNumber === qrData.cardNumber) {
                    return card;
                }
            }

            return null;
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';
            
            // Make sure home section is visible and others are hidden
            switchSection('home');

            // Update dashboard with card data
            updateDashboard();
            
            // Load notifications
            loadNotifications();
        }

        // Update dashboard
        function updateDashboard() {
            // Update header with investor name
            document.getElementById('headerUsername').textContent = `مرحباً، ${currentInvestor.name}`;
            
            // Update card display
            document.getElementById('displayCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
            document.getElementById('displayExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
            document.getElementById('cardDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
            document.getElementById('cardCompanyName').textContent = "سما بابل للاستثمار";

            // Update financial info
            document.getElementById('totalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
            document.getElementById('dueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
            document.getElementById('maturityDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
            document.getElementById('investmentStatus').textContent = currentCard.status || "نشط";

            // Update profile section
            updateProfileSection();
            
            // Load transactions
            loadTransactions();
            
            // Load filtered transactions
            loadFilteredTransactions(currentFilter);
        }
        
        // Refresh dashboard data
        async function refreshDashboard() {
            showLoading();
            
            try {
                // Reload card data from Firebase
                if (currentCard && currentCard.id) {
                    const cardRef = database.ref(`${CARDS_PATH}/${currentCard.id}`);
                    const snapshot = await cardRef.once('value');
                    const updatedCard = snapshot.val();
                    
                    if (updatedCard) {
                        currentCard = updatedCard;
                        
                        // Update localStorage
                        localStorage.setItem('investorCard', JSON.stringify(currentCard));
                        
                        // Update UI
                        updateDashboard();
                    }
                }
                
                // Reload notifications
                loadNotifications();
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Update profile section
        function updateProfileSection() {
            // Set profile data
            document.getElementById('profileName').textContent = currentInvestor.name;
            document.getElementById('profileCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
            document.getElementById('profileFullName').textContent = currentInvestor.name;
            document.getElementById('profilePhone').textContent = currentInvestor.phone || '-';
            document.getElementById('profileEmail').textContent = currentInvestor.email || '-';
            document.getElementById('profileJoinDate').textContent = formatDate(currentInvestor.joinDate);
            
            // Set the first letter of the name as avatar text
            const avatarElement = document.getElementById('profileAvatar');
            const firstLetter = currentInvestor.name.charAt(0);
            avatarElement.innerHTML = `<span style="font-size: 2.5rem;">${firstLetter}</span>`;
        }

        // Format card number for display
        function formatCardNumberDisplay(cardNumber) {
            return cardNumber.match(/.{1,4}/g).join(' ');
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-IQ', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + " د.ع";
        }

        // Load transactions
        function loadTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';
            
            // If we have recent operations in the card object
            if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
                // Sort operations by date (newest first)
                const sortedOperations = [...currentCard.recentOperations]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Display the 5 most recent transactions
                const recentOperations = sortedOperations.slice(0, 5);
                
                recentOperations.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            } else {
                // No recent operations found, generate mock data
                const mockTransactions = generateMockTransactions();
                
                // Save mock transactions to card
                currentCard.recentOperations = mockTransactions;
                
                // Display mock transactions
                mockTransactions.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionsList.appendChild(transactionElement);
                });
            }
        }
        
        // Generate mock transactions if none exist
        function generateMockTransactions() {
            const transactions = [];
            const today = new Date();
            
            // Investment transaction
            transactions.push({
                id: generateId(),
                type: 'investment',
                amount: currentCard.totalInvestment || 4000,
                date: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString(), // 180 days ago
                status: 'completed',
                description: 'استثمار أولي'
            });
            
            // Generate multiple profit transactions for the past few months
            for (let i = 6; i > 0; i--) {
                transactions.push({
                    id: generateId(),
                    type: 'profit',
                    amount: 500 + Math.random() * 300,
                    date: new Date(today.getTime() - i * 30 * 24 * 60 * 60 * 1000).toISOString(), // i months ago
                    status: 'completed',
                    description: 'أرباح شهرية'
                });
            }
            
            // Add a withdrawal transaction
            transactions.push({
                id: generateId(),
                type: 'withdrawal',
                amount: 800,
                date: new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString(), // 90 days ago
                status: 'completed',
                description: 'سحب أرباح'
            });
            
            // Sort by date (newest first)
            return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Load filtered transactions
        function loadFilteredTransactions(filter) {
            const transactionsList = document.getElementById('filteredTransactionsList');
            transactionsList.innerHTML = '';
            
            // Activate the selected filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[onclick="filterTransactions('${filter}')"]`).classList.add('active');
            
            // If we have recent operations in the card object
            if (currentCard.recentOperations && currentCard.recentOperations.length > 0) {
                // Sort operations by date (newest first)
                const sortedOperations = [...currentCard.recentOperations]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Filter transactions based on selected filter
                let filteredOperations = sortedOperations;
                if (filter !== 'all') {
                    filteredOperations = sortedOperations.filter(op => op.type === filter);
                }
                
                // Group transactions by date
                const groupedTransactions = groupTransactionsByDate(filteredOperations);
                
                // Display grouped transactions
                Object.keys(groupedTransactions).forEach(date => {
                    // Add date header
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'transaction-date-header';
                    dateHeader.textContent = date;
                    transactionsList.appendChild(dateHeader);
                    
                    // Add transactions for this date
                    groupedTransactions[date].forEach(transaction => {
                        const transactionElement = createTransactionElement(transaction);
                        transactionsList.appendChild(transactionElement);
                    });
                });
                
                // If no transactions found for this filter
                if (filteredOperations.length === 0) {
                    transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات لهذا النوع</p>';
                }
            } else {
                transactionsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد معاملات</p>';
            }
        }
        
        // Group transactions by date
        function groupTransactionsByDate(transactions) {
            const groups = {};
            
            transactions.forEach(transaction => {
                const dateString = formatDate(transaction.date);
                
                if (!groups[dateString]) {
                    groups[dateString] = [];
                }
                
                groups[dateString].push(transaction);
            });
            
            return groups;
        }
        
        // Filter transactions
        function filterTransactions(filter) {
            currentFilter = filter;
            loadFilteredTransactions(filter);
        }

        // Create transaction element
        function createTransactionElement(transaction) {
            const div = document.createElement('div');
            div.className = 'transaction-item';

            const icon = getTransactionIcon(transaction.type);
            const amount = transaction.amount;
            const isPositive = transaction.type === 'profit' || transaction.type === 'investment';
            
            // Extract time from date for display
            const transactionDate = new Date(transaction.date);
            const hours = transactionDate.getHours().toString().padStart(2, '0');
            const minutes = transactionDate.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;

            div.innerHTML = `
                <div class="transaction-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="transaction-info">
                    <div class="transaction-type">${getTransactionTypeName(transaction.type)}</div>
                    <div class="transaction-date">${formatDate(transaction.date)}</div>
                </div>
                <div style="text-align: left; direction: ltr;">
                    <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                        ${isPositive ? '+' : '-'} ${formatCurrency(amount)}
                    </div>
                    <div class="transaction-time">${timeString}</div>
                </div>
            `;

            return div;
        }

        // Get transaction icon
        function getTransactionIcon(type) {
            switch (type) {
                case 'deposit':
                case 'investment':
                    return 'fas fa-arrow-down';
                case 'withdrawal':
                    return 'fas fa-arrow-up';
                case 'profit':
                    return 'fas fa-hand-holding-usd';
                default:
                    return 'fas fa-exchange-alt';
            }
        }

        // Get transaction type name
        function getTransactionTypeName(type) {
            switch (type) {
                case 'deposit':
                    return 'إيداع';
                case 'investment':
                    return 'استثمار';
                case 'withdrawal':
                    return 'سحب';
                case 'profit':
                    return 'أرباح';
                default:
                    return type;
            }
        }
// تحديث دالة تحميل الإشعارات
async function loadNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '';
    
    try {
        // تحميل العمليات من المسار الجديد
        const operationsRef = database.ref(OPERATIONS_PATH);
        const snapshot = await operationsRef.once('value');
        const operationsData = snapshot.val() || [];
        
        // تحويل البيانات إلى مصفوفة
        let operationsArray = [];
        if (Array.isArray(operationsData)) {
            operationsArray = operationsData;
        } else {
            // إذا كانت البيانات في شكل كائن وليس مصفوفة
            for (const key in operationsData) {
                operationsArray.push(operationsData[key]);
            }
        }
        
        // تحويل العمليات إلى إشعارات
        const notificationsArray = operationsArray.map(operation => {
            // إنشاء كائن إشعار من بيانات العملية
            return createNotificationFromOperation(operation);
        });
        
        // ترتيب الإشعارات حسب التاريخ (الأحدث أولاً)
        notificationsArray.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // حفظ في المتغير العام
        notifications = notificationsArray;
        
        // عرض الإشعارات
        if (notifications.length > 0) {
            notifications.forEach(notification => {
                const notificationElement = createNotificationElement(notification);
                notificationsList.appendChild(notificationElement);
            });
        } else {
            notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">لا توجد إشعارات</p>';
        }
    } catch (error) {
        console.error('خطأ في تحميل الإشعارات:', error);
        notificationsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 30px;">حدث خطأ في تحميل الإشعارات</p>';
    }
}


// دالة لتحويل العملية إلى إشعار
function createNotificationFromOperation(operation) {
    // تخصيص عنوان الإشعار ونص الرسالة حسب نوع العملية
    let title = '';
    let message = '';
    let type = operation.type;
    
    switch (operation.type) {
        case 'investment':
            title = 'استثمار جديد';
            message = `تم إضافة استثمار جديد بقيمة ${formatCurrency(operation.amount)}`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
        case 'withdrawal':
            title = 'طلب سحب جديد';
            message = `تم تسجيل طلب سحب بقيمة ${formatCurrency(operation.amount)}`;
            if (operation.status === 'pending') {
                message += `. الطلب قيد المراجعة`;
            } else if (operation.status === 'completed') {
                message += `. تمت الموافقة على الطلب`;
            } else if (operation.status === 'rejected') {
                message += `. تم رفض الطلب`;
            }
            break;
        case 'profit':
            title = 'أرباح جديدة';
            message = `تم إضافة أرباح بقيمة ${formatCurrency(operation.amount)} إلى حسابك`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
        default:
            title = 'عملية جديدة';
            message = `تم تسجيل عملية جديدة بقيمة ${formatCurrency(operation.amount)}`;
            if (operation.notes) {
                message += `. ${operation.notes}`;
            }
            break;
    }
    
    // إنشاء كائن الإشعار
    return {
        id: operation.id || generateId(),
        title: title,
        message: message,
        type: type,
        read: false, // افتراضياً الإشعارات غير مقروءة
        date: operation.date,
        amount: operation.amount,
        status: operation.status,
        operation: operation // تخزين العملية الأصلية للرجوع إليها عند الحاجة
    };
}

// تحديث دالة الحصول على أيقونة الإشعار
function getNotificationIcon(type) {
    switch (type) {
        case 'investment':
            return 'fas fa-chart-line';
        case 'withdrawal':
            return 'fas fa-money-bill-wave';
        case 'profit':
            return 'fas fa-coins';
        case 'welcome':
            return 'fas fa-handshake';
        case 'system':
            return 'fas fa-cogs';
        default:
            return 'fas fa-bell';
    }
}

// إضافة الاستماع للتغييرات في الوقت الفعلي
function listenForOperationsChanges() {
    const operationsRef = database.ref(OPERATIONS_PATH);
    
    // إزالة الاستماعات السابقة إن وجدت
    operationsRef.off();
    
    // إضافة استماع جديد
    operationsRef.on('child_added', (snapshot) => {
        const newOperation = snapshot.val();
        if (newOperation) {
            // إنشاء إشعار جديد من العملية
            const newNotification = createNotificationFromOperation(newOperation);
            
            // إضافة الإشعار إلى المصفوفة العامة
            notifications.unshift(newNotification);
            
            // إعادة تحميل واجهة الإشعارات إذا كانت مفتوحة
            if (document.getElementById('notificationsSection').style.display === 'block') {
                loadNotifications();
            } else {
                // عرض مؤشر على وجود إشعارات جديدة
                showNotificationIndicator();
            }
        }
    });
}

// دالة لعرض مؤشر على وجود إشعارات جديدة
function showNotificationIndicator() {
    const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
    if (notificationNav) {
        // إضافة نقطة حمراء صغيرة لتنبيه المستخدم بوجود إشعارات جديدة
        if (!notificationNav.querySelector('.notification-indicator')) {
            const indicator = document.createElement('div');
            indicator.className = 'notification-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: 5px;
                right: 5px;
                width: 8px;
                height: 8px;
                background-color: var(--red);
                border-radius: 50%;
            `;
            notificationNav.appendChild(indicator);
            notificationNav.style.position = 'relative';
        }
    }
}

// إضافة دالة لتحديث عدد الإشعارات غير المقروءة
function updateUnreadCount() {
    const unreadCount = notifications.filter(notification => !notification.read).length;
    
    const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
    const countBadge = notificationNav.querySelector('.notification-count');
    
    if (unreadCount > 0) {
        if (countBadge) {
            countBadge.textContent = unreadCount;
        } else {
            const badge = document.createElement('div');
            badge.className = 'notification-count';
            badge.textContent = unreadCount;
            badge.style.cssText = `
                position: absolute;
                top: 0;
                right: 0;
                min-width: 16px;
                height: 16px;
                background-color: var(--red);
                border-radius: 8px;
                color: white;
                font-size: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0 4px;
            `;
            notificationNav.appendChild(badge);
            notificationNav.style.position = 'relative';
        }
    } else if (countBadge) {
        countBadge.remove();
    }
}

// تحديث دالة تبديل القسم لإزالة المؤشر عند الانتقال لقسم الإشعارات
const originalSwitchSection = switchSection;
switchSection = function(section) {
    originalSwitchSection(section);
    
    if (section === 'notifications') {
        const notificationNav = document.querySelector('.nav-item[onclick="switchSection(\'notifications\')"]');
        const indicator = notificationNav.querySelector('.notification-indicator');
        if (indicator) {
            indicator.remove();
        }
        
        // تحديث حالة القراءة للإشعارات
        notifications.forEach(notification => {
            notification.read = true;
        });
        
        // تحديث عدد الإشعارات غير المقروءة
        updateUnreadCount();
    }
};

// تحديث دالة إظهار لوحة المعلومات لإضافة الاستماع للتغييرات
const originalShowDashboard = showDashboard;
showDashboard = function() {
    originalShowDashboard();
    
    // إضافة الاستماع للتغييرات في العمليات
    listenForOperationsChanges();
    
    // تحديث عدد الإشعارات غير المقروءة
    updateUnreadCount();
};

// إضافة CSS للإشعارات الجديدة
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
.notification-item {
    position: relative;
    overflow: hidden;
}

.notification-item.new-notification::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--gold) 0%, transparent 50%);
}

.notification-amount {
    font-weight: 700;
    color: var(--gold);
    margin-top: 5px;
}

.notification-status {
    font-size: 0.8rem;
    margin-top: 2px;
}

.notification-status.pending {
    color: var(--gold);
}

.notification-status.completed {
    color: var(--green);
}

.notification-status.rejected {
    color: var(--red);
}
`;
document.head.appendChild(notificationStyle);


        
        // Generate mock notifications
        function generateMockNotifications() {
            const mockNotifications = [];
            const today = new Date();
            
            // Welcome notification
            mockNotifications.push({
                id: generateId(),
                title: 'مرحباً بك في سما بابل للاستثمار',
                message: 'شكراً لانضمامك إلينا. نتمنى لك تجربة استثمارية ناجحة.',
                type: 'welcome',
                read: true,
                date: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString() // 180 days ago
            });
            
            // Profit notification
            mockNotifications.push({
                id: generateId(),
                title: 'تم إضافة أرباح جديدة',
                message: 'تم إضافة أرباح بقيمة 500 د.ع إلى حسابك.',
                type: 'profit',
                read: true,
                date: new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days ago
            });
            
            // System notification
            mockNotifications.push({
                id: generateId(),
                title: 'تحديث النظام',
                message: 'تم تحديث نظام المحفظة الاستثمارية بمميزات جديدة.',
                type: 'system',
                read: false,
                date: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days ago
            });
            
            // Withdrawal notification
            mockNotifications.push({
                id: generateId(),
                title: 'تمت معالجة طلب السحب',
                message: 'تمت الموافقة على طلب سحب الأرباح الخاص بك. سيتم التواصل معك قريباً.',
                type: 'withdrawal',
                read: false,
                date: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString() // 2 days ago
            });
            
            // New investment opportunity
            const opportunityId = Date.now().toString(36) + '5';
            notificationsObj[opportunityId] = {
                title: 'فرصة استثمارية جديدة',
                message: 'لديك فرصة استثمارية جديدة متاحة. تفضل بزيارة مكتبنا للمزيد من التفاصيل.',
                type: 'investment',
                read: false,
                date: new Date().toISOString() // today
            };
            
            return mockNotifications;
        }
        
// تحديث دالة إنشاء عنصر الإشعار
function createNotificationElement(notification) {
    const div = document.createElement('div');
    div.className = `notification-item ${notification.read ? '' : 'unread'} ${Date.now() - new Date(notification.date) < 3600000 ? 'new-notification' : ''}`;
    
    const icon = getNotificationIcon(notification.type);
    
    let statusHTML = '';
    if (notification.status) {
        let statusClass = notification.status;
        let statusText = 'قيد المراجعة';
        
        if (notification.status === 'completed') {
            statusText = 'مكتمل';
        } else if (notification.status === 'rejected') {
            statusText = 'مرفوض';
        } else if (notification.status === 'active') {
            statusText = 'نشط';
        }
        
        statusHTML = `<div class="notification-status ${statusClass}">الحالة: ${statusText}</div>`;
    }
    
    div.innerHTML = `
        <div class="notification-icon">
            <i class="${icon}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            ${notification.amount ? `<div class="notification-amount">${formatCurrency(notification.amount)}</div>` : ''}
            ${statusHTML}
            <div class="notification-date">${formatDate(notification.date)} - ${formatTime(notification.date)}</div>
        </div>
    `;
    
    // إضافة حدث النقر لتحديد حالة القراءة
    if (!notification.read) {
        div.addEventListener('click', () => {
            markNotificationAsRead(notification.id);
            div.classList.remove('unread');
        });
    }
    
    return div;
}



// دالة لتنسيق الوقت
function formatTime(dateString) {
    const date = new Date(dateString);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}
        
        // Get notification icon
        function getNotificationIcon(type) {
            switch (type) {
                case 'welcome':
                    return 'fas fa-handshake';
                case 'profit':
                    return 'fas fa-coins';
                case 'system':
                    return 'fas fa-cogs';
                case 'withdrawal':
                    return 'fas fa-money-check-alt';
                default:
                    return 'fas fa-bell';
            }
        }
        
        // Mark notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                // Update notification in array
                const notificationIndex = notifications.findIndex(n => n.id === notificationId);
                if (notificationIndex !== -1) {
                    notifications[notificationIndex].read = true;
                    
                    // Update in Firebase if connected
                    const notificationRef = database.ref(`${NOTIFICATIONS_PATH}/${notificationId}`);
                    await notificationRef.update({ read: true });
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-IQ');
        }
        
        // Switch bottom navigation section
        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="switchSection('${section}')"]`).classList.add('active');
            
            // Hide all sections
            document.getElementById('homeSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('transactionsSection').style.display = 'none';
            document.getElementById('notificationsSection').style.display = 'none';
            
            // Show the selected section
            if (section === 'home') {
                document.getElementById('homeSection').style.display = 'block';
            } else if (section === 'profile') {
                document.getElementById('profileSection').style.display = 'block';
            } else if (section === 'transactions') {
                document.getElementById('transactionsSection').style.display = 'block';
                // Make sure transactions are loaded with current filter
                loadFilteredTransactions(currentFilter);
            } else if (section === 'notifications') {
                document.getElementById('notificationsSection').style.display = 'block';
                // Make sure notifications are loaded
                loadNotifications();
            }
        }

        // Open withdraw modal
        function openWithdrawModal() {
            document.getElementById('withdrawModal').classList.add('active');
            document.getElementById('availableBalance').value = formatCurrency(currentCard.dueProfit || 0);
            
            // Reset form
            document.getElementById('withdrawForm').reset();
            document.getElementById('withdrawError').style.display = 'none';
            document.getElementById('withdrawSuccess').style.display = 'none';
            document.getElementById('bankDetailsGroup').style.display = 'none';
            document.getElementById('walletDetailsGroup').style.display = 'none';
        }

        // Close withdraw modal
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.remove('active');
        }

        // Submit withdraw request
        async function submitWithdrawRequest(event) {
            event.preventDefault();
            showLoading();

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('withdrawMethod').value;
            const notes = document.getElementById('withdrawNotes').value;
            
            // Get additional details based on method
            let details = '';
            if (method === 'bank_transfer') {
                details = document.getElementById('bankDetails').value;
            } else if (method === 'e_wallet') {
                details = document.getElementById('walletDetails').value;
            }

            try {
                // Validate amount
                if (amount <= 0) {
                    showWithdrawError('يرجى إدخال مبلغ صحيح');
                    return;
                }
                
                if (amount > currentCard.dueProfit) {
                    showWithdrawError('المبلغ المطلوب أكبر من الرصيد المتاح');
                    return;
                }

                // Create withdraw request
                const withdrawRequest = {
                    id: generateId(),
                    investorId: currentInvestor.id,
                    investorName: currentInvestor.name,
                    cardNumber: currentCard.cardNumber,
                    amount: amount,
                    method: method,
                    details: details,
                    notes: notes,
                    status: 'pending',
                    requestDate: new Date().toISOString(),
                    type: 'withdrawal_request'
                };

                // Save to Firebase with correct path
                await database.ref(`${WITHDRAWAL_REQUESTS_PATH}/${withdrawRequest.id}`).set(withdrawRequest);
                
                // Add to transactions
                const withdrawTransaction = {
                    id: generateId(),
                    type: 'withdrawal',
                    amount: amount,
                    date: new Date().toISOString(),
                    status: 'pending',
                    description: 'طلب سحب قيد المراجعة'
                };
                
                // Add to card's recent operations
                if (!currentCard.recentOperations) {
                    currentCard.recentOperations = [];
                }
                
                currentCard.recentOperations.push(withdrawTransaction);
                
                // Add notification for withdrawal request
                const withdrawalNotification = {
                    id: generateId(),
                    title: 'تم استلام طلب السحب',
                    message: `تم استلام طلب سحب بقيمة ${formatCurrency(amount)} وهو قيد المراجعة الآن.`,
                    type: 'withdrawal',
                    read: false,
                    date: new Date().toISOString()
                };
                
                // Save notification to Firebase
                await database.ref(`${NOTIFICATIONS_PATH}/${withdrawalNotification.id}`).set(withdrawalNotification);
                
                // Update localStorage
                localStorage.setItem('investorCard', JSON.stringify(currentCard));
                
                // Update UI
                updateDashboard();

                // Show success message
                showWithdrawSuccess('تم إرسال طلب السحب بنجاح. سيتم مراجعة طلبك قريباً.');
            } catch (error) {
                console.error('Withdraw request error:', error);
                showWithdrawError('حدث خطأ في إرسال الطلب');
            } finally {
                hideLoading();
            }
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Show withdraw error
        function showWithdrawError(message) {
            const errorElement = document.getElementById('withdrawError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }

        // Show withdraw success
        function showWithdrawSuccess(message) {
            const successElement = document.getElementById('withdrawSuccess');
            successElement.textContent = message;
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
                closeWithdrawModal();
            }, 3000);
        }
        
        // Show details
        function showDetails() {
            // Populate the details modal
            document.getElementById('detailsName').textContent = currentInvestor.name;
            document.getElementById('detailsCardNumber').textContent = formatCardNumberDisplay(currentCard.cardNumber);
            document.getElementById('detailsExpiryDate').textContent = formatCardExpiryDateFromDB(currentCard.expiryDate);
            document.getElementById('detailsTotalInvestment').textContent = formatCurrency(currentCard.totalInvestment || 0);
            document.getElementById('detailsTotalProfit').textContent = formatCurrency(currentCard.totalProfit || 0);
            document.getElementById('detailsDueProfit').textContent = formatCurrency(currentCard.dueProfit || 0);
            document.getElementById('detailsPaidProfit').textContent = formatCurrency(currentCard.paidProfit || 0);
            
            // Set investment details
            document.getElementById('detailsInvestmentType').textContent = currentCard.investmentType || 'استثمار عام';
            
            // Set investment date (use 60 days ago if not available)
            const investmentDate = currentCard.investmentDate || 
                new Date(new Date().getTime() - 180 * 24 * 60 * 60 * 1000).toISOString();
            document.getElementById('detailsInvestmentDate').textContent = formatDate(investmentDate);
            
            // Set maturity date (use 300 days from investment date if not available)
            const maturityDate = currentCard.maturityDate || 
                new Date(new Date(investmentDate).getTime() + 300 * 24 * 60 * 60 * 1000).toISOString();
            document.getElementById('detailsMaturityDate').textContent = formatDate(maturityDate);
            
            // Show the modal
            document.getElementById('detailsModal').classList.add('active');
        }
        
        // Close details modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }
        
        // Show contact support modal
        function showContactSupport() {
            // Reset form
            document.getElementById('supportForm').reset();
            document.getElementById('supportError').style.display = 'none';
            document.getElementById('supportSuccess').style.display = 'none';
            
            // Show modal
            document.getElementById('supportModal').classList.add('active');
        }
        
        // Close support modal
        function closeSupportModal() {
            document.getElementById('supportModal').classList.remove('active');
        }
        
        // Submit support request
        async function submitSupportRequest(event) {
            event.preventDefault();
            showLoading();
            
            const topic = document.getElementById('supportTopic').value;
            const message = document.getElementById('supportMessage').value;
            
            try {
                // Validate inputs
                if (!topic || !message) {
                    document.getElementById('supportError').textContent = 'يرجى ملء جميع الحقول';
                    document.getElementById('supportError').style.display = 'block';
                    return;
                }
                
                // Create support request
                const supportRequest = {
                    id: generateId(),
                    investorId: currentInvestor.id,
                    investorName: currentInvestor.name,
                    phone: currentInvestor.phone,
                    email: currentInvestor.email,
                    topic: topic,
                    message: message,
                    status: 'new',
                    date: new Date().toISOString()
                };
                
                // Save to Firebase
                await database.ref(`${SUPPORT_REQUESTS_PATH}/${supportRequest.id}`).set(supportRequest);
                
                // Add notification for support request
                const supportNotification = {
                    id: generateId(),
                    title: 'تم استلام طلب الدعم',
                    message: 'تم استلام رسالتك وسيتم التواصل معك في أقرب وقت ممكن.',
                    type: 'support',
                    read: false,
                    date: new Date().toISOString()
                };
                
                // Save notification to Firebase
                await database.ref(`${NOTIFICATIONS_PATH}/${supportNotification.id}`).set(supportNotification);
                
                // Show success
                document.getElementById('supportSuccess').textContent = 'تم إرسال طلبك بنجاح وسيتم التواصل معك قريباً';
                document.getElementById('supportSuccess').style.display = 'block';
                
                // Clear form
                document.getElementById('supportForm').reset();
                
                // Close modal after delay
                setTimeout(() => {
                    document.getElementById('supportSuccess').style.display = 'none';
                    closeSupportModal();
                }, 3000);
            } catch (error) {
                console.error('Support request error:', error);
                document.getElementById('supportError').textContent = 'حدث خطأ في إرسال الطلب';
                document.getElementById('supportError').style.display = 'block';
            } finally {
                hideLoading();
            }
        }

        // Logout
        function logout() {
            // Clear localStorage
            localStorage.removeItem('investorCard');
            localStorage.removeItem('investorData');
            
            currentInvestor = null;
            currentCard = null;
            
            // Reset forms
            document.getElementById('loginForm').reset();
            
            // Hide dashboard, show login
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            
            // Clear any QR scanner
            if (qrScanner) {
                qrScanner.clear();
                qrScanner = null;
            }
            
            // Reset QR scanner UI
            document.getElementById('qr-scanner').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
        }

        // Show loading
        function showLoading() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // Show error
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }

        // Clear errors
        function clearErrors() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
      // Continuación del código JavaScript para la aplicación de cartera de inversión

// Mock data for Firebase compatibility
if (typeof firebase !== 'object' || !firebase.database) {
    console.warn('Firebase not available, using mock data');
    
    // Mock database functions
    database.ref = function(path) {
        return {
            once: function(event) {
                return Promise.resolve({
                    val: function() {
                        if (path.includes('investorCards')) {
                            return {
                                "card1": {
                                    id: "card1",
                                    cardNumber: "2750238015845063",
                                    cvv: "123",
                                    expiryDate: "2027-05-31",
                                    investorId: "inv1",
                                    investorName: "سما بابل للإستثمار",
                                    investorPhone: "07701234567",
                                    investorEmail: "info@samababel.com",
                                    totalInvestment: 4000.00,
                                    totalProfit: 51036.03,
                                    dueProfit: 1458.333,
                                    paidProfit: 49577.70,
                                    investmentType: "استثمار عقاري",
                                    investmentDate: "2024-01-15T00:00:00.000Z",
                                    maturityDate: "2027-05-31T00:00:00.000Z",
                                    joinDate: "2023-12-01T00:00:00.000Z",
                                    status: "نشط"
                                }
                            };
                        } else if (path.includes('notifications')) {
                            // Mock notifications data
                            return generateMockNotificationsDatabase();
                        }
                        return null;
                    }
                });
            },
            set: function(data) {
                console.log('Mock database set:', path, data);
                return Promise.resolve();
            },
            update: function(data) {
                console.log('Mock database update:', path, data);
                return Promise.resolve();
            }
        };
    };
}

// Generate mock notifications database
function generateMockNotificationsDatabase() {
    const today = new Date();
    const notificationsObj = {};
    
    // Welcome notification
    const welcomeId = Date.now().toString(36) + '1';
    notificationsObj[welcomeId] = {
        title: 'مرحباً بك في سما بابل للاستثمار',
        message: 'شكراً لانضمامك إلينا. نتمنى لك تجربة استثمارية ناجحة.',
        type: 'welcome',
        read: true,
        date: new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString() // 180 days ago
    };
    
    // Profit notification
    const profitId = Date.now().toString(36) + '2';
    notificationsObj[profitId] = {
        title: 'تم إضافة أرباح جديدة',
        message: 'تم إضافة أرباح بقيمة 500 د.ع إلى حسابك.',
        type: 'profit',
        read: true,
        date: new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days ago
    };
    
    // System notification
    const systemId = Date.now().toString(36) + '3';
    notificationsObj[systemId] = {
        title: 'تحديث النظام',
        message: 'تم تحديث نظام المحفظة الاستثمارية بمميزات جديدة.',
        type: 'system',
        read: false,
        date: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days ago
    };
    
    // Withdrawal notification
    const withdrawalId = Date.now().toString(36) + '4';
    notificationsObj[withdrawalId] = {
        title: 'تمت معالجة طلب السحب',
        message: 'تمت الموافقة على طلب سحب الأرباح الخاص بك. سيتم التواصل معك قريباً.',
        type: 'withdrawal',
        read: false,
        date: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString() // 2 days ago
    };
    
    return notificationsObj;
}

// Additional functions for enhanced functionality

// Function to change app theme (light/dark)
function toggleTheme() {
    const root = document.documentElement;
    const currentTheme = root.getAttribute('data-theme') || 'dark';
    
    if (currentTheme === 'dark') {
        root.setAttribute('data-theme', 'light');
        localStorage.setItem('appTheme', 'light');
    } else {
        root.setAttribute('data-theme', 'dark');
        localStorage.setItem('appTheme', 'dark');
    }
}

// Load saved theme from localStorage
function loadSavedTheme() {
    const savedTheme = localStorage.getItem('appTheme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
}

// Function to change app language
function changeLanguage(lang) {
    // This would typically load language strings from a JSON file
    // and update all UI elements accordingly
    console.log(`Language changed to: ${lang}`);
    localStorage.setItem('appLanguage', lang);
    // Would require a page reload or dynamic text replacement
}

// Function to export transaction history
function exportTransactionHistory() {
    if (!currentCard || !currentCard.recentOperations) {
        showError('لا توجد معاملات للتصدير');
        return;
    }
    
    try {
        // Get all transactions
        const transactions = [...currentCard.recentOperations]
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Format for CSV
        let csvContent = "نوع المعاملة,المبلغ,التاريخ,الحالة,الوصف\n";
        
        transactions.forEach(transaction => {
            const type = getTransactionTypeName(transaction.type);
            const amount = transaction.amount;
            const date = formatDate(transaction.date);
            const status = transaction.status === 'completed' ? 'مكتمل' : 'قيد المعالجة';
            const description = transaction.description || '';
            
            csvContent += `${type},${amount},${date},${status},${description}\n`;
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `transactions_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error exporting transactions:', error);
        showError('حدث خطأ في تصدير المعاملات');
    }
}

// Function to show investment chart in modal
function showInvestmentChart() {
    // This would typically use Chart.js or a similar library
    // to create a visual representation of investment performance
    console.log('Showing investment chart');
    // For now, just show a placeholder message
    alert('سيتم عرض مخطط الاستثمار قريبًا');
}

// Function to handle forgot card details
function forgotCardDetails() {
    // This would typically show a form to recover account
    alert('يرجى التواصل مع خدمة العملاء لاسترداد تفاصيل البطاقة');
}

// Function to verify user identity (two-factor authentication)
function sendVerificationCode() {
    // This would typically send an SMS or email with a code
    console.log('Sending verification code');
    alert('تم إرسال رمز التحقق إلى رقم هاتفك');
}

// Function to verify the code entered by user
function verifyCode(code) {
    // This would typically validate the code against a backend
    console.log(`Verifying code: ${code}`);
    return code === '1234'; // Mock verification
}

// Function to update user profile
function updateUserProfile(newData) {
    // This would typically update the user profile in the database
    console.log('Updating user profile:', newData);
    
    // Update current investor data
    Object.assign(currentInvestor, newData);
    
    // Update localStorage
    localStorage.setItem('investorData', JSON.stringify(currentInvestor));
    
    // Update UI
    updateProfileSection();
    
    return true; // Mock successful update
}

// Function to register new biometric login
function registerBiometric() {
    // This would typically use the Web Authentication API
    // to register a new biometric credential
    console.log('Registering biometric login');
    
    if (!window.PublicKeyCredential) {
        alert('متصفحك لا يدعم تسجيل الدخول البيومتري');
        return false;
    }
    
    // Mock success for now
    alert('تم تسجيل بصمة الإصبع بنجاح');
    return true;
}

// Function to handle push notification registration
function registerForPushNotifications() {
    // This would typically use the Push API to register for notifications
    console.log('Registering for push notifications');
    
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('متصفحك لا يدعم الإشعارات');
        return false;
    }
    
    // Mock success for now
    alert('تم تسجيل الإشعارات بنجاح');
    return true;
}

// Function to calculate investment projections
function calculateProjections(amount, duration, rate) {
    // Simple compound interest calculation
    const years = duration / 12;
    const interest = amount * Math.pow((1 + rate/100), years) - amount;
    return {
        finalAmount: amount + interest,
        totalInterest: interest
    };
}

// Function to show QR code for sharing investment details
function showShareQR() {
    // This would typically generate a QR code with investment info
    console.log('Showing QR code for sharing');
    alert('سيتم عرض رمز QR للمشاركة قريبًا');
}

// Function to handle bank account linking
function linkBankAccount(bankInfo) {
    // This would typically connect to a banking API
    console.log('Linking bank account:', bankInfo);
    
    // Mock success for now
    return {
        success: true,
        message: 'تم ربط الحساب البنكي بنجاح'
    };
}

// Function to handle document upload for KYC
function uploadKYCDocument(documentType, file) {
    // This would typically upload the document to a secure storage
    console.log(`Uploading ${documentType} document`);
    
    // Mock upload process
    setTimeout(() => {
        alert(`تم رفع مستند ${documentType} بنجاح`);
    }, 2000);
    
    return true;
}

// Enhanced currency formatter with support for different currencies
function formatCurrencyAdvanced(amount, currency = 'IQD') {
    const currencySymbols = {
        'IQD': 'د.ع',
        'USD': '$',
        'EUR': '€',
        'GBP': '£'
    };
    
    const symbol = currencySymbols[currency] || currency;
    
    const formatted = new Intl.NumberFormat('ar-IQ', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
    
    return `${formatted} ${symbol}`;
}

// Function to handle investment calculator
function calculateInvestmentReturns(principal, period, rate) {
    const monthlyRate = rate / 12 / 100;
    let futureValue = principal;
    
    for (let i = 0; i < period; i++) {
        futureValue += futureValue * monthlyRate;
    }
    
    return {
        principal: principal,
        returns: futureValue - principal,
        total: futureValue,
        annualRate: rate,
        periodMonths: period
    };
}

// Function to initialize push notifications
function initializePushNotifications() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registered with scope:', registration.scope);
                // Request notification permission
                return Notification.requestPermission();
            })
            .then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    // Subscribe to push notifications
                    // This would typically involve getting a push subscription
                    // and sending it to your server
                }
            })
            .catch(error => {
                console.error('Service Worker registration failed:', error);
            });
    }
}


// Add these functions to window to make them globally available
window.toggleTheme = toggleTheme;
window.changeLanguage = changeLanguage;
window.exportTransactionHistory = exportTransactionHistory;
window.showInvestmentChart = showInvestmentChart;
window.forgotCardDetails = forgotCardDetails;
window.registerBiometric = registerBiometric;
window.calculateProjections = calculateProjections;
window.showShareQR = showShareQR;

// Initialize additional features on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedTheme();
    
    // Add theme toggle button to profile section if needed
    const profileSection = document.getElementById('profileSection');
    if (profileSection) {
        const themeToggleBtn = document.createElement('button');
        themeToggleBtn.className = 'btn';
        themeToggleBtn.style.marginTop = '10px';
        themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i> تبديل المظهر (فاتح/داكن)';
        themeToggleBtn.onclick = toggleTheme;
        
        // Insert before logout button
        const logoutBtn = profileSection.querySelector('.logout-btn');
        if (logoutBtn) {
            profileSection.insertBefore(themeToggleBtn, logoutBtn);
        } else {
            profileSection.appendChild(themeToggleBtn);
        }
    }
    
    // Check for updates on page load
    setTimeout(checkForUpdates, 5000);
    
    // Initialize push notifications if supported
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        // Only initialize if user is logged in
        if (localStorage.getItem('investorCard')) {
            initializePushNotifications();
        }
    }
});





</script>
</body>
</html>
